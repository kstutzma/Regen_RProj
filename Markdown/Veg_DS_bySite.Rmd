---
title: "Veg descriptive statistics by site & treatment type"
author: "Kathleen Stutzman"
date: "2024-02-20"
output: html_document
---

This script creates an average for each site and then calculates species richness, species diversity (Shannon Index), species numbers, evenness, and beta diversity for veg data. 


Libraries:
```{r Libraries, message=FALSE, warning=FALSE}
# libraries -------------------
library(vegan)
library(tidyverse)
library(plyr)
library(dplyr)
library(adespatial)
```

Set working directory
```{r, setup}
knitr::opts_knit$set(root.dir = '/Users/user/Desktop/Data/Regen_RProj/')
```

Source functions:
```{r}
# source functions -------------------
source("Functions/species_richness.R")
source("Functions/shannon_index.R")
source("Functions/spec_num.R")
source("Functions/Pielous_J.R")
source("Functions/asnum_keepname.R")
```

Source veg data:
```{r}
#start by sourcing the veg script
source("Scripts/Veg_Data.R")

rm(veg3)#this is used for total cover in GLMMs; not used in this script and doesn't import correctly due to use of dplyr package
```

Split overall data from veg cover; pivot wider to fill in missing 0s; create df of site and plot to reattach later
```{r}
#split overall data from veg cover
veg_meta <- veg2 %>% 
  select(Region, Treat_Type, Site, Plot_No) %>% 
  distinct(Plot_No, .keep_all = TRUE)

#pivot veg data wider and fill in zeros
veg_wider <- veg2 %>% 
  select(Plot_No, Species_Code, SP_Cover_midpoint) %>% 
  group_by(Plot_No) %>% 
  pivot_wider(names_from = Species_Code, values_from = SP_Cover_midpoint, values_fill = 0) 

#create dataframe of site and plot
veg_site <- veg2 %>% 
  select(Site, Plot_No) %>% 
  group_by(Site) %>% 
  distinct(Plot_No, .keep_all = TRUE)

#reattach site info and reorder
veg_merge1 <- merge(veg_site, veg_wider, by = "Plot_No") %>% 
   select(Site, Plot_No, everything())

rm(veg_wider)
```

Create df without plot numbers; then split df by site
```{r}
#remove plot number
veg_merge3 <- veg_merge1 %>% 
  select(-Plot_No)

#split df by site
split_veg <- split(veg_merge3[-1], veg_merge3$Site)
```

##### Species Richness
```{r}
# Species Richness (jackknife and chao etc estimates) -------------------
sp <- as.data.frame(sapply(split_veg, species_richness))

#transpose
spcrich_bysite <- as.data.frame(t(sp))

rm(sp)
```

##### Diversity (Shannon-Wiener Index)
```{r}
# Shannon index -------------------
si <- as.data.frame(sapply(split_veg, shannon_index))

#transpose
si_bysite <- as.data.frame(t(si))

#name columns
colnames(si_bysite) <- c("S.I._Mean", "S.I._SD")

rm(si)
```

##### Species Number
```{r}
# Number of species -------------------
spc_n <- as.data.frame(sapply(split_veg, spec_num))

#transpose
spcnum_bysite <- as.data.frame(t(spc_n))

#name columns
colnames(spcnum_bysite) <- c("Spc.Num_Mean", "Spc.Num_SD")

rm(spc_n)
```

##### Evenness (Pielou's J)
This is the SW Index / log (species number). For three sites (one each in APB_Hippo, RPD2_B2, & RPD2_B7), they have a species number of 1. The log of 1 is 0 and anything divided by 0 is NaN. Therefore, these three subplots are dropped from the calculations

```{r}
even1 <- as.data.frame(sapply(split_veg, Pielous_J))

even2 <- as.data.frame(t(even1))

colnames(even2) <- c("Pielous_J_mean", "Pielous_J_SD")

rm(even1)
```

Hidden below is code to look at the three subplots, if desired
```{r, include=FALSE, eval=FALSE}
RPD2_B7
HIPPO <-  veg_merge3 %>% 
  filter(Site == "RPD2_B7") %>% 
  select(-Site)

H <- diversity(HIPPO)
S <- specnumber(HIPPO)
J <- H/(log(S))

print(J)

rm(H, S, J, HIPPO)
#just switch out site name
```

### Sorensen dissimilarity index
```{r}
# creating a dataframe where observations from every subplot within a site are added together to use for P/A calculations in sorensen
veg4soren <- veg_merge3 %>% 
  group_by(Site) %>% 
  summarise_at(vars(QUCO:HECA), sum) %>% 
  column_to_rownames(var = "Site")

# creating df of row id and site id to reattach to beta diversity metrics later
site_rowid <- veg_merge3 %>% 
  group_by(Site) %>% 
  summarise_at(vars(QUCO:HECA), sum) %>% 
  rowid_to_column(var="rowid") %>% 
  select(Site, rowid)
```

Calculate beta diversity
```{r}
BDiv <- beta.div.comp(veg4soren, coef = "S", quant = FALSE)
#overall values
BetaD.df <- as.data.frame(BDiv$part)
#distance matrix for all sites
BetaD.distances <- as.matrix(BDiv$D)
#replacement values matrix for all sites
BetaD.repl.matrix <- as.matrix(BDiv$repl)
#richness values matrix for all sites
BetaD.rich.matrix <- as.matrix(BDiv$rich)
```

#### Overall beta diversity metrics
```{r}
print(BetaD.df)
```

#### Distance matrix for all sites
```{r}
#print(BetaD.distances)
```



Local contributions to beta diversity; partitioned into richness and replacement
```{r}
# replacement
replacement <- LCBD.comp(BDiv$repl, sqrt.D = TRUE)

rep.df <- as.data.frame(replacement$LCBD)

names(rep.df)[names(rep.df) == "replacement$LCBD"] <- "replace.lcbd"

rep.df <-  rep.df %>% 
  rowid_to_column(var="rowid")

rep.df2 <- merge(rep.df, site_rowid, by = "rowid") %>%
  select(Site, replace.lcbd) %>% 
  column_to_rownames(var = "Site")


#richness
richness <- LCBD.comp(BDiv$rich, sqrt.D = TRUE)

rich.df <- as.data.frame(richness$LCBD)

names(rich.df)[names(rich.df) == "richness$LCBD"] <- "richness.lcbd"

rich.df <- rich.df %>% 
  rowid_to_column(var = "rowid")

rich.df2 <- merge(rich.df, site_rowid, by = "rowid") %>% 
  select(Site, richness.lcbd) %>% 
  column_to_rownames(var = "Site")

rm(rep.df, rich.df)
```

### Merge DS together
```{r}
# merging data sets of DS
m1 <- merge(spcrich_bysite, si_bysite, by="row.names") %>% 
  column_to_rownames(var = "Row.names")


m2 <- merge(m1, spcnum_bysite, by="row.names") %>% 
  column_to_rownames(var = "Row.names")

m3 <- merge(m2, even2, by = "row.names") %>% 
  column_to_rownames(var = "Row.names")


m4 <- merge(m3, rich.df2, by = "row.names") %>% 
  column_to_rownames(var = "Row.names")

veg_sd <- merge(m4, rep.df2, by = "row.names") %>% 
  column_to_rownames(var = "Row.names")


rm(m1, 
   m2, 
   m3, 
   m4)
```


```{r}
print(veg_sd)
```


# Averages by treatment type:
Using information calculated by site to create an average value for each treatment type
```{r}
#species richness data is numbers but not numeric, so convert to numeric so I can find the mean
veg_sd2 <- as.data.frame(asnum_keepname(veg_sd))

#checking
is.numeric(veg_sd2$chao)

#pull out site and treatment type data, so it can be connected with DS data
trt_meta <- veg_meta %>% 
  select(Site, Treat_Type) %>% 
  distinct(Site, .keep_all = T) %>% 
  column_to_rownames(var = "Site")

#merge and make df ready to split
veg_trt <- merge(veg_sd2, trt_meta, by = "row.names")  %>% 
  select(Treat_Type, everything()) %>%
  select(-Row.names)

#split dataframe by treat type
treat_split <- split(veg_trt[-1], veg_trt$Treat_Type)


#find means for each category by treatment type
z <- as.data.frame(sapply(treat_split, colwise(mean)))

#transpose
DS_byTT <- as.data.frame(t(z))

#the applys? turn the data to not numeric? not sure exactly. This converts the dataframe to numeric
DS_byTT2 <- as.data.frame(asnum_keepname(DS_byTT))
```

#### Print Treatment Type DS
```{r}
print(DS_byTT2)


library(writexl)

write_xlsx(DS_byTT2, "DataObjects/dsbyTT.xlsx")

```


Would it be different to do by tt to begin with?
```{r}
#pivot veg data wider and fill in zeros
veg_wider <- veg2 %>% 
  select(Plot_No, Species_Code, SP_Cover_midpoint) %>% 
  group_by(Plot_No) %>% 
  pivot_wider(names_from = Species_Code, values_from = SP_Cover_midpoint, values_fill = 0) 

#create dataframe of site and plot
veg_site2 <- veg2 %>% 
  select(Treat_Type, Plot_No) %>% 
  group_by(Treat_Type) %>% 
  distinct(Plot_No, .keep_all = TRUE)

#reattach site info and reorder
veg_merge2 <- merge(veg_site2, veg_wider, by = "Plot_No") %>% 
  select(-Plot_No) %>% 
  select(Treat_Type, everything())

#split df by TT
split_TT <- split(veg_merge2[-1], veg_merge2$Treat_Type)


```


```{r}
control_ds <- veg_merge2 %>% 
  filter(Treat_Type == "Control") %>% 
  select(-1)

fall_ds <- veg_merge2 %>% 
  filter(Treat_Type == "FallRx") %>% 
  select(-1)

spr_ds <- veg_merge2 %>% 
  filter(Treat_Type == "SpringRx") %>% 
  select(-1)

mow_ds <- veg_merge2 %>% 
  filter(Treat_Type == "MowRx") %>% 
  select(-1)

har_ds <- veg_merge2 %>% 
  filter(Treat_Type == "Harvest") %>% 
  select(-1)
```

Information for comparison of species richness means across plots/treatment types
```{r}
rm(sprc_df)

sprc_df <- veg_merge2 %>% 
  mutate_if(is.numeric, ~1 * (. > 0))

sprc_df$Total<- rowSums(sprc_df[2:166])

sprc_df <- sprc_df %>% 
  select(Total, everything())

hist(sprc_df$Total) # bit of a tail to the right

ggplot(data = sprc_df, aes(x = Total, color = Treat_Type))+
  geom_boxplot()

# Looking at ANOVA & assumptions
shapiro.test(sprc_df$Total[sprc_df$Treat_Type == "Control"]) 
shapiro.test(sprc_df$Total[sprc_df$Treat_Type == "FallRx"])
shapiro.test(sprc_df$Total[sprc_df$Treat_Type == "SpringRx"])
shapiro.test(sprc_df$Total[sprc_df$Treat_Type == "Harvest"])
shapiro.test(sprc_df$Total[sprc_df$Treat_Type == "MowRx"])
# none pass - will have to check residuals?

car::leveneTest(Total~Treat_Type, data = sprc_df)
#also doesn't pass

x <- aov(Total ~ Treat_Type, data = sprc_df)

summary(x)

TukeyHSD(x)
```

### Using non-parametric methods
```{r}
library(dunn.test)
kruskal.test(Total~Treat_Type, data = sprc_df)

dunn.test(x = sprc_df$Total, g = sprc_df$Treat_Type, method = "bonferroni")
```

MowRx & Control signifcantly different
MowRx & FallRx signifcantly different
MowRx & Harvest signifcantly different
SpringRx & Harvest signifcantly different

##### Species Richness
```{r}
# Species Richness (jackknife and chao etc estimates) -------------------
sp1 <- as.data.frame(sapply(split_TT, species_richness))

#transpose
spcrich_byTT <- as.data.frame(t(sp1))

rm(sp1)
```






##### Diversity (Shannon-Wiener Index)
```{r}
# Shannon index -------------------
si1 <- as.data.frame(sapply(split_TT, shannon_index))

#transpose
si_byTT <- as.data.frame(t(si1))

#name columns
colnames(si_byTT) <- c("S.I._Mean", "S.I._SD")

rm(si1)
```

##### Species Number
```{r}
# Number of species -------------------
spc_n1 <- as.data.frame(sapply(split_TT, spec_num))

#transpose
spcnum_byTT <- as.data.frame(t(spc_n1))

#name columns
colnames(spcnum_byTT) <- c("Spc.Num_Mean", "Spc.Num_SD")

rm(spc_n1)


# #at a later date fix and take a look at aov for this
# spTT2 <- tibble::rownames_to_column(spcnum_byTT, "rn") 
# 
# spnum_avo <- aov(Spc.Num_Mean ~ rn, data = spTT2)
# print(spnum_avo)
# 
# mat1 <- matrix(nrow = 5, ncol = 136)
# 
# mat1[1,] <- specnumber(split_TT$Control)
# z1 <- specnumber(split_TT$Harvest)
# z2 <- specnumber(split_TT$SpringRx)
# z3 <- specnumber(split_TT$FallRx)
# z4 <- specnumber(split_TT$MowRx)
# 
# x <- bind_rows(z, z1)
# x1 <- bind_rows(x, z2)
# x2 <- bind_rows(x1, z3)
# speTT <- bind_rows(x2, z4)
```

##### Evenness (Pielou's J)
This is the SW Index / log (species number). For three sites (one each in APB_Hippo, RPD2_B2, & RPD2_B7), they have a species number of 1. The log of 1 is 0 and anything divided by 0 is NaN. Therefore, these three subplots are dropped from the calculations

```{r}
even1a <- as.data.frame(sapply(split_TT, Pielous_J))

even2a <- as.data.frame(t(even1a))

colnames(even2a) <- c("Pielous_J_mean", "Pielous_J_SD")

rm(even1a)
```

Hidden below is code to look at the three subplots, if desired
```{r, include=FALSE, eval=FALSE}
RPD2_B7
HIPPO <-  veg_merge3 %>% 
  filter(Site == "RPD2_B7") %>% 
  select(-Site)

H <- diversity(HIPPO)
S <- specnumber(HIPPO)
J <- H/(log(S))

print(J)

rm(H, S, J, HIPPO)
#just switch out site name
```

### Sorensen dissimilarity index
```{r}
# creating a dataframe where observations from every subplot within a site are added together to use for P/A calculations in sorensen
veg4soren2 <- veg_merge2 %>% 
  group_by(Treat_Type) %>% 
  summarise_at(vars(QUCO:HECA), sum) %>% 
  column_to_rownames(var = "Treat_Type")

# creating df of row id and site id to reattach to beta diversity metrics later
site_rowid2 <- veg_merge2 %>% 
  group_by(Treat_Type) %>% 
  summarise_at(vars(QUCO:HECA), sum) %>% 
  rowid_to_column(var="rowid") %>% 
  select(Treat_Type, rowid)
```


### Merge DS together
```{r}
# merging data sets of DS
m1a <- merge(spcrich_byTT, si_byTT, by="row.names") %>% 
  column_to_rownames(var = "Row.names")


m2a <- merge(m1a, spcnum_byTT, by="row.names") %>% 
  column_to_rownames(var = "Row.names")

m3a <- merge(m2a, even2a, by = "row.names") %>% 
  column_to_rownames(var = "Row.names")

try2 <- m3a

# m4a <- merge(m3a, rich.df2, by = "row.names") %>% 
#   column_to_rownames(var = "Row.names")
# 
# veg_sd <- merge(m4, rep.df2, by = "row.names") %>% 
#   column_to_rownames(var = "Row.names")


rm(m1a, 
   m2a) 
   # m3, 
   # m4)

write_csv(try2, "DataObjects/DSbyTreatType.csv")
```


















```{r, include=FALSE, eval=FALSE}
# hidden code that i ended up not using due to vegan and partitioning, but don't want to lose -------------------
############################### lots of useless(?) code - replaced by understanding partioning

#starting by converting data set to presence/absence

#need to fix names
#veg_merge2 <- veg_merge2 %>% 
  select(-Site)

vm_rn <- data.frame(veg_merge2[,-1], row.names=veg_merge2[,1])

vm_rn[vm_rn > 0] <- 1

vm_rn <- rownames_to_column(vm_rn, var = "Plot_No")

veg_pa <- merge(veg_site, vm_rn, by = "Plot_No")
#holy shit. i did that

spc_sumbysite <- veg_pa %>% 
  group_by(Site) %>% 
  summarise_at(vars(QUCO:HECA), sum)

#RICHNESS
richness <- ddply(spc_sumbysite, ~Site, function(x) {
  data.frame(Richness=sum(x[-1]>0))
}) # we got it. AMEN baby. this was terrible.

#ABUNDANCE - not sure how useful as this is % cover and not individuals counted, but ok
abun1 <- veg_merge1 %>%
  group_by(Site) %>% 
  summarise_at(vars(QUCO:HECA), mean)

abundance <- ddply(abun1, ~Site, function(x) {
  data.frame(Abundance = sum(x[-1]))
})

#################################################





```
































