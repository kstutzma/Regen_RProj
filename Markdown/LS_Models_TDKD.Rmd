---
title: "Large seedling models for Tony & Kevin"
author: "Kathleen Stutzman"
date: "2024-01-25"
output: html_document
---

Hidden below is code for importing the data set and log transforming variables. The best model (lowest AIC & using lrtest) is presented below, model fit checked, and pairwise comparison for Treatment Type.  

I did create and test models without treatment type, but they always have higher AIC and worse model fit that those with (probably due to the control category...)  

##### Variables investigated:
- **Treat_Type** - treatment type
- **PIRI** - pitch pine seedling count (10m^2^)
- **SO** - shrub oak seedling count (10m^2^)
- **other** - other seedling count (10m^2^)
- **BA_HA** - basal area per hectare
- **BA_piri** - pitch pine basal area per hectare
- **Mineral** - exposed mineral soil (1m^2^)
- **avgLD** - average leaf litter depth (1m^2^)
- **Veg_Total** - total understory plant cover (1m^2^)
- **TFT** - time between treatment and sampling (used as an offset)
- **Site/Plot_No** - random effect of plots within sites

*Variables are log transformed (l. or _l)*

## Pitch Pine Regeneration

```{r Libraries, message=FALSE, warning=FALSE, include=FALSE}
# libraries -------------------
library(dplyr)
library(tidyverse)
library(ggplot2)
library(GGally)
library(glmmTMB)
library(TMB)
library(emmeans)
library(DHARMa)
library(lmtest)
library(ggeffects)
```

```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = '/Users/user/Desktop/Data/Regen_RProj/')
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
source("Scripts/LS_Import.R")

ls_merge2 <- ls_merge %>% 
  select(Plot_No, Region, Treat_Type, Site, Species_Groups, Total) #this is dropping browse and stump sprout data

ls_merge2 <- ls_merge2 %>% 
  pivot_wider(names_from = Species_Groups, values_from = Total)

time_since <- read_csv("CleanData/Treat_Year_Data.csv")

ls_merge3 <- merge(ls_merge2, time_since, by = 'Site')
#log transform time from treatment data
ls_merge3$l.TFT <- log(ls_merge3$Time_from_Treat)

source("Scripts/Add_BA.R")

# merge with ls dataset -------------------
ls_merge4 <- merge(ls_merge3, prism_BA, by = "Plot_No")

source("Scripts/Ground_Data.R")

# merge with ls dataset -------------------
ls_merge5 <- merge(ls_merge4, ground3, by = "Plot_No")

source("Scripts/Veg_Data.R")

# merge with ls dataset 
ls.all <- merge(ls_merge5, veg3, by = "Plot_No")

rm(ls_merge5,
   ls_merge2,
   ls_merge3,
   ls_merge4)

ls.all3 <- ls.all

ls.all3$l.PIRI <- log(ls.all3$PIRI + 1)
ls.all3$l.SO <- log(ls.all3$Shrub_Oak + 1)
ls.all3$l.other <- log(ls.all3$Other + 1)

ls.all3 <- ls.all3 %>% 
  select(Treat_Type, Region, Site, Plot_No, PIRI, l.PIRI, Shrub_Oak, l.SO, Other, l.other, Time_from_Treat, l.TFT, BA_HA, l.BA_HA, PIRI.BA_HA, l.BA_piri, Mineral_Soil, l.Mineral, Litter_Duff, avgLD, avgLD_l, Veg_Total, l.Veg_Total) %>% 
  arrange(Treat_Type)
```

### testing zero inflation
```{r}
tapply(ls.all3$PIRI, ls.all3$Region, summary)
# no PIRI in ME
tapply(ls.all3$PIRI, ls.all3$Treat_Type, summary)
```


### Best large seedling pitch pine model
```{r}
ls.m19 <- glmmTMB(PIRI ~ Treat_Type + avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = nbinom1)
summary(ls.m19)
```

### Check model fit
```{r}
ls.m19_sr <- simulateResiduals(ls.m19, n = 1000, plot = TRUE) #passes
testResiduals(ls.m19_sr) #passes
testZeroInflation(ls.m19_sr) #passes
```
Had quantile issues, resolved by using nbinom instead of poisson; zero inflation by region doesn't improve the model - still works/passes tests but higher AIC


### Pairwise with treatment type
##### These are really rates due to the offset for time
```{r}
emmeans(ls.m19, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
```
##### Only harvest is significantly different than contol


### Graph pitch pine models
```{r, fig.align='center', echo=FALSE}
# PIRI LS -------------------
ls.p1 <- ggpredict(ls.m19, terms = c("avgLD_l", "Treat_Type"))


ggplot(ls.p1, aes(x, predicted, color = group))+
  geom_line(linewidth = 1.25, show.legend = FALSE) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  theme(axis.text = element_text(size = 16), axis.title = element_text(size = 20))+
  labs(x = "Average leaf litter depth \n (log transformed)",
       y = "Pitch pine stems \n (adjusted for time)")

ggsave(filename = "LS_PIRI_avgld.tiff", path = "Plots/PIRI_GLMM", width = 7, height = 5, device = "tiff", dpi = 700)
```



## Shrub Oak Regeneration
This includes QUIL (scrub oak) & QUPR (dwarf chinkapin oak)

### Large seedling shrub oak model
  - Poisson, nbinom, genpois, & compois models all fail due to underdispersion. Some have issues with zero inflation as well. Gaussian dispersion also fails due to issues with uniformity. 

```{r}
tapply(ls.all3$Shrub_Oak, ls.all3$Region, summary)
tapply(ls.all3$Shrub_Oak, ls.all3$Treat_Type, summary)
```



### These are my best models, all are underdispersed

```{r}
m6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
              ziformula = ~Region,
                 family = nbinom1)
AIC(m6) #3310

m6_sr <- simulateResiduals(m6, n=1000, plot = TRUE)
testResiduals(m6_sr) #fails dispersion
```


```{r}
m7 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
              ziformula = ~1,
                 family = nbinom1)
AIC(m7) #3251.4

m7_sr <- simulateResiduals(m7, n = 1000, plot = T)
testResiduals(m7_sr)
```


# this is the least dispersion issue I've gotten.
I literally can't help myself from continuing to figure out this model.
```{r, include=F, eval=FALSE}
so.ls1 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~Treat_Type,
                 family = nbinom1)
AIC(so.ls1) #3254

so1_sr <- simulateResiduals(so.ls1, n = 1000, plot = T)
testResiduals(so1_sr)


som2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1 + Treat_Type,
                 family = nbinom1)
AIC(som2) #3256

lrtest(so.ls1, som2) #0.07

som2_sr <- simulateResiduals(som2, n = 1000, plot = T)
testResiduals(som2_sr)

som3 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~Treat_Type,
                 family = nbinom1)
AIC(som3) #3260

lrtest(som2, som3)

som4 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other  + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~Treat_Type,
                 family = nbinom1)
AIC(som4) #3257

lrtest(som4, som2) #0.08


som5 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other  + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~Treat_Type,
                 family = nbinom1)
AIC(som5) #3259

lrtest(som4, som5)

som6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other  + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~Treat_Type,
                 family = nbinom1)
AIC(som6) #3254.9

lrtest(som6, som4)


som7 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.Mineral  + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~Treat_Type,
                 family = nbinom1)
AIC(som7) #3259.5

lrtest(som6, som7)

som6_sr <- simulateResiduals(som6, n = 1000, plot = T)
testResiduals(som6_sr) #more underdispersed than full model
```


```{r}
so.ls1 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~Treat_Type,
                 family = nbinom1)
AIC(so.ls1) #3254

so1_sr <- simulateResiduals(so.ls1, n = 1000, plot = T)
testResiduals(so1_sr)
```










