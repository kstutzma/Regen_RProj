---
title: "Large Seedling Linear Regression"
author: "Kathleen Stutzman"
date: "2024-01-10"
output: html_document
---

Libraries:
```{r Libraries, message=FALSE, warning=FALSE}
# libraries -------------------
library(dplyr)
library(tidyverse)
library(ggplot2)
library(GGally)
library(glmmTMB)
library(TMB)
library(emmeans)
library(DHARMa)
library(lmtest)
```

Set working directory
```{r, setup}
knitr::opts_knit$set(root.dir = '/Users/user/Desktop/Data/Regen_RProj/')
```

Functions:
```{r}
# functions -------------------

```

Source large seedling data:
```{r, message=FALSE, warning=FALSE}
source("Scripts/LS_Import.R")
```

Pivot wider to create dataframe where each row is for one plot and has total details for each species group
```{r}
ls_merge2 <- ls_merge %>% 
  select(Plot_No, Region, Treat_Type, Site, Species_Groups, Total) #this is dropping browse and stump sprout data

ls_merge2 <- ls_merge2 %>% 
  pivot_wider(names_from = Species_Groups, values_from = Total)
```


Import time since data and add it to the large seedling dataset
```{r, message=FALSE, warning=FALSE}
time_since <- read_csv("CleanData/Treat_Year_Data.csv")

ls_merge3 <- merge(ls_merge2, time_since, by = 'Site')
#log transform time from treatment data
ls_merge3$l.TFT <- log(ls_merge3$Time_from_Treat)
```

Run the 'Add_BA' script and merge with dataset:
```{r, message=FALSE, warning=FALSE}
source("Scripts/Add_BA.R")

# merge with ls dataset -------------------
ls_merge4 <- merge(ls_merge3, prism_BA, by = "Plot_No")
```

Run 'Ground_Data.R' script and add it to large seedling dataset:
```{r}
source("Scripts/Ground_Data.R")

# merge with ls dataset -------------------
ls_merge5 <- merge(ls_merge4, ground3, by = "Plot_No")
```

Source and add veg data
```{r}
source("Scripts/Veg_Data.R")

# merge with ls dataset 
ls.all <- merge(ls_merge5, veg3, by = "Plot_No")

rm(ls_merge5,
   ls_merge2,
   ls_merge3,
   ls_merge4)
```

The large seedling count data is taken in 10m^2^ plots; basal area is measured in hectares; veg and soil data is taken in 1m^2^ plots. 

Large seedling data will be converted into 1m^2^ plots in order to compare across and reduce the amount of scales of data collection to two: 1m^2^ plots and per hectare observations.

```{r}
ls.all$PIRI.1m <- ls.all$PIRI/10
ls.all$SO.1m <- ls.all$Shrub_Oak/10
ls.all$Other.1m <- ls.all$Other/10
```

Create log transformed categories for newly added variables, then select for just the desired variables:
```{r}
ls.all$l.PIRI1 <- log(ls.all$PIRI.1m + 1)
ls.all$l.SO1 <- log(ls.all$SO.1m + 1)
ls.all$l.other1 <- log(ls.all$Other.1m + 1)

ls.all2 <- ls.all %>% 
  select(Treat_Type, Region, Site, Plot_No, PIRI, PIRI.1m, l.PIRI1, Shrub_Oak, SO.1m, l.SO1, Other, Other.1m, l.other1, Time_from_Treat, l.TFT, BA_HA, l.BA_HA, PIRI.BA_HA, l.BA_piri, Mineral_Soil, l.Mineral, Litter_Duff, avgLD, avgLD_l, Veg_Total, l.Veg_Total) %>% 
  arrange(Treat_Type)
```

Select just for numerical vs log and then look at paired plots:
```{r, eval=FALSE}
#not transformed
ls.num <- ls.all2 %>% 
  select(PIRI, Shrub_Oak, Other, Time_from_Treat, BA_HA, PIRI.BA_HA, Mineral_Soil, avgLD, Veg_Total, Treat_Type)

ggpairs(ls.num)
ggpairs(ls.num, aes(color = Treat_Type))


#log transformed
ls.numl <- ls.all2 %>% 
  select(l.PIRI, l.SO, l.other, l.TFT, l.BA_HA, l.BA_piri, l.Mineral, avgLD_l, l.Veg_Total, Treat_Type)

ggpairs(ls.numl)
ggpairs(ls.numl, aes(color = Treat_Type))

rm(ls.num,
   ls.numl)
```
Can see the correlation coefficients for linear (Pearsons) relationships. None of them appear very strong, except for ones that are analogs (avg LD vs mineral soil exposure; ba/ha vs piri ba/ha)

Log transformed average litter depth and basal area per hectare have a weak relationship (corr 0.33), which does make sense. 

# The above script a data naming conventions are the same as in the LS_GLMM script


Full dataset is called ls.all2


Starting first with model analysis without treatment type:
```{r}
ls.m1 <- glmmTMB(PIRI.1m ~ l.SO1 + l.other1 + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all2,
                 family = poisson)
AIC(ls.m1) #98.5
# gives warning about non-integer values (as i've reduced the counts (/10) to get them to the 1m2 ) - if BA isn't important, I could try again with no BA in dataset and keep 10m2 observations ....
summary(ls.m1)

ls.m2 <- glmmTMB(PIRI.1m ~ l.SO1 + l.other1 + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all2,
                 family = poisson)
AIC(ls.m2) #96.8

lrtest(ls.m1, ls.m2) #p = 0.5

ls.m3 <- glmmTMB(PIRI.1m ~ l.SO1 + l.other1 + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all2,
                 family = poisson)
AIC(ls.m3) #96.0

lrtest(ls.m2, ls.m3) # p = 0.3

rm(ls.m1, ls.m2, ls.m3)

ls.m11a <- glmmTMB(PIRI.1m ~ avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all2,
                 family = poisson)
AIC(ls.m11a) #AIC = 89.3, was just interested to see the AIC of this model vs. ls at 10m2 observations

#i'm just interested to see model fit on this 1m model
ls.m11a_sr <-  simulateResiduals(ls.m11a, n = 1000, plot = T) #fails very much so
```

Basal area doesn't seem important, so I'm going to go back to the 10m^2^ and 1m^2^ scales and lose per hectare observations. I'll need to rework the dataset

Revised data set with LS observations at 10m^2^ scale; this means no non-interger values for the poisson distro
```{r}
ls.all3 <- ls.all

ls.all3$l.PIRI <- log(ls.all3$PIRI + 1)
ls.all3$l.SO <- log(ls.all3$Shrub_Oak + 1)
ls.all3$l.other <- log(ls.all3$Other + 1)

ls.all3 <- ls.all3 %>% 
  select(Treat_Type, Region, Site, Plot_No, PIRI, l.PIRI, Shrub_Oak, l.SO, Other, l.other, Time_from_Treat, l.TFT, BA_HA, l.BA_HA, PIRI.BA_HA, l.BA_piri, Mineral_Soil, l.Mineral, Litter_Duff, avgLD, avgLD_l, Veg_Total, l.Veg_Total) %>% 
  arrange(Treat_Type)
```


Begin modeling again:
```{r, eval=FALSE}
#double checking about basal area variables, even though this is at 3 scales

ls.m4 <- glmmTMB(PIRI ~ l.SO + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m4) #AIC is 291


#test piri ba
ls.m5 <- glmmTMB(PIRI ~ l.SO + l.other + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m5) #289.2

lrtest(ls.m4, ls.m5) #p = 0.7

#test ba
ls.m6 <- glmmTMB(PIRI ~ l.SO + l.other + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m6) #287.3

lrtest(ls.m5, ls.m6) #p=0.8

#test mineral soil
ls.m7 <- glmmTMB(PIRI ~ l.SO + l.other + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m7) #285.3

lrtest(ls.m6, ls.m7) # p = 0.8

#test litter depth
ls.m8 <- glmmTMB(PIRI ~ l.SO + l.other + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m8) #289.5

lrtest(ls.m7, ls.m8) # p = 0.01, keep avg LD

#return avg ld, test other
ls.m9 <- glmmTMB(PIRI ~ l.SO + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m9) #285.1

lrtest(ls.m7, ls.m9) #p = 0.2

# test shrub oak
ls.m10 <- glmmTMB(PIRI ~ avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m10) #285.2

lrtest(ls.m10, ls.m9) #p = 0.1

#test veg cover ------ seems like this is the best model
ls.m11 <- glmmTMB(PIRI ~ avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m11) # p = 283.2


ls.m12 <- glmmTMB(PIRI ~ avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(ls.m12) #280

ls.m12_sr <- simulateResiduals(ls.m12, n = 100, plot = TRUE)


lrtest(ls.m10, ls.m11) # p = 0.97

rm(ls.m4, ls.m5, ls.m6, ls.m7, ls.m8, ls.m9, ls.m10)
```


Now to test model fit:
```{r, eval=FALSE}
ls.m11_sr <- simulateResiduals(ls.m11, n = 1000, plot = TRUE) #doesn't pass ks
testResiduals(ls.m11_sr)
testZeroInflation(ls.m11_sr)

# I wonder if I added treat type, if the model would pass
ls.m12 <- glmmTMB(PIRI ~ Treat_Type + avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m12) #284.6

lrtest(ls.m12, ls.m11) #says treat type isn't important

ls.m12_sr <- simulateResiduals(ls.m12, n = 1000, plot = T) #looks better, still not perfect

testResiduals(ls.m12_sr) #passes
testZeroInflation(ls.m12_sr) #passes
testQuantiles(ls.m12_sr)

#going to test a model with more variables (and not treat type), to see if that fits better


ls.m10_sr <- simulateResiduals(ls.m10, n = 1000, plot = T)
#tests on model 9 failed & on 10
```


Models without treatment type failed in model fit. Going to run variable elimination again, starting with models with treatment type
```{r}
ls.m13 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m13) #293.2

ls.m14 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m14) #291.3

ls.m15 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m15) #289.5

ls.m16 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m16) #287.5

ls.m17 <- glmmTMB(PIRI ~ Treat_Type + l.SO + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m17) #286.3

lrtest(ls.m13, ls.m14, ls.m15, ls.m16, ls.m17)


ls.m18 <- glmmTMB(PIRI ~ Treat_Type + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m18) #286.6

lrtest(ls.m17, ls.m18) #p = 0.13

ls.m19 <- glmmTMB(PIRI ~ Treat_Type + avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
summary(ls.m19) #284.6

lrtest(ls.m18, ls.m19) #0.98

ls.m20 <- glmmTMB(PIRI ~ Treat_Type + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(ls.m20) #288
lrtest(ls.m19, ls.m20) # p = 0.02

rm(ls.m13, ls.m14, ls.m15, ls.m16, ls.m17, ls.m18, ls.m20)
```



Ok, test model fit with treat type (same as model 11)
```{r}
ls.m19_sr <- simulateResiduals(ls.m19, n = 1000, plot = TRUE) #passes KS, quantile deviations fails, but it still could be an accepted model
testResiduals(ls.m19_sr) #pases
testZeroInflation(ls.m19_sr) #passes
testQuantiles(ls.m19_sr) #fails
```

Trying pairwise comparison of model fit:
```{r}
emmeans(ls.m19, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
```

Control vs Harvest is the only significant different (p = 0.0399)









I'd like to see some graphs before I close out
```{r}

library(sjPlot)
library(sjlabelled)
library(sjmisc)


set_theme(base = theme_classic(),
          theme.font = 'serif',
          axis.title.size = 1.5,
          axis.textsize.x = 1.5,
          axis.textsize.y = 1.5,
          title.size = 2.5,
          title.align = "center",
          legend.pos = "right",
          legend.size = 1.5,
          legend.title.size = 1.5,
          #legend.bordercol = "black",
          legend.item.size = .75)

# plot_model(ls.m19) #this is incidence rate ratios
# 
# plot_model(ls.m19, type = "diag") #random vs normal quantiles
# 
# plot_model(ls.m19, type = "re") #this plots random effects
# 
# plot_model(ls.m19, 
#            type = 'pred', 
#            terms = 'Treat_Type') #plot marginal effects (i might have done this wrong)

# LS PIRI plot 1 ------------------- LD vs. TT
plot_model(ls.m19, 
                       type = 'pred', 
                       terms = c('avgLD_l', 'Treat_Type'),
                       axis.title = c("Average Leaf Litter Depth (log transformed)", "Total Count of Pitch Pine"),
                       title = "Predicted Counts of Pitch Pine Seedlings \n >/=50cm & <2.5cm DBH",
           legend.title = "Treatment Type",
           line.size = 1,
           value.offset = 'Treat_Type',
           ci.lvl = NA,
           colors = c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15")) 




# LS PIRI plot 2 ------------------- Time from Treatment vs TT
plot_model(ls.m19, 
                       type = 'pred', 
                       terms = c('l.TFT', 'Treat_Type'),
                       axis.title = c("Time from Treatment (log transformed)", "Total Count of Pitch Pine"),
                       title = "Predicted Counts of Pitch Pine Seedlings \n >/=50cm & <2.5cm DBH",
           legend.title = "Treatment Type",
           line.size = 1,
           value.offset = 'Treat_Type',
           ci.lvl = NA,
           colors = c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15")) 
```


Should I think about graphs where the offset is included?

Random slope for models?


# Shrub oak models
```{r, eval=FALSE}
so.ls1 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(so.ls1) # 3377.9

# test piri ba
so.ls2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(so.ls2) #3379.8

lrtest(so.ls1, so.ls2) #p = 0.0498, so maybe

# test total BA
so.ls3 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(so.ls3) #3379.8

lrtest(so.ls1, so.ls3) # p = 0.0478, keep BA for now

# test mineral
so.ls4 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(so.ls4) #3381.7

lrtest(so.ls2, so.ls4) # p = 0.048

# test avg ld
so.ls5 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(so.ls5) #3378.3 ---- keep mineral, lower AIC

lrtest(so.ls5, so.ls2) # p = 0.48

# test piri
so.ls6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(so.ls6) #3380

lrtest(so.ls6, so.ls5) # p = 0.051

# test other
so.ls7 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(so.ls7) #3388.2

lrtest(so.ls6, so.ls7) # p = 0.001

# test veg
so.ls8 <- glmmTMB(Shrub_Oak ~ Treat_Type +l.other + l.BA_HA + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(so.ls8) # 3383.4




lrtest(so.ls8, so.ls6) # p > 0.001
```

Seemingly best models
```{r, eval=FALSE}
so.ls5 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(so.ls5) #3378.3 ---- keep mineral, lower AIC

so.ls5_sr <- simulateResiduals(so.ls5, n = 1000, plot = TRUE) #quantile test not looking good
testResiduals(so.ls5_sr)
testDispersion(so.ls5_sr, alternative = "less") #again, under dispersed

so.ls5a <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = compois)
AIC(so.ls5a) #3290

so.ls5a_sr <- simulateResiduals(so.ls5a, n = 1000, plot = TRUE) 
testResiduals(so.ls5a_sr) #still underdispersed

so.ls5b <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(so.ls5b) #3274.5

so.ls5b_sr <- simulateResiduals(so.ls5b, n = 1000, plot = TRUE)
testResiduals(so.ls5b_sr) #still underdispersed
```

Test second model
```{r, eval=FALSE}
so.ls6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(so.ls6) #3380

so.ls6_sr <- simulateResiduals(so.ls6, n = 1000, plot = TRUE)
testResiduals(so.ls6_sr) # fails dispersion

so.ls6a <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(so.ls6a) #3275.5
#compois distro fails and won't produce DHARMa results
so.ls6a_sr <- simulateResiduals(so.ls6a, n = 1000, plot = T)
testResiduals(so.ls6a_sr) # fails dispersion
```

### testing other distros
```{r, eval=FALSE}
so.ls6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(so.ls6)

so.ls6a <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(so.ls6a)

# compois distro fails, won't produce DHARMa results

so.ls6b <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = tweedie)
AIC(so.ls6b)

so.ls6b_sr <- simulateResiduals(so.ls6b, n = 1000, plot = TRUE)
testDispersion(so.ls6b_sr) #fails

so.ls6c <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
AIC(so.ls6c)

so.ls6c_sr <- simulateResiduals(so.ls6c, n = 1000, plot = TRUE)
testResiduals(so.ls6c_sr)
testDispersion(so.ls6c_sr) #passes
testQuantiles(so.ls6c_sr)


so.ls6d <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = gaussian)
AIC(so.ls6d)

so.ls6d_sr <- simulateResiduals(so.ls6d, n = 1000, plot = TRUE) #fails
plot(so.ls6d_sr)
testResiduals(so.ls6d_sr)
```

#### student t distro
```{r, eval=FALSE}
so.ls1 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
AIC(so.ls1) # 3880.6

# test piri ba
so.ls2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                family = t_family)
AIC(so.ls2) #3879.6

lrtest(so.ls1, so.ls2) #p = 0.3

# test total BA
so.ls3 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                  family = t_family)
AIC(so.ls3) #3885.4

lrtest(so.ls1, so.ls3) # p = 0.009

# test mineral
so.ls4 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                  family = t_family)
AIC(so.ls4) #3881.5

lrtest(so.ls2, so.ls4) # p = 0.046

# test avg ld
so.ls5 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                  family = t_family)
AIC(so.ls5) #3877.7---- keep avg LD, lower AIC

lrtest(so.ls5, so.ls2) # p = 0.48

# test piri
so.ls6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_HA + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                  family = t_family)
AIC(so.ls6) #3882.6

lrtest(so.ls6, so.ls4) # p = 0.08

# test other
so.ls7 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.BA_HA + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
AIC(so.ls7) #3891

lrtest(so.ls6, so.ls7) # p = 0.001

# test veg
so.ls8 <- glmmTMB(Shrub_Oak ~ Treat_Type +l.other + l.BA_HA + avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
#won't converge

lrtest(so.ls6, so.ls1) #p = 0.046

#issue is that I'm representing 3 measurement scales. reduce BA? 
```

### testing t distro
```{r, eval=FALSE}
so.ls6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_HA + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                  family = t_family)

ls.all3$BA_10m <- (ls.all3$BA_HA/1000)
ls.all3$l.BA_10m <- log(ls.all3$BA_10m + 1)

so.ls9 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_10m + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                  data = ls.all3,
                  family = t_family)

so.ls10 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                  data = ls.all3,
                  family = t_family)
AIC(so.ls10) #3884.5

so.ls11 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                  data = ls.all3,
                  family = t_family)
AIC(so.ls11) #3395.4

lrtest(so.ls10, so.ls11) #keep veg

so.ls12 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + avgLD_l + l.BA_10m + offset(l.TFT) + (1|Site/Plot_No),
                  data = ls.all3,
                  family = t_family)
AIC(so.ls12) #3883.8

lrtest(so.ls11, so.ls12) #keep ba

#maybe if i drop something else model will run?

so.ls13 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.BA_10m + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                  data = ls.all3,
                  family = t_family)
AIC(so.ls12) #3883.8

so.ls1a <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_10m + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
AIC(so.ls1a) # 3873.8


```

### starting with basal area at 10m^2^ range instead of per HA
```{r, eval=FALSE}
# this is killing me - moving the basal area down to the 10m scale, to keep measurements on 2 scales; overwriting models

so.ls1 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_10m + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
AIC(so.ls1) # 3873.8

so.ls2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_10m + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
AIC(so.ls2)

so.ls3 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_10m + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
AIC(so.ls3) #3875.7 without mineral

so.ls3b <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_10m + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
AIC(so.ls3b) #3871.9 w/o LD

lrtest(so.ls2, so.ls3) # p = 0.46
lrtest(so.ls2, so.ls3b) #drop ld for sure

# test piri
so.ls4 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_10m + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
AIC(so.ls4) #3871.9

#test other
so.ls5 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.BA_10m + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
AIC(so.ls5) #3881.5

lrtest(so.ls4, so.ls5) # keep other

# test veg
so.ls6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_10m + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
AIC(so.ls6) #3878

so.ls7 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
AIC(so.ls7) #3881.7, keep ba
```

# best model?
```{r, eval=FALSE}
so.ls6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.BA_10m + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = t_family)
summary(so.ls6)

so.ls6_sr <- simulateResiduals(so.ls6, n = 1000, plot = TRUE)
testResiduals(so.ls6_sr)
plot(so.ls6_sr)
```

### Pairwise with treatment type
```{r, eval=FALSE}
emmeans(so.ls6, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
```

```{r}
hist(ls.all3$Shrub_Oak)

ggplot(ls.all3, aes(x=Shrub_Oak))+
  geom_histogram(binwidth = 2)+
  facet_grid(rows = vars(Treat_Type))
```


##### Model 6 appears to be the best. There are issues of collinearlity with total veg cover and shrub oak counts, so it has been dropped from the model despite AIC/lrtest results

### Graph shrub oak models
```{r, eval=FALSE}
# LS SO plot 1 ------------------- other vs. TT
plot_model(so.ls6, 
                       type = 'pred', 
                       terms = c('l.other', 'Treat_Type'),
                       axis.title = c("Other small seedling counts (log transformed)", "Total Count of Shrub Oak"),
                       title = "Predicted Counts of Shrub Oak \n Seedlings >/=50cm & <2.5cm DBH",
           legend.title = "Treatment Type",
           line.size = 1,
           value.offset = 'Treat_Type',
           ci.lvl = NA,
           colors = c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15")) 

# LS SO plot 2 ------------------- BA_10m vs. TT
plot_model(so.ls6, 
                       type = 'pred', 
                       terms = c('l.other', 'Treat_Type'),
                       axis.title = c("Total Basal Area per 10 square meters (log transformed)", "Total Count of Shrub Oak"),
                       title = "Predicted Counts of Shrub Oak \n Seedlings >/=50cm & <2.5cm DBH",
           legend.title = "Treatment Type",
           line.size = 1,
           value.offset = 'Treat_Type',
           ci.lvl = NA,
           colors = c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15")) 

# LS SO plot 3 ------------------- l.mineral vs. TT
plot_model(so.ls6, 
                       type = 'pred', 
                       terms = c('l.other', 'Treat_Type'),
                       axis.title = c("Amount of exposed mineral soil (log transformed)", "Total Count of Shrub Oak"),
                       title = "Predicted Counts of Shrub Oak \n Seedlings >/=50cm & <2.5cm DBH",
           legend.title = "Treatment Type",
           line.size = 1,
           value.offset = 'Treat_Type',
           ci.lvl = NA,
           colors = c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15")) 
```

#Start model fit with genpois distro and then do elimination?
```{r, eval=FALSE}
so.ls1 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(so.ls1) #3275.5


so.ls1b <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = compois)
AIC(so.ls1b) #this is taking a very long time - so i quit, moving forward with genpois

#test piri ba
so.ls2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(so.ls2) #3276.4

lrtest(so.ls1, so.ls2) #drop

#test ba
so.ls3 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(so.ls3) #3276.8

#test mineral
so.ls4 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(so.ls4) #3279.2

lrtest(so.ls3, so.ls4) #keep mineral

# test ld
so.ls5 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(so.ls5) #3274.8

# test other
so.ls6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI  + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(so.ls6) #3280

lrtest(so.ls6, so.ls5) #keep other

# test piri
so.ls7 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.Mineral + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(so.ls7) #3275.9

lrtest(so.ls7, so.ls5) #drop piri

#going to drop veg due to collinearity issues
# test ld
so.ls8 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(so.ls8) #3284

so.ls8_sr <- simulateResiduals(so.ls8, n = 1000, plot = TRUE)
testResiduals(so.ls8_sr)
testDispersion(so.ls8_sr, alternative = "less")
#underdispersed
testZeroInflation(so.ls8_sr)

so.ls9 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = compois)
AIC(so.ls9) #3301.9

so.ls9_sr <- simulateResiduals(so.ls9, n = 1000, plot = TRUE)
testResiduals(so.ls9_sr) #worse on dispersion

so.ls10 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = nbinom1)
AIC(so.ls10) #3257.3

so.ls10_sr <- simulateResiduals(so.ls10, n = 1000, plot = TRUE)
testResiduals(so.ls10_sr) #fails dispersion


so.ls11 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = nbinom2)
AIC(so.ls11) #3352

so.ls11_sr <- simulateResiduals(so.ls11, n = 1000, plot = TRUE)
testResiduals(so.ls11_sr) # fails dispersion
testZeroInflation(so.ls11_sr)

# run poisson model with zero inflation?
so.ls12 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1,
                 family = genpois)
AIC(so.ls12) #3271.5

so.ls12_sr <- simulateResiduals(so.ls12, n = 1000, plot = TRUE)
testResiduals(so.ls12_sr) #still fails dispersion
testZeroInflation(so.ls12_sr)

so.ls13 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(so.ls13)

so.ls13_sr <- simulateResiduals(so.ls13, n = 1000, plot = TRUE)
testResiduals(so.ls13_sr) #still fails dispersion
testZeroInflation(so.ls13_sr) #does fail

```

#### ok, zero inflation issues
```{r, eval=FALSE}
#starting with veg dropped due to collinearity issues
so.ls1 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1,
                 family = nbinom1)
AIC(so.ls1) #3253.5

#test piri ba
so.ls2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1,
                 family = nbinom1)
AIC(so.ls2) #3252

#test ba
so.ls3 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Mineral + avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1,
                 family = nbinom1)
AIC(so.ls3) #3254

lrtest(so.ls2, so.ls3) # p = 0.6, drop

#test ld
so.ls4 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1,
                 family = nbinom1)
AIC(so.ls4) #3252

#test piri
so.ls5 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1,
                 family = nbinom1)
AIC(so.ls5) #3254

lrtest(so.ls4, so.ls5) # keep piri

#test other
so.ls6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI  + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1,
                 family = nbinom1)
AIC(so.ls6) # 3256

lrtest(so.ls4, so.ls6) #keep other

#test mineral
so.ls7 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1,
                 family = nbinom1)
AIC(so.ls7) #3255.4

lrtest(so.ls7, so.ls4) #keep mineral

#test treat type
so.ls8 <- glmmTMB(Shrub_Oak ~ l.PIRI + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1,
                 family = nbinom1)
AIC(so.ls8) #3341.4

lrtest(so.ls4, so.ls8) # keep tt
```

seemingly best model
```{r, eval = FALSE}
so.ls4 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1,
                 family = nbinom1)

so.ls4_sr <- simulateResiduals(so.ls4, n = 1000, plot = TRUE)
testZeroInflation(so.ls4_sr) #passes
testResiduals(so.ls4_sr) #fails dispersion

so.ls4b <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~Treat_Type,
                 family = nbinom1)

so.ls4b_sr <- simulateResiduals(so.ls4b, n = 1000, plot = TRUE)
testZeroInflation(so.ls4b_sr) #passes
testResiduals(so.ls4b_sr)

#try with second nbinom distro

so.ls4c <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1,
                 family = nbinom2)

so.ls4c_sr <- simulateResiduals(so.ls4c, n = 1000, plot = TRUE)
testZeroInflation(so.ls4c_sr) #passes
testResiduals(so.ls4c_sr) #worse

so.ls4d <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~Treat_Type,
                 family = nbinom2)

so.ls4d_sr <- simulateResiduals(so.ls4d, n = 1000, plot = TRUE)
testZeroInflation(so.ls4d_sr) #passes
testResiduals(so.ls4d_sr) #worse

# maybe 
so.ls4e <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~Treat_Type,
                 family = genpois)

so.ls4e_sr <- simulateResiduals(so.ls4e, n = 1000, plot = TRUE)
testZeroInflation(so.ls4e_sr) #passes
testResiduals(so.ls4e_sr) #fails again

```

### starting modeling again. going to model with poisson and check out zero inflation issues. then reduce model or try other distros
```{r, eval = FALSE}
m1 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = poisson)
AIC(m1) #3391.3

m1_sr <- simulateResiduals(m1, n = 1000, plot = T)
testZeroInflation(m1_sr)#fails

m2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
              ziformula = ~1,
                 family = poisson)
#1, region, and tt all fail with poisson distro

m2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              family = nbinom1)
AIC(m2) #3254.1

m2_sr <- simulateResiduals(m2, n = 1000, plot = T)
testZeroInflation(m2_sr) #passes
testResiduals(m2_sr) # fails, is underdispersed
testDispersion(m2_sr, alternative = "less") # = 0.006

#try nbimom2
m3 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              family = nbinom2)
AIC(m3) #3313.1

m3_sr <- simulateResiduals(m3, n = 1000, plot = T)
testZeroInflation(m3_sr) #fails
testResiduals(m3_sr) # fails, is underdispersed
testDispersion(m3_sr, alternative = "less") # <0.001

#try genpois (it fails)
#try compois - taking a very long time to run
m4 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              ziformula = ~1,
              family = compois)
AIC(m4) #3270

m4_sr <- simulateResiduals(m4, n = 1000, plot = T)
testZeroInflation(m4_sr) #passes
testResiduals(m4_sr) # fails, is underdispersed
testDispersion(m4_sr, alternative = "less") # <0.001

#compois is worse

m5 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              family = nbinom1)

m5_sr <- simulateResiduals(m5, n = 1000, plot = T)
testZeroInflation(m5_sr) #passes
testResiduals(m5_sr) #0.006

#region is slightly worse (0.002) for ziformula; treat_type is 0.006; site fails, l.TFT is 0.006;BAHA fails 

# maybe having less variables will change the sr model

m6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              family = nbinom1)

m6_sr <- simulateResiduals(m6, n = 1000, plot = T)
testZeroInflation(m6_sr) #passes
testResiduals(m6_sr) #worse 0.002

m7 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              ziformula = ~1,
              family = nbinom1)

m7_sr <- simulateResiduals(m7, n = 1000, plot = T)
testZeroInflation(m7_sr) #passes
testResiduals(m7_sr) #0.008


m8 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              ziformula = ~1,
              family = nbinom1)

m8_sr <- simulateResiduals(m8, n = 1000, plot = T)
testZeroInflation(m8_sr) #passes
testResiduals(m8_sr) #0.002

m10 <- glmmTMB(Shrub_Oak ~ Treat_Type + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              ziformula = ~1,
              family = nbinom1)

m10_sr <- simulateResiduals(m10, n = 1000, plot = T)
testZeroInflation(m10_sr) #passes
testResiduals(m10_sr) #0.004

m11 <- glmmTMB(Shrub_Oak ~ Treat_Type + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              family = nbinom1)

m11_sr <- simulateResiduals(m11, n = 1000, plot = T)
testZeroInflation(m11_sr) #passes
testResiduals(m11_sr) #0.004


m11 <- glmmTMB(Shrub_Oak ~ Treat_Type + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              ziformula = ~1,
              family = gaussian)

m11_sr <- simulateResiduals(m11, n = 1000, plot = T)
testZeroInflation(m11_sr) #passes
testResiduals(m11_sr) #0.004


m2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
              ziformula = ~1,
                 family = gaussian)
AIC(m2)
m2_sr <- simulateResiduals(m2, n = 1000, plot = T)
testZeroInflation(m2)
testResiduals(m2) #fails uniformity, passes dispersion

m2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              ziformula = ~1,
              family = tweedie)
AIC(m2)
m2_sr <- simulateResiduals(m2, n = 1000, plot = T)
testZeroInflation(m2)
testResiduals(m2) #fails dispersion passes uniformity

m2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              family = tweedie)
AIC(m2)
m2_sr <- simulateResiduals(m2, n = 1000, plot = T)
testZeroInflation(m2)
testResiduals(m2) #fails dispersion passes uniformity
```





# nbinom distro 1 solves 0 inflation issues, but models are still underdispersed

I've tried poisson, nbinom1, nbinom1 with ZI, nbinom2, genpois, compois, tweedie, gaussian and none of these distros work. They are all underdispersed

## These are very full models with many different distributions. All are underdispersed.
```{r}
m1 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = nbinom1)
AIC(m1) 

m1_sr <- simulateResiduals(m1, n = 1000, plot = T)
testZeroInflation(m1_sr) #passes
testResiduals(m1_sr) #under dispersed, 0.002

m2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = genpois)
AIC(m2) 

m2_sr <- simulateResiduals(m2, n = 1000, plot = T)
testZeroInflation(m2_sr) #passes
testResiduals(m2_sr) #under dispersed, 0.004

m3 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 family = compois)
AIC(m3) #this is taking a very long time to run

m3_sr <- simulateResiduals(m3, n = 1000, plot = T)
testZeroInflation(m3_sr) #fails
testResiduals(m3_sr) #fails dispersion

m4 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.Mineral +  offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              ziformula = ~1,
              family = compois)
AIC(m4)

m4_sr <- simulateResiduals(m4, n = 1000, plot = T)
testZeroInflation(m4_sr) #passes
testResiduals(m4_sr) #fails dispersion
```

### I cannot find a model that works. 



```{r}
so.ls1 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = ls.all3,
                 ziformula = ~1,
                 family = poisson-lognormal)
AIC(so.ls1)

overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}


overdisp_fun(so.ls1)


library(lme4)
mod2 <- glmer(Shrub_Oak ~ Treat_Type + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
              data = ls.all3,
              family = poisson)

mod2_sr <- simulateResiduals(mod2, n = 1000, plot = T)
testZeroInflation(mod2_sr)
testDispersion(mod2_sr)

#still bad, can't find this poisson log normal family distro of which the literature speaks - unless its the quasipoisson distro, which says can't work with a glmer....
```





















