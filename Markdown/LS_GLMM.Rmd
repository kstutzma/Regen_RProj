---
title: "Large Seedling PIRI GLMM"
author: "Kathleen Stutzman"
date: "2024-01-04"
output: html_document
---

## Introduction:
This script, originally written as an R script, will be much more readable as an R Markdown. Therefore, I am translating it into a markdown file.

# Pitch Pine Large Seedling GLMM code

Libraries:
```{r Libraries, message=FALSE, warning=FALSE}
# libraries -------------------
library(dplyr)
library(tidyverse)
library(ggplot2)
library(GGally)
library(glmmTMB)
library(TMB)
library(emmeans)
library(DHARMa)
```

Set working directory
```{r, setup}
knitr::opts_knit$set(root.dir = '/Users/user/Desktop/Data/Regen_RProj/')
```

Functions:
```{r}
# functions -------------------

```

Source large seedling data
```{r}
source("Scripts/LS_Import.R")
```

```{r, eval=FALSE, include=FALSE}
# filter just for PIRI
ls_piri <- ls_merge %>% 
  filter(Species_Groups == "PIRI") %>% 
  arrange(Treat_Type)

# make explanatory variables factors -------------------
ls_piri$Treat_Type = factor(ls_piri$Treat_Type,
                              levels = unique(ls_piri$Treat_Type))

ls_piri$Region = factor(ls_piri$Region,
                          levels = unique(ls_piri$Region))

ls_piri$Site = factor(ls_piri$Site,
                        levels = unique(ls_piri$Site))
```

Pivot wider to create dataframe where each row is for one plot and has total details for each species group
```{r}
ls_merge2 <- ls_merge %>% 
  select(Plot_No, Region, Treat_Type, Site, Species_Groups, Total) #this is dropiing browse and stump sprout data

ls_merge2 <- ls_merge2 %>% 
  pivot_wider(names_from = Species_Groups, values_from = Total)
```

Import time since data and add it to the large seedling dataset
```{r}
time_since <- read_csv("CleanData/Treat_Year_Data.csv")

ls_merge3 <- merge(ls_merge2, time_since, by = 'Site')
#log transform time from treatment data
ls_merge3$l.TFT <- log(ls_merge3$Time_from_Treat)
```

Run the 'Add_BA' script and merge with dataset:
```{r}
source("Scripts/Add_BA.R")

# merge with ls dataset -------------------
ls_merge4 <- merge(ls_merge3, prism_BA, by = "Plot_No")
```

Run 'Ground_Data.R' script and add it to large seedling dataset:
```{r}
source("Scripts/Ground_Data.R")

# merge with ls dataset -------------------
ls_merge5 <- merge(ls_merge4, ground3, by = "Plot_No")
```

Source and add veg data
```{r}
source("Scripts/Veg_Data.R")

# merge with ls dataset 
ls.all <- merge(ls_merge5, veg3, by = "Plot_No")

rm(ls_merge5,
   ls_merge2,
   ls_merge3,
   ls_merge4)
```

The large seedling count data is taken in 10m^2^ plots; basal area is measured in hectares; veg and soil data is taken in 1m^2^ plots. 

Large seedling data will be converted into 1m^2^ plots in order to compare across and reduce the amount of scales of data collection, reducing to two: 1m^2^ plots and per hectare observations.

```{r}
ls.all$PIRI.1m <- ls.all$PIRI/10
ls.all$SO.1m <- ls.all$Shrub_Oak/10
ls.all$Other.1m <- ls.all$Other/10
```

Create log transformed categories for newly added variables, then select for just the desired variables:
```{r}
ls.all$l.PIRI <- log(ls.all$PIRI.1m + 1)
ls.all$l.SO <- log(ls.all$SO.1m + 1)
ls.all$l.other <- log(ls.all$Other.1m + 1)

ls.all2 <- ls.all %>% 
  select(Treat_Type, Region, Site, Plot_No, PIRI, l.PIRI, Shrub_Oak, l.SO, Other, l.other, Time_from_Treat, l.TFT, BA_HA, l.BA_HA, PIRI.BA_HA, l.BA_piri, Mineral_Soil, l.Mineral, Litter_Duff, avgLD, avgLD_l, Veg_Total, l.Veg_Total) %>% 
  arrange(Treat_Type)
```

Select just for numerical vs log and then look at paired plots:
```{r, eval=FALSE}
#not transformed
ls.num <- ls.all2 %>% 
  select(PIRI, Shrub_Oak, Other, Time_from_Treat, BA_HA, PIRI.BA_HA, Mineral_Soil, avgLD, Veg_Total, Treat_Type)

ggpairs(ls.num)
ggpairs(ls.num, aes(color = Treat_Type))


#log transformed
ls.numl <- ls.all2 %>% 
  select(l.PIRI, l.SO, l.other, l.TFT, l.BA_HA, l.BA_piri, l.Mineral, avgLD_l, l.Veg_Total, Treat_Type)

ggpairs(ls.numl)
ggpairs(ls.numl, aes(color = Treat_Type))

rm(ls.num,
   ls.numl)
```
Can see the correlation coefficients for linear (Pearsons) relationships. None of them appear very strong, except for ones that are analogs (avg LD vs mineral soil exposure; ba/ha vs piri ba/ha)

Log transformed average litter depth and basal area per hectare have a weak relationship (corr 0.33), which does make sense. 

#The above script a data naming conventions are the same as in the LS_LR script







# Below is script from before veg data was added 
Next to explore models with all the data:

















ba & shrub oak .4 corr
min soil and piri

















Below are models that failed to converge using the glmer package. Re-tried with glmmTMB, they do converge, but still have high AIC
```{r, eval=FALSE}
ls.p_all <- glmmTMB(Total~Treat_Type + avgLD_l + l.BA_HA + l.BA_piri + l.Mineral + (1|Site/Plot_No) + offset(l.TFT),
                  data = ls_alldata,
                  family = poisson)
AIC(ls.p_all) #AIC is 290

ls.p2 <- glmmTMB(Total~Treat_Type + avgLD_l + l.BA_HA + l.BA_piri + (1|Site/Plot_No) + offset(l.TFT),
                  data = ls_alldata,
                  family = poisson)
AIC(ls.p2) #AIC is 288

ls.p3 <- glmmTMB(Total~Treat_Type + avgLD_l + l.BA_HA + + (1|Site/Plot_No) + offset(l.TFT),
               data = ls_alldata,
               family = poisson)
AIC(ls.p3)# AIC is 286.2

ls.p4 <- glmmTMB(Total~Treat_Type + avgLD_l + l.BA_HA + + (1|Site/Plot_No),
               data = ls_alldata,
               family = poisson)
AIC(ls.p4) #failed to converge, AIC is 286

rm(ls.p_all,
   ls.p2,
   ls.p3,
   ls.p4)
```

Models that converge:
```{r}
ls.p5 <- glmmTMB(Total~Treat_Type + avgLD_l + (1|Site/Plot_No),
               data = ls_alldata,
               family = poisson)
AIC(ls.p5) #AIC is 284.4

ls.p6 <- glmmTMB(Total~Treat_Type + (1|Site/Plot_No),
               data = ls_alldata,
               family = poisson)
AIC(ls.p6) #AIC is 287.5

#best model so far --------------------
ls.p7 <- glmmTMB(Total~Treat_Type + avgLD_l+ (1|Site/Plot_No) + offset(l.TFT),
               data = ls_alldata,
               family = poisson)
summary(ls.p7) #AIC is 284.6

ls.p8 <- glmmTMB(Total~Treat_Type + l.Mineral + (1|Site/Plot_No) + offset(l.TFT),
               data = ls_alldata,
               family = poisson)
summary(ls.p8) #288
```

Test value of offset variable:
```{r}
library(lmtest)
lrtest(ls.p7, ls.p5)
# with offset p is less than 0.0001, so keep it
```

Run DHARMa package to check model fit:
```{r}
ls.p7_sr <- simulateResiduals(fittedModel = ls.p7, n = 1000, plot = TRUE)

testDispersion(ls.p7_sr) #PASSES
testOutliers(ls.p7_sr)
testZeroInflation(ls.p7_sr) #looks good
testResiduals(ls.p7_sr)

# Plotting standardized residuals against predictors
plotResiduals(ls.p7_sr, ls_alldata$Treat_Type, xlab = "Treatment Type", main=NULL)  

plotResiduals(ls.p7_sr, ls_alldata$Site, xlab = "Site", main=NULL)
```

Use emmeans for pairwise comparison of Treatment Types:
```{r}
emmeans(ls.p7, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
# harvest is the only significantly different
```

Below is script to create plots. Do not run unless desired. The added packages cause issues for running general GLMM scripts (issues with tidyverse) and therefore are only worth activating if you want to produce graphs or have already loaded all desired analysis
```{r, eval=FALSE}
library(sjPlot)
library(sjlabelled)
library(sjmisc)

set_theme(base = theme_classic(),
          theme.font = 'serif',
          axis.title.size = 1.5,
          axis.textsize.x = 1.5,
          axis.textsize.y = 1.5,
          title.size = 2.5,
          title.align = "center",
          legend.pos = "right",
          legend.size = 1.5,
          legend.title.size = 1.5,
          #legend.bordercol = "black",
          legend.item.size = .75)

# LS plot 1 -------------------
plot_model(ls.p9, 
           type = 'pred', 
           terms = c('l.avgLD', 'Treat_Type'),
           axis.title = c("Average Leaf Litter Depth (log transformed)", "Total Count of Pitch Pine"),
           title = "Predicted Counts of Pitch Pine Seedlings \n >/=50cm & <2.5cm DBH",
           legend.title = "Treatment Type",
           line.size = 1,
           value.offset = 'Treat_Type',
           ci.lvl = NA,
           colors = c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15")) 

```


# Other hidden analysis: early data exploration, stats, and graphs
```{r, eval=FALSE, include=FALSE}
# ********  exploring total data using histogram -------------------
ggplot(ls_merge, aes(x=Total))+
  geom_histogram(binwidth = 2)+
  facet_grid(cols = vars(Species_Groups), rows = vars(Treat_Type))

# ********  boxplots? -------------------
ggplot(ls_merge, aes(x = Species_Groups, y=Total))+
  geom_boxplot()+
  facet_wrap(vars(Treat_Type))

# ********  lets look at some summary statistics -------------------
ls_sumstats2 <- ls_merge %>% 
  pivot_longer(c(Total, Browsed, StumpSprout), names_to = "Type") %>% 
  group_by(Treat_Type, Species_Groups, Type) %>% 
  summarize(average = round(mean(value), digits=1),
            med = median(value),
            sd = round(sd(value), digits = 1),
            var = round(var(value), digits = 1),
            min = min(value),
            max = max(value),
            .groups = "drop")


by(ls_merge, ls_merge$Treat_Type, summary)

```


# Other hidden analysis: early models
```{r, include=FALSE, eval=FALSE}
# THIS CODE IS FROM BEFORE I PUT ADDITIONAL DATA (LIKE GROUND COVER AND BA) INTO THE DATA SET #####################
ls.nb_null <- glmer.nb(Total~Treat_Type + (1|Site/Plot_No),
                       data = ls_piri)
summary(ls.nb_null) # AIC = 493, df resid = 993


ls.zi_null2 <- glmmTMB(Total~Treat_Type + (1|Site/Plot_No),
                      data = ls_piri,
                      ziformula = ~1,
                      family = nbinom1)
#other one has convergence problems


AIC(ls.zi_null2) # null = 493, zi2 = 497

rm(ls.zi_null2)

# for now, looks like just NB model is better than zero-inflated. now add more fixed and random effects?
ls.nb_region <- glmer.nb(Total~Treat_Type + (1|Site/Plot_No) + (1|Region),
                       data = ls_piri)
summary(ls.nb_region) # AIC = 496

rm(ls.nb_region)


ls.nb_sim.resid <- simulateResiduals(ls.nb_null, n = 1000, plot = TRUE) #looks pretty good

testDispersion(ls.nb_sim.resid)
testOutliers(ls.nb_sim.resid)

plotResiduals(ls.nb_sim.resid, ls_piri$Treat_Type, xlab = "Treatment Type", main = NULL)

plotResiduals(ls.nb_sim.resid, ls_piri$Site, xlab = "Site", main = NULL)

# plotResiduals(ls.nb_sim.resid, ls_merge3$Plot_No, xlab = "Plot Number", main = NULL) # not sure if i should be making this plot or exactly what it means, but it does show significant deviation in the 3rd quantile  

testZeroInflation(ls.nb_sim.resid) # looking pretty good

# ok, the model fits look pretty good all things considered, now I need to understand how to run post-hoc pairwise comparisons -------------------


emmeans(ls.nb_null, list(pairwise~Treat_Type), adjust = "tukey", type = "response") #not significant
```








