---
title: "NMDS on understory vegetation data"
author: "Kathleen Stutzman"
date: "2024-02-22"
output: html_document
---

Libraries:
```{r, message=FALSE, warning=FALSE}
# libraries -------------------
library(ggplot2)
library(vegan)
library(ggvegan)
library(tidyverse)
```

Set working directory
```{r, setup}
knitr::opts_knit$set(root.dir = '/Users/user/Desktop/Data/Regen_RProj/')
```

Functions:
```{r}
# functions -------------------

```

Import veg script:
```{r}
source("Scripts/Veg_Data.R")
rm(veg3)
```

Transform veg data for analysis:
```{r}
#split overall data from veg cover
veg_meta <- veg2 %>% 
  select(Region, Treat_Type, Site, Plot_No) %>% 
  distinct(Plot_No, .keep_all = TRUE)

#pivot veg data wider and fill in zeros
veg_wider <- veg2 %>% 
  select(Plot_No, Species_Code, SP_Cover_midpoint) %>% 
  group_by(Plot_No) %>% 
  pivot_wider(names_from = Species_Code, values_from = SP_Cover_midpoint, values_fill = 0) 

#create dataframe of site and plot
veg_site <- veg2 %>% 
  select(Site, Plot_No) %>% 
  group_by(Site) %>% 
  distinct(Plot_No, .keep_all = TRUE)

# merge site and veg data; remove plot number
merveg <- merge(veg_site, veg_wider, by = "Plot_No") %>% 
  select(-Plot_No)
```
At this point, there are 165 species. This is subject to revision, as unknown species are identified

Reduce to species that occur in at least 5% of plots (That is ~25 plots)
```{r}
#THIS IS 20 plots or more, the last 5 are under 25 plots but above 20
veg_5PERC <- veg_wider %>% 
  select(Plot_No,
         QUIL,
         GAPR,
         VAPA,
         CAPE,
         GABA,
         VAAN,
         PTAQ,
         RUSP,
         KAAN,
         PIRI,
         ACRU,
         LYQU,
         QUCO,
         MELI,
         CEOR,
         COPE,
         PRSE,
         QUPR,
         PAQU,
         CEAM,
         QUAL,
         PIST,
         ARME,
         LYBO,
         POUN11,
         RHGL)
# AMSP,
# VAMY,
# FRSP,
# ARNU,
# SMGL)

# check amount of 0s
z6 <- lapply(veg_5PERC, function(x){ length(which(x==0))})
z7 <- as.data.frame(z6)
(sum(z7[,2:27]))/(26*499)

rm(z6, z7)
```

Average & relativize the 5% data
```{r}
# add site and lose plot number -------------------
veg5 <- merge(veg_5PERC, veg_site) %>% 
  select(-Plot_No) %>% 
  select(Site, everything())

veg5_avg <- veg5 %>% 
  group_by(Site) %>% 
  summarise_at(vars(QUIL:RHGL), mean) %>% 
  column_to_rownames(var = "Site")

rm(veg5, veg_5PERC)

veg5_colsum <- as.data.frame(colSums(veg5_avg))
# CEOR is bittersweet and is only found in APB
# CEAM also an APB only, RHGL maybe too ... 

# relativize data, dividing each cell by the column total (to bring common and rare species closer together) -------------------
rel_veg5 <- decostand(veg5_avg, method = 'total', MARGIN = 2)

summary(rel_veg5)
```

I have imported the data; pared the data down to species that occur in at least 5% of plots (aka 25 plots); averaged the data by site; relativized the data by column total. I will be using city-block distances (i.e., Bray-Curtis). Not going to transform the data further at this point


Source & transform other files
```{r}
time_since <- read_csv("CleanData/Treat_Year_Data.csv") # this is a dataframe with one row for each site

# make sure ggpubs not on, or this won't load
source("Scripts/Add_BA.R") #work on prism_BA, has total BA figures - do I need to change these as they were collected on a different scale?

prism1 <- prism_BA %>% 
  select(Plot_No, BA_HA, PIRI.BA_HA)

prism2 <- merge(prism1, veg_site, by = "Plot_No") %>% 
  select(-Plot_No) %>% 
  select(Site, everything())

prism4veg <- prism2 %>% 
  group_by(Site) %>% 
  summarise_at(vars(BA_HA:PIRI.BA_HA), mean)

rm(prism_BA, prism1, prism2)


source("Scripts/Ground_Data.R") #work on ground 3

ground4 <- ground3 %>% 
  select(Plot_No, Lichen, Moss, Rock, Mineral_Soil, Wood, Litter_Duff, avgLD)

ground5 <- merge(ground4, veg_site, by = "Plot_No") %>% 
  select(Site, everything()) %>% 
  select(-c(Plot_No))

ground4veg <- ground5 %>% 
  group_by(Site) %>% 
  summarise_at(vars(Lichen:avgLD), mean)

rm(ground3, ground4, ground)
```

Merge envr data to create a envr data matrix for future use in analysis
```{r}
vegmeta2 <- veg_meta %>% 
  select(Region, Treat_Type, Site) %>% 
  distinct(Site, .keep_all = TRUE)

vm1 <- merge(vegmeta2, time_since, by = "Site")

vm2 <- merge(vm1, ground4veg, by = "Site")

meta.data_veg <- merge(vm2, prism4veg, by = "Site") %>% 
  select(-c(Inventory_Yr, Treat_Yr))


rm(vm2, vm1, time_since, ground4veg, prism4veg)
```



### Run NMDS - start with 6 dimensions and reduce down to 2
```{r}
#starting with 6 dimensions
test_6d <- metaMDS(rel_veg5, 
                   distance = 'bray', 
                   k = 6, 
                   trymax = 20,
                   autotransform = FALSE)
# this works and yields stress values of 0.06

# trying 5 dimensions
test_5d <- metaMDS(rel_veg5, 
                   distance = 'bray', 
                   k = 5, 
                   trymax = 20,
                   autotransform = FALSE)
# this works and yields stress values of 0.07 - 0.08

# trying 4 dimensions
test_4d <- metaMDS(rel_veg5, 
                   distance = 'bray', 
                   k = 4, 
                   trymax = 20,
                   autotransform = FALSE)
# this works and yields stress values of 0.09 - 0.1

# trying 3 dimensions
test_3d <- metaMDS(rel_veg5, 
                   distance = 'bray', 
                   k = 3, 
                   trymax = 20,
                   autotransform = FALSE)
# this works and yields stress values of 0.12

# trying 2 dimensions
test_2d <- metaMDS(rel_veg5, 
                   distance = 'bray', 
                   k = 2, 
                   trymax = 20,
                   autotransform = FALSE)
# this works and yields stress values of 0.16 (and one of 0.25)

# seems to me that 2 dimensions works well (below the 0.2 rule of thumb), but will keep 3 dimension as well

rm(test_4d, test_5d, test_6d)
```

##### Is the outcome different if I turn community data into a distance matrix before running NMDS? Yes - you lose species information & double site info
```{r}

all.distm <-  vegdist(rel_veg5, method = "bray")

print(all.distm) # this is site to site distance and loses the species component

rm(all.distm)
```


### Make correlation data for bi-plots
```{r}
veg.envr <-  envfit(test_2d, meta.data_veg)
veg.spc.envr <- envfit(test_2d, rel_veg5)

site.scores <- as.data.frame(scores(test_2d, display = "sites")) #save NMDS results into dataframe
site.scores <- cbind(site.scores, Treat_Type = meta.data_veg$Treat_Type) #add grouping variable treat type to dataframe
site.scores <- cbind(site.scores, Region = meta.data_veg$Region)
#site.scrs <- cbind(site.scrs, Site = rownames(site.scrs)) #add site names as variable if you want to display on plot


# now for species -------------------
spp.scrs <- as.data.frame(scores(veg.spc.envr, display = "vectors")) #save species intrinsic values into dataframe
spp.scrs <- cbind(spp.scrs, Species = rownames(spp.scrs)) #add species names to dataframe
spp.scrs <- cbind(spp.scrs, pval = veg.spc.envr$vectors$pvals) #add pvalues to dataframe so you can select species which are significant

sig.spp.scrs <- subset(spp.scrs, pval<=0.003) #subset data to show species significant at 0.05


# now for envr data -------------------
env.scores.veg <- as.data.frame(scores(veg.envr, display = "vectors")) #extracts relevant scores from envifit
env.scores.veg <- cbind(env.scores.veg, env.variables = rownames(env.scores.veg)) #and then gives them their names

env.scores.veg <- cbind(env.scores.veg, pval = veg.envr$vectors$pvals) # add pvalues to dataframe
sig.env.scrs <- subset(env.scores.veg, pval<=0.05) #subset data to show variables significant at 0.05


# now begin plotting   -------------------
nmds.plot.vegall <- ggplot(site.scores, aes(x=NMDS1, y=NMDS2))+ #sets up the plot
  geom_point(aes(NMDS1, NMDS2, colour = factor(site.scores$Treat_Type), shape = factor(site.scores$Region)), size = 2)+ #adds site points to plot, shape determined by Landuse, colour determined by Management
  coord_fixed()+
  theme_classic()+ 
  theme(panel.background = element_rect(fill = NA, colour = "black", size = 1, linetype = "solid"))+
  labs(colour = "Treatment Type", shape = "Region")+ # add legend labels for Management and Landuse
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10)) # add legend at right of plot

nmds.plot.vegall + labs(title = "Basic ordination plot") #displays plot






nmds.plot.vegall+
  geom_segment(data = sig.spp.scrs, aes(x = 0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd=0.3) + #add vector arrows of significant species
  ggrepel::geom_text_repel(data = sig.spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+ #add labels for species, use ggrepel::geom_text_repel so that labels do not overlap
  labs(title = "Ordination with species vectors")

#maybe I should set a lower p value than 0.5? Set to 0.005, still too many - we'll also look per region-group analysis

nmds.plot.vegall+
  geom_segment(data = sig.env.scrs, aes(x = 0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd=0.3) + #add vector arrows of significant env variables
  ggrepel::geom_text_repel(data = sig.env.scrs, aes(x=NMDS1, y=NMDS2, label = env.variables), cex = 4, direction = "both", segment.size = 0.25)+ #add labels for env variables
  labs(title="Ordination with environmental vectors")


# checking out ellipses -------------------

# function for ellipsess 

veganCovEllipse <- function (cov, center = c(0, 0), scale = 1, npoints = 100) 
{
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}
 
#data for ellipse, in this case using the management factor
df_ell.region <- data.frame() #sets up a data frame before running the function.
 site.scores$Region <- as.factor(site.scores$Region)

for(i in levels(site.scores$Region)){
  df_ell.region <- rbind(df_ell.region, cbind(as.data.frame(with(site.scores [site.scores$Region==i,],
                                                         veganCovEllipse(cov.wt(cbind(NMDS1,NMDS2),wt=rep(1/length(NMDS1),length(NMDS1)))$cov,center=c(mean(NMDS1),mean(NMDS2))))) ,Region=i))
}
 

 
# data for labelling the ellipse
NMDS.mean.veg=aggregate(site.scores[ ,c("NMDS1", "NMDS2")], 
                         list(group = site.scores$Region), "mean")
 
# data for labelling the ellipse
NMDS.mean=aggregate(site.scores[,c("NMDS1", "NMDS2")], 
                    list(group = site.scores$Region), "mean")

nmds.plot.vegall+ 
geom_path(data = df_ell.region, aes(x = NMDS1, y = NMDS2, color = Region)) #this is the ellipse, seperate ones by Site.
```














### Plot outcome in ordiplot for quick visual
```{r, fig.align='center'}

ordiplot(test_2d, type = "t")
# looks like region is the reason behind grouping
```


### Going fancier with ggplot
```{r, fig.align='center'}
#plot 
fort<- fortify(test_2d)
ggplot() +
  geom_point(data = subset(fort, score =='sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             colour="black",
             alpha=0.5)+
  geom_segment(data = subset(fort, score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type="closed"),
               colour="darkgray",
               linewidth =0.8)+
  geom_text(data = subset(fort, score =='species'),
            mapping = aes(label=label, x=NMDS1*1.1, y=NMDS2*1.1))+
  geom_abline(intercept = 0,slope = 0,linetype="dashed", linewidth=0.8,colour="gray")+
  geom_vline(aes(xintercept=0), linetype="dashed", linewidth=0.8, colour="gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))




ggplot() +
  geom_point(data = subset(fort, score =='sites'),
             mapping = aes(x = NMDS1, y = NMDS2, color = meta.data_veg$Treat_Type),
             alpha=0.5)+
  geom_segment(data = subset(fort, score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type="closed"),
               colour="darkgray",
               linewidth =0.8)


ggplot() +
  geom_point(data = subset(fort, score =='sites'),
             mapping = aes(x = NMDS1, y = NMDS2, color = meta.data_veg$Region),
             alpha=0.75)+
  geom_segment(data = subset(fort, score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type="closed"),
               colour="darkgray",
               linewidth =0.8)+
  geom_text(data = subset(fort, score =='species'),
            mapping = aes(label=label, x=NMDS1*1.1, y=NMDS2*1.1))+
  geom_abline(intercept = 0,slope = 0,linetype="dashed", linewidth=0.8,colour="gray")+
  geom_vline(aes(xintercept=0), linetype="dashed", linewidth=0.8, colour="gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))

# region seems a pretty clear driver of understory composition. Can still run adonis tests etc on other values (permanova for treat or/and region)
```


### Run PerMANOVA to look at the impacts of region and treatment on community composition
```{r}
# to run PerMANOVA, there is an assumption of evenness across envr factor, therefore check

summary(meta.data_veg)

summary(as.factor(meta.data_veg$Treat_Type))
# 6 (harvest) - 12 (mowrx): 6, 9, 9, 11, 12

summary(as.factor(meta.data_veg$Region))
# 5 (ME) - 14 (MA): 5, 8, 9, 11, 14
```


### PerMANOVA by region
```{r}
per.region <- adonis2(rel_veg5 ~ Region, data = meta.data_veg)

print(per.region)
```


### PerMANOVA by treatment type
```{r}
per.tt <- adonis2(rel_veg5 ~ Treat_Type, data = meta.data_veg)

print(per.tt)
```












