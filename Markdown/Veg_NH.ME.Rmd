---
title: "NMDS on understory vegetation in Northern Barrens group (NH & ME)"
author: "Kathleen Stutzman"
date: "2024-02-23"
output: html_document
---

Libraries:
```{r, message=FALSE, warning=FALSE}
# libraries -------------------
library(ggplot2)
library(vegan)
library(ggvegan)
library(tidyverse)
library(ggordiplots)
```

Set working directory
```{r, setup}
knitr::opts_knit$set(root.dir = '/Users/user/Desktop/Data/Regen_RProj/')
```

Functions:
```{r}
# functions -------------------

```

#### Source, tranform, select, and relativize NH & ME veg data (hidden)
```{r, include=FALSE}
source("Scripts/Veg_Data.R")
rm(veg3)

#split overall data from veg cover
meta_nhme <- veg2 %>%
  filter(Region == c("NH", "ME")) %>% 
  select(Region, Treat_Type, Site, Plot_No) %>% 
  distinct(Plot_No, .keep_all = TRUE)

#pivot veg data wider and fill in zeros
nhme_wider <- veg2 %>% 
  filter(Region == c("NH", "ME")) %>% 
  select(Plot_No, Species_Code, SP_Cover_midpoint) %>% 
  group_by(Plot_No) %>% 
  pivot_wider(names_from = Species_Code, values_from = SP_Cover_midpoint, values_fill = 0) 

#create dataframe of site and plot
nhme_site <- veg2 %>% 
  filter(Region == c("NH", "ME")) %>% 
  select(Site, Plot_No) %>% 
  group_by(Site) %>% 
  distinct(Plot_No, .keep_all = TRUE)

# merge site and veg data; remove plot number
mer.nhme <- merge(nhme_site, nhme_wider, by = "Plot_No") %>% 
  select(-Plot_No)

# FIND WHAT IS 5% FOR THIS REGION-GROUP (~7 plots)

nhme_wider_log <- as.data.frame(lapply(nhme_wider, as.logical))

nh.me <- as.data.frame(colSums(nhme_wider_log)) %>% 
  rownames_to_column(var = "Species")

#THIS IS 7 plots or more
nhme_5PERC <- nhme_wider %>% 
  select(Plot_No,
         CAPE,
         VAAN,
         GAPR,
         QUIL,
         PTAQ,
         ACRU,
         KAAN,
         COPE,
         VAMY,
         MELI,
         ARME,
         LYBO,
         PIST,
         PIRI,
         MICA
         )

rm(nhme_wider_log, nh.me)

# add site and lose plot number -------------------
nhme5 <- merge(nhme_5PERC, nhme_site) %>% 
  select(-Plot_No) %>% 
  select(Site, everything())

nhme5_avg <- nhme5 %>% 
  group_by(Site) %>% 
  summarise_at(vars(CAPE:MICA), mean) %>% 
  column_to_rownames(var = "Site")

rm(nhme5, nhme_5PERC, mer.nhme)

# relativize data, dividing each cell by the column total (to bring common and rare species closer together) -------------------
rel_nhme5 <- decostand(nhme5_avg, method = 'total', MARGIN = 2)
```

Species found in at least 5% (7 plots) of plots in Northern Barrens are:
CAPE, VAAN, GAPR, QUIL, PTAQ, ACRU, KAAN, COPE, VAMY, MELI, ARME, LYBO, PIST, PIRI, & MICA


#### Source and transform envr & categorical data; merge for predictor df to compare nmds against (hidden)
```{r, include=FALSE}
time_since <- read_csv("CleanData/Treat_Year_Data.csv") # this is a dataframe with one row for each site

# make sure ggpubs not on, or this won't load
source("Scripts/Add_BA.R") #work on prism_BA, has total BA figures - do I need to change these as they were collected on a different scale?

nh.prism1 <- prism_BA %>% 
  select(Plot_No, BA_HA, PIRI.BA_HA)

nh.prism2 <- merge(nh.prism1, nhme_site, by = "Plot_No") %>% 
  select(-Plot_No) %>% 
  select(Site, everything())

nh.prism4veg <- nh.prism2 %>% 
  group_by(Site) %>% 
  summarise_at(vars(BA_HA:PIRI.BA_HA), mean)

rm(prism_BA, nh.prism1, nh.prism2)


source("Scripts/Ground_Data.R") #work on ground 3

nh.ground4 <- ground3 %>% 
  select(Plot_No, Lichen, Moss, Rock, Mineral_Soil, Wood, Litter_Duff, avgLD)

nh.ground5 <- merge(nh.ground4, nhme_site, by = "Plot_No") %>% 
  select(Site, everything()) %>% 
  select(-c(Plot_No))

nh.ground4veg <- nh.ground5 %>% 
  group_by(Site) %>% 
  summarise_at(vars(Lichen:avgLD), mean)

rm(ground3, nh.ground4, ground)

nh2 <- meta_nhme %>% 
  select(Region, Treat_Type, Site) %>% 
  distinct(Site, .keep_all = TRUE)

nhm1 <- merge(nh2, time_since, by = "Site")

nhm2 <- merge(nhm1, nh.ground4veg, by = "Site")

nh.meta.data_veg <- merge(nhm2, nh.prism4veg, by = "Site") %>% 
  select(-c(Inventory_Yr, Treat_Yr))


rm(nhm2, nhm1, time_since, nh.ground4veg, nh.prism4veg)

rm(prism, veg2)
```

### Run NMDS
```{r}
# 3 dimensions
# nhme_3d <- metaMDS(rel_nhme5,
#                    distance = 'bray',
#                    k = 3,
#                    trymax = 20,
#                    autotransform = FALSE)
# converges, stress of 0.095 - 0.11

# 2 dimensions
nhme_2d <- metaMDS(rel_nhme5, 
                   distance = 'bray', 
                   k = 2, 
                   trymax = 20,
                   autotransform = FALSE)
# this works and yields stress values of 0.15 - 0.22
```


### Make correlation data for bi-plots
```{r}
nh.veg_envr.data <- envfit(nhme_2d, nh.meta.data_veg)
nh.veg_spc.envr <- envfit(nhme_2d, rel_nhme5)

# site data -------------------
nh.site.scrs <- as.data.frame(scores(nhme_2d, display = "sites"))

nh.site.scrs <- cbind(nh.site.scrs, Treat_Type = nh.meta.data_veg$Treat_Type)
nh.site.scrs <- cbind(nh.site.scrs, Region = nh.meta.data_veg$Region)

# species data   -------------------
nh.spp.scrs <- as.data.frame(scores(nh.veg_spc.envr, display = "vectors"))
nh.spp.scrs <- cbind(nh.spp.scrs, Species = rownames(nh.spp.scrs))
nh.spp.scrs <- cbind(nh.spp.scrs, pval = nh.veg_spc.envr$vectors$pvals)

sign.nh_spp.scrs <- subset(nh.spp.scrs, pval<=0.05)

print(sign.nh_spp.scrs)

# create species vectors for indicator species -------------------

nh.indc.spp <- nh.spp.scrs %>% 
  filter(Species %in% c("COPE", "PIST"))

# envr data -------------------
nh.envr.scrs <- as.data.frame(scores(nh.veg_envr.data, display = "vectors"))
nh.envr.scrs <- cbind(nh.envr.scrs, env.variables = rownames(nh.envr.scrs))
nh.envr.scrs <- cbind(nh.envr.scrs, pval = nh.veg_envr.data$vectors$pvals)
nh.sig_envr.scrs <- subset(nh.envr.scrs, pval<=0.05)

print(nh.sig_envr.scrs)
```

#### Significant species are: VAAN, QUIL, ACRU, KAAN, COPE, MELI, & LYBO

#### Significant environmental factors are: average leaf litter depth

## GGPlot
```{r, fig.align='center'}

# I'd like the colors to represent the same treatment types across all regions, so I want to set a color vector to draw on. I'll need 5 colors - keep consistent with GLMMs?
colors = c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15")

# control = yellow, fallrx = dark green, harvest = beige, mowrx = light green, spring rx = red


# Can make an ellipse/hull plot and then pull out ellipse and/or hull data to feed into later ggplots
nh.plot.e <- gg_ordiplot(nhme_2d, groups = nh.meta.data_veg$Treat_Type)

hull <- fortify(nh.plot.e$df_hull) %>% 
  group_by(Group)

elipse <- fortify(nh.plot.e$df_ellipse) %>% 
  group_by(Group)

nh.nmds.plot <-  ggplot(nh.site.scrs, aes(x=NMDS1, y=NMDS2))+
  geom_point(aes(NMDS1, NMDS2, colour = factor(nh.site.scrs$Treat_Type), shape = factor(nh.site.scrs$Region)), size = 2)+
  scale_color_manual(values = c("#D8B70A", "#02401B", "#81A88D"))+
  coord_fixed()+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type", shape = "Region")+
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10))


nh.nmds.plot + 
  geom_path(data = elipse, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  labs(title = "Northern Barrens Ordination")+
  theme(plot.title=element_text(hjust=0.5, size=20))

# add significant species -------------------

nh.nmds.plot +
  geom_path(data = elipse, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = sign.nh_spp.scrs, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd = 0.3)+
  ggrepel::geom_text_repel(data = sign.nh_spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
  labs(title = "Northern Barrens Ordination \n with species vectors")+
  theme(plot.title=element_text(hjust=0.5, size=20))

# add indicators species -------------------

indc.sp.nh_color <- c("COPE" = "#81A88D", "PIST" = "#D8B70A")

nh.nmds.plot +
  geom_path(data = elipse, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = nh.indc.spp, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = indc.sp.nh_color, lwd = 0.75, show.legend = FALSE)+
  ggrepel::geom_text_repel(data = nh.indc.spp, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
  labs(title = "Northern Barrens Ordination \n with indicator species")+
  theme(plot.title=element_text(hjust=0.5, size=20))

# add significant envr factors -------------------

nh.nmds.plot +
  geom_path(data = elipse, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = nh.sig_envr.scrs, aes(x = 0, xend = NMDS1, y = 0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")))+
  ggrepel::geom_text_repel(data = nh.sig_envr.scrs, aes(x=NMDS1, y=NMDS2, label = env.variables), cex = 4, direction = "both", segment.size = 0.25) +
  labs(title = "Northern Barrens Ordination \n with environmental vectors")+
  theme(plot.title=element_text(hjust=0.5, size=20))
```



### Plot with significant species & envr factors
```{r, fig.align='center'}
nh.nmds.plot+
  geom_path(data = elipse, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = sign.nh_spp.scrs, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "purple", lwd = 0.3)+
  ggrepel::geom_text_repel(data = sign.nh_spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
  geom_segment(data = nh.sig_envr.scrs, aes(x = 0, xend = NMDS1, y = 0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")))+
  ggrepel::geom_text_repel(data = nh.sig_envr.scrs, aes(x=NMDS1, y=NMDS2, label = env.variables), cex = 4, direction = "both", segment.size = 0.25) +
  labs(title = "Northern Barrens Ordination with significant \n species & environmental factors") +
  theme(plot.title=element_text(hjust=0.5, size=20))

```




### Plot with indcator species & envr factors
```{r, fig.align='center'}
nh.nmds.plot+
  geom_path(data = elipse, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = nh.indc.spp, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = indc.sp.nh_color, lwd = 0.75, show.legend = FALSE)+
  ggrepel::geom_text_repel(data = nh.indc.spp, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
  geom_segment(data = nh.sig_envr.scrs, aes(x = 0, xend = NMDS1, y = 0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")))+
  ggrepel::geom_text_repel(data = nh.sig_envr.scrs, aes(x=NMDS1, y=NMDS2, label = env.variables), cex = 4, direction = "both", segment.size = 0.25) +
  labs(title = "Northern Barrens Ordination with indicator \n species & environmental factors")+
  theme(plot.title=element_text(hjust=0.5, size=20))
```





```{r, fig.align='center', fig.width=10, include = FALSE}
#plot 
fort.nh<- fortify(nhme_2d)


ggplot() +
  geom_point(data = subset(fort.nh, score =='sites'),
             mapping = aes(x = NMDS1, y = NMDS2, color = nh.meta.data_veg$Treat_Type),
             alpha=0.75)+
  geom_segment(data = subset(fort.nh, score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type="closed"),
               colour="darkgray",
               linewidth =0.8,
               alpha=0)+
  geom_text(data = subset(fort.nh, score =='species'),
            mapping = aes(label=label, x=NMDS1*1.1, y=NMDS2*1.1))+
  geom_abline(intercept = 0,slope = 0,linetype="dashed", linewidth=0.8,colour="gray")+
  geom_vline(aes(xintercept=0), linetype="dashed", linewidth=0.8, colour="gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.background = element_blank())

# seeing more grouping of treatment type - control with pist, acru, prse etc...
```

### Run PerMANOVA to look at the impacts of region and treatment on community composition
```{r}
summary(as.factor(nh.meta.data_veg$Treat_Type))
```


```{r, include=FALSE, eval=FALSE}
#first look
nh.tt <- adonis2(rel_nhme5 ~ Treat_Type, data = nh.meta.data_veg)

print(nh.tt)
# TT not significant; can see a grouping - what does this mean?
# Region is significant 

nh.r <- adonis2(rel_nhme5 ~ Region, data = nh.meta.data_veg)

print(nh.r)
#region not significant on it's own

nh.r <- adonis2(rel_nhme5 ~ Region + Treat_Type, data = nh.meta.data_veg)

print(nh.r) #now TT is signficant, that is was put in second position --- seems not good
```


### PerMANOVA for TT
```{r}
#create treated vs. untreated category
nh.meta.data_veg$Trt_Ctl <- ifelse((nh.meta.data_veg$Treat_Type != "Control"), 'treated', 'untreated')

nh.t_ut <- adonis2(rel_nhme5 ~Trt_Ctl, data = nh.meta.data_veg) 

print(nh.t_ut) # not significant

nh.t <- adonis2(rel_nhme5 ~ Treat_Type, data = nh.meta.data_veg) 

print(nh.t) # not significant

nh.rtt <- adonis2(rel_nhme5 ~ Region*Treat_Type, data = nh.meta.data_veg)

print(nh.rtt) #TT now significant, still changes with order of variables - maybe this is because mowing only exists in NH?

nh.rt_ut <- adonis2(rel_nhme5 ~ Trt_Ctl*Region, data = nh.meta.data_veg)

print(nh.rt_ut) #not significant (either order)

rm(nh.t, nh.t_ut, nh.rt_ut, nh.rtt)
```




### Pairwise analysis of treatment type
```{r, warning=FALSE, message=FALSE}
library(pairwiseAdonis)

pairwise.adonis2(rel_nhme5 ~ Treat_Type, data = nh.meta.data_veg)
# not significant - mow and fall rx almost closest, but not really, now that I've changed the species to reflect the region-group as opposed to the overall
```



### Indicator species analysis
Will want to run for each treatment type
```{r, warning=FALSE, message=FALSE}
library(labdsv)

# I don't think I should calculate this on relativized data, so : nhme5_avg & nh.meta.data_veg

#create group #s for treatments


nh.meta.data_veg$Treat_Group <- NA

nh.meta.data_veg$Treat_Group <- ifelse( nh.meta.data_veg$Treat_Type == "FallRx", 1, nh.meta.data_veg$Treat_Group)

nh.meta.data_veg$Treat_Group <- ifelse( nh.meta.data_veg$Treat_Type == "MowRx", 2, nh.meta.data_veg$Treat_Group)

nh.meta.data_veg$Treat_Group<- ifelse( nh.meta.data_veg$Treat_Type == "Control", 3, nh.meta.data_veg$Treat_Group)



# indicator species analysis
nhme_isa <- indval(nhme5_avg, nh.meta.data_veg$Treat_Group)


summary(nhme_isa)

gr <- nhme_isa$maxcls[nhme_isa$pval <= 0.05]
iv <- nhme_isa$indcls[nhme_isa$pval <= 0.05]
pv <- nhme_isa$pval[nhme_isa$pval <= 0.05]
fr <- apply(nhme5_avg > 0, 2, sum)[nhme_isa$pval <= 0.05]
fridg <- data.frame(group=gr, indval=iv, pvalue=pv, freq=fr)
fridg <- fridg[order(fridg$group, -fridg$indval),]

print(fridg)
# 1 is FallRx
# 2 is MowRx
# 3 is Control
```


#### NH_ME MowRx indicator : COPE
#### NH_ME Control indicator : PIST























