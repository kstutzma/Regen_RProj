---
title: "NMDS on understory vegetation in Coastal Barrens group (MA & LI)"
author: "Kathleen Stutzman"
date: "2024-02-26"
output: html_document
---

Libraries:
```{r, message=FALSE, warning=FALSE}
# libraries -------------------
library(ggplot2)
library(vegan)
library(ggvegan)
library(tidyverse)
library(ggordiplots)
```

Set working directory
```{r, setup}
knitr::opts_knit$set(root.dir = '/Users/user/Desktop/Data/Regen_RProj/')
```

Functions:
```{r}
# functions -------------------

```


#### Source, tranform, select, and relativize MA & LI veg data (hidden)
```{r, include=FALSE}
source("Scripts/Veg_Data.R")
rm(veg3)

#split overall data from veg cover
meta_mali <- veg2 %>%
  filter(Region == c("MA", "LI")) %>% 
  select(Region, Treat_Type, Site, Plot_No) %>% 
  distinct(Plot_No, .keep_all = TRUE)

#pivot veg data wider and fill in zeros
mali_wider <- veg2 %>% 
  filter(Region == c("MA", "LI")) %>% 
  select(Plot_No, Species_Code, SP_Cover_midpoint) %>% 
  group_by(Plot_No) %>% 
  pivot_wider(names_from = Species_Code, values_from = SP_Cover_midpoint, values_fill = 0) 

#create dataframe of site and plot
mali_site <- veg2 %>% 
  filter(Region == c("MA", "LI")) %>% 
  select(Site, Plot_No) %>% 
  group_by(Site) %>% 
  distinct(Plot_No, .keep_all = TRUE)

# merge site and veg data; remove plot number
mer.mali <- merge(mali_site, mali_wider, by = "Plot_No") %>% 
  select(-Plot_No)

mali_wider_log <- as.data.frame(lapply(mali_wider, as.logical))

ma.li <- as.data.frame(colSums(mali_wider_log)) %>% 
  rownames_to_column(var = "Species")



#THIS IS 11 plots or more
mali_5PERC <- mali_wider %>% 
  select(Plot_No,
         VAPA,
         GABA,
         QUIL,
         GAPR,
         VAAN,
         PTAQ,
         QUCO,
         PIRI,
         KAAN,
         MELI,
         RUSP,
         CAPE,
         QUAL,
         SMGL,
         QUPR
         )

rm(mali_wider_log, ma.li)

# add site and lose plot number -------------------
mali5 <- merge(mali_5PERC, mali_site) %>% 
  select(-Plot_No) %>% 
  select(Site, everything())

mali5_avg <- mali5 %>% 
  group_by(Site) %>% 
  summarise_at(vars(VAPA:QUPR), mean) %>% 
  column_to_rownames(var = "Site")

rm(mali5, mali_5PERC, mer.mali)

# relativize data, dividing each cell by the column total (to bring common and rare species closer together) -------------------
rel_mali5 <- decostand(mali5_avg, method = 'total', MARGIN = 2)
```

Species found in at least 5% (11 plots) of plots in Coastal Barrens are:
VAPA, GABA, QUIL, GAPR, VAAN, PTAQ, QUCO, PIRI, KAAN, MELI, RUSP, CAPE, QUAL, SMGL, & QUPR



#### Source and transform envr & categorical data; merge for predictor df to compare nmds against (hidden)
```{r, include=FALSE}
time_since <- read_csv("CleanData/Treat_Year_Data.csv") # this is a dataframe with one row for each site

# make sure ggpubs not on, or this won't load
source("Scripts/Add_BA.R") #work on prism_BA, has total BA figures - do I need to change these as they were collected on a different scale?

ma.prism1 <- prism_BA %>% 
  select(Plot_No, BA_HA, PIRI.BA_HA)

ma.prism2 <- merge(ma.prism1, mali_site, by = "Plot_No") %>% 
  select(-Plot_No) %>% 
  select(Site, everything())

ma.prism4veg <- ma.prism2 %>% 
  group_by(Site) %>% 
  summarise_at(vars(BA_HA:PIRI.BA_HA), mean)

rm(prism_BA, ma.prism1, ma.prism2)


source("Scripts/Ground_Data.R") #work on ground 3

ma.ground4 <- ground3 %>% 
  select(Plot_No, Lichen, Moss, Rock, Mineral_Soil, Wood, Litter_Duff, avgLD)

ma.ground5 <- merge(ma.ground4, mali_site, by = "Plot_No") %>% 
  select(Site, everything()) %>% 
  select(-c(Plot_No))

ma.ground4veg <- ma.ground5 %>% 
  group_by(Site) %>% 
  summarise_at(vars(Lichen:avgLD), mean)

rm(ground3, ma.ground4, ground)

ma2 <- meta_mali %>% 
  select(Region, Treat_Type, Site) %>% 
  distinct(Site, .keep_all = TRUE)

mam1 <- merge(ma2, time_since, by = "Site")

mam2 <- merge(mam1, ma.ground4veg, by = "Site")

ma.meta.data_veg <- merge(mam2, ma.prism4veg, by = "Site") %>% 
  select(-c(Inventory_Yr, Treat_Yr))


rm(mam2, mam1, time_since, ma.ground4veg, ma.prism4veg)

rm(prism, veg2)
```

### Run NMDS
```{r}
# 3 dimensions
mali_3d <- metaMDS(rel_mali5,
                   distance = 'bray',
                   k = 3,
                   trymax = 20,
                   autotransform = FALSE)
# converges, stress of 0.127 - 0.128

set.seed(2)
# 2 dimensions
mali_2d <- metaMDS(rel_mali5, 
                   distance = 'bray', 
                   k = 2,
                   try = 40,
                   trymax = 40,
                   autotransform = FALSE)
# stress still too high to represent in 2 dimensions, lowest is ~ 0.2

rm(mali_2d)
```


### Make correlation data for bi-plots
```{r}
ma.veg_enr <- envfit(mali_3d, ma.meta.data_veg)
ma.veg_spc.envr <- envfit(mali_3d, rel_mali5)

# site data -------------------
ma.site.scrs <- as.data.frame(scores(mali_3d, display = "sites"))

ma.site.scrs <- cbind(ma.site.scrs, Treat_Type = ma.meta.data_veg$Treat_Type)
ma.site.scrs <- cbind(ma.site.scrs, Region = ma.meta.data_veg$Region)

# species data   -------------------
ma.spp.scrs <- as.data.frame(scores(ma.veg_spc.envr, display = "vectors"))
ma.spp.scrs <- cbind(ma.spp.scrs, Species = rownames(ma.spp.scrs))
ma.spp.scrs <- cbind(ma.spp.scrs, pval = ma.veg_spc.envr$vectors$pvals)

sig.ma_spp.scrs <- subset(ma.spp.scrs, pval<=0.05)

print(sig.ma_spp.scrs)

# create species vectors for indicator species -------------------
mali.ind.spp <- ma.spp.scrs %>% 
  filter(Species %in% c('QUPR', "KAAN", "RUSP", "SMGL"))

# envr data -------------------
ma.envr.scrs <- as.data.frame(scores(ma.veg_enr, display = "vectors"))
ma.envr.scrs <- cbind(ma.envr.scrs, env.variables = rownames(ma.envr.scrs))
ma.envr.scrs <- cbind(ma.envr.scrs, pval = ma.veg_enr$vectors$pvals)
ma.sig_envr.scrs <- subset(ma.envr.scrs, pval<=0.05)

print(ma.sig_envr.scrs)

ma.sig_envr.scrs <- ma.sig_envr.scrs %>% 
  filter(env.variables != "BA_HA")
```

#### Significant species are: GAPR, VAAN, QUCO, PIRI, KAAN, MELI, RUSP, SMGL, QUPR

#### Significant environmental factors are: Moss, Basal area per hectare, and PIRI basal area per hectare. 
I'm only going to keep one BA measure; PIRI has a lower p value, so thinking that one, but open to other ideas.

## This is a 3D ordination being represented by 2D
Using the first two axes, which represent the most variation in the ordination space

```{r, message=FALSE, fig.align='center'}
library(plotly)

fort.mali3 <- fortify(mali_3d) %>% 
  filter(score == "sites")

plot_ly(x = fort.mali3$NMDS1, y = fort.mali3$NMDS2, z= fort.mali3$NMDS3, type = "scatter3d", mode = "markers", color = ma.meta.data_veg$Treat_Type, )
# Here is a 3D plot, just to show

stressplot(mali_3d)

ordicloud(mali_3d)
```


## GG plot
```{r, fig.align='center'}
# based on the idea that NMDS scores express the highest variation in first axis and on down, I will plot the 1st two and take a look -------------------
# control = yellow, fallrx = dark green, harvest = beige, mowrx = light green, spring rx = red

colors = c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15")

# create ellipse plot -------------------
mali.plot.e <- gg_ordiplot(mali_3d, groups = ma.meta.data_veg$Treat_Type)

# pull out ellipse data -------------------
ellipse.mali <- fortify(mali.plot.e$df_ellipse) %>% 
  group_by(Group)

# base plot -------------------
ma.nmds.plot <-  ggplot(ma.site.scrs, aes(x=NMDS1, y=NMDS2))+
  geom_point(aes(NMDS1, NMDS2, colour = factor(ma.site.scrs$Treat_Type), shape = factor(ma.site.scrs$Region)), size = 2)+
  scale_color_manual(values =  c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  coord_fixed()+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type", shape = "Region")+
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10))

# plot with ellipse -------------------
ma.nmds.plot + 
  geom_path(data = ellipse.mali, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  labs(title = "Coastal barrens ordination \n (Axes 1 & 2")+
  theme(plot.title=element_text(hjust=0.5, size=20))

# add significant species -------------------
ma.nmds.plot +
  geom_path(data = ellipse.mali, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = sig.ma_spp.scrs, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd = 0.3)+
  ggrepel::geom_text_repel(data = sig.ma_spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
  labs(title = "Coastal barrens ordination with \n significant species (Axes 1 & 2)")+
  theme(plot.title=element_text(hjust=0.5, size=20))

# add indicators species -------------------
ind.sp.mali_color <- c("QUPR" = "#81A88D", "KAAN" = "#81A88D", "SMGL" = "#A2A475", "RUSP" = "#81A88D")

ma.nmds.plot +
  geom_path(data = ellipse.mali, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = mali.ind.spp, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = ind.sp.mali_color, lwd = 0.75)+
  ggrepel::geom_text_repel(data = mali.ind.spp, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
  labs(title = "Coastal barrens ordination with \n indicator species (Axes 1 & 2)")+
  theme(plot.title=element_text(hjust=0.5, size=20))

# add significant envr factors -------------------

ma.nmds.plot +
  geom_path(data = ellipse.mali, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = ma.sig_envr.scrs, aes(x = 0, xend = NMDS1, y = 0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")))+
  ggrepel::geom_text_repel(data = ma.sig_envr.scrs, aes(x=NMDS1, y=NMDS2, label = env.variables), cex = 4, direction = "both", segment.size = 0.25) +
  labs(title = "Coastal barrens ordination with \n environmental vectors (Axes 1 & 2)")+
  theme(plot.title=element_text(hjust=0.5, size=20))
```

### Plot with significant species & envr factors
```{r, fig.align='center'}
ma.nmds.plot +
  geom_path(data = ellipse.mali, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = sig.ma_spp.scrs, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd = 0.3)+
  ggrepel::geom_text_repel(data = sig.ma_spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
  geom_segment(data = mali.ind.spp, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = ind.sp.mali_color, lwd = 0.75)+
  ggrepel::geom_text_repel(data = mali.ind.spp, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
  labs(title = "Coastal barrens ordination with significant \n species & environmental factors (Axes 1 & 2)")+
  theme(plot.title=element_text(hjust=0.5, size=20))
```

### Plot with indcator species & envr factors
```{r, fig.align='center'}
ma.nmds.plot +
  geom_path(data = ellipse.mali, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = mali.ind.spp, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = ind.sp.mali_color, lwd = 0.75)+
  ggrepel::geom_text_repel(data = mali.ind.spp, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
  geom_segment(data = ma.sig_envr.scrs, aes(x = 0, xend = NMDS1, y = 0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")))+
  ggrepel::geom_text_repel(data = ma.sig_envr.scrs, aes(x=NMDS1, y=NMDS2, label = env.variables), cex = 4, direction = "both", segment.size = 0.25) +
  labs(title = "Coastal barrens ordination with indicator \n species & environmental factors (Axes 1 & 2)")+
  theme(plot.title=element_text(hjust=0.5, size=20))
```



### Run PerMANOVA to look at the impacts of region and treatment on community composition
```{r}
summary(as.factor(ma.meta.data_veg$Treat_Type))
```

```{r}
ma.tt <- adonis2(rel_mali5 ~ Treat_Type, data = ma.meta.data_veg)

print(ma.tt)
```



### Pairwise follow up
```{r, warning=FALSE, message=FALSE}
library(pairwiseAdonis)

pairwise.adonis2(rel_mali5 ~ Treat_Type, data = ma.meta.data_veg)

#significant: SpringRx vs. MowRx; SpringRx vs. Harvest (borderline at 0.051); MowRx vs. Harvest; MowRx vs Control; Harvest vs Control
```

### Indicator species analysis
```{r, warning=FALSE, message=FALSE}
library(labdsv)

ma.meta.data_veg$Treat_Group <- NA

ma.meta.data_veg$Treat_Group <- ifelse( ma.meta.data_veg$Treat_Type == "FallRx", 1, ma.meta.data_veg$Treat_Group)

ma.meta.data_veg$Treat_Group <- ifelse( ma.meta.data_veg$Treat_Type == "MowRx", 2, ma.meta.data_veg$Treat_Group)

ma.meta.data_veg$Treat_Group<- ifelse( ma.meta.data_veg$Treat_Type == "SpringRx", 3, ma.meta.data_veg$Treat_Group)

ma.meta.data_veg$Treat_Group<- ifelse( ma.meta.data_veg$Treat_Type == "Harvest", 4, ma.meta.data_veg$Treat_Group)

ma.meta.data_veg$Treat_Group<- ifelse( ma.meta.data_veg$Treat_Type == "Control", 5, ma.meta.data_veg$Treat_Group)

mali_isa <- indval(mali5_avg, ma.meta.data_veg$Treat_Group)

summary(mali_isa)


gr <- mali_isa$maxcls[mali_isa$pval <= 0.05]
iv <- mali_isa$indcls[mali_isa$pval <= 0.05]
pv <- mali_isa$pval[mali_isa$pval <= 0.05]
fr <- apply(mali5_avg > 0, 2, sum)[mali_isa$pval <= 0.05]
fridg <- data.frame(group=gr, indval=iv, pvalue=pv, freq=fr)
fridg <- fridg[order(fridg$group, -fridg$indval),]

print(fridg)
# 1 is FallRx
# 2 is MowRx
# 3 is SpringRx
# 4 is Harvest
# 5 is Control
```

### MA_LI MowRx indicators: QUPR, KAAN, RUSP
### MA_LI Harvest indicator: SMGL

















