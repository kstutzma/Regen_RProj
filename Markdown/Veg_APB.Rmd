---
title: "NMDS on understory vegetation in Inland Barrens group (APB)"
author: "Kathleen Stutzman"
date: "2024-02-26"
output: html_document
---

Libraries:
```{r, message=FALSE, warning=FALSE}
# libraries -------------------
library(ggplot2)
library(vegan)
library(ggvegan)
library(tidyverse)
library(ggordiplots)
```

Set working directory
```{r, setup}
knitr::opts_knit$set(root.dir = '/Users/user/Desktop/Data/Regen_RProj/')
```

Functions:
```{r}
# functions -------------------
```

#### Source, tranform, select, and relativize ALB veg data (hidden)
```{r, include=FALSE}
source("Scripts/Veg_Data.R")
rm(veg3)

#split overall data from veg cover
meta_apb <- veg2 %>%
  filter(Region == "ALB") %>% 
  select(Region, Treat_Type, Site, Plot_No) %>% 
  distinct(Plot_No, .keep_all = TRUE)

#pivot veg data wider and fill in zeros
apb_wider <- veg2 %>% 
  filter(Region == c("ALB")) %>% 
  select(Plot_No, Species_Code, SP_Cover_midpoint) %>% 
  group_by(Plot_No) %>% 
  pivot_wider(names_from = Species_Code, values_from = SP_Cover_midpoint, values_fill = 0) 

#create dataframe of site and plot
apb_site <- veg2 %>% 
  filter(Region == c("ALB")) %>% 
  select(Site, Plot_No) %>% 
  group_by(Site) %>% 
  distinct(Plot_No, .keep_all = TRUE)

# merge site and veg data; remove plot number
mer.apb <- merge(apb_site, apb_wider, by = "Plot_No") %>% 
  select(-Plot_No)

# Find what is 5% for this region-group (~6 plots)
apb_log_wider <- as.data.frame(lapply(apb_wider, as.logical))

apb <- as.data.frame(colSums(apb_log_wider)) %>% 
  rownames_to_column(var = "Species")


#THIS IS 6 plots or more
apb_5PER <- apb_wider %>% 
  select(Plot_No,
         RUSP,
         CAPE,
         LYQU,
         CEOR,
         QUIL,
         PTAQ,
         VAPA,
         PAQU,
         CEAM,
         ACRU,
         GABA,
         PRSE,
         RHGL,
         POUN11,
         QUPR,
         FRSP,
         COPE,
         LOSP,
         PIRI,
         SORU,
         VIDE,
         COAM,
         CICA,
         SOUN1,
         MELI,
         MICA,
         COSP,
         ARME,
         FRAL,
         ARNU,
         QUCO, 
         LUPE,
         AMSP,
         RHHI,
         VAAN,
         SOUN2)

names(apb_5PER)[names(apb_5PER) == "POUN11"] <- "DIAC"
names(apb_5PER)[names(apb_5PER) == "SOUN1"] <- "SOAL"
names(apb_5PER)[names(apb_5PER) == "SOUN2"] <- "SOJU"

rm(apb_log_wider, apb)

# add site and lose plot number -------------------
apb5 <- merge(apb_5PER, apb_site) %>% 
  select(-Plot_No) %>% 
  select(Site, everything())

apb5_avg <- apb5 %>% 
  group_by(Site) %>% 
  summarise_at(vars(RUSP:SOJU), mean) %>% 
  column_to_rownames(var = "Site")

rm(apb5, apb_5PER, mer.apb)

# relativize data, dividing each cell by the column total (to bring common and rare species closer together) -------------------
rel_apb5 <- decostand(apb5_avg, method = 'total', MARGIN = 2)
```

Species found in at least 5% (6 plots) of plots in Inland Barrens are:
RUSP, CAPE, LYQU, CEOR, QUIL, PTAQ, VAPA, PAQU, CEAM, ACRU, GABA, PRSE, RHGL, DIAC, QUPR, FRSP, COPE, LOSP, PIRI, SORU, VIDE, COAM, CICA, SOAL, MELI, MICA, COSP, ARME, FRAL, ARNU, QUCO, LUPE, AMSP, RHHI, VAAN, SOJU


#### Source and transform envr & categorical data; merge for predictor df to compare nmds against (hidden)
```{r, include=FALSE, message=FALSE}
time_since <- read_csv("CleanData/Treat_Year_Data.csv") # this is a dataframe with one row for each site

# make sure ggpubs not on, or this won't load
source("Scripts/Add_BA.R") #work on prism_BA, has total BA figures - do I need to change these as they were collected on a different scale?

APB.PRISM1 <- prism_BA %>% 
  select(Plot_No, BA_HA, PIRI.BA_HA)

apb.prism2 <- merge(APB.PRISM1, apb_site, by = "Plot_No") %>% 
  select(-Plot_No) %>% 
  select(Site, everything())

apb.prism4veg <- apb.prism2 %>% 
  group_by(Site) %>% 
  summarise_at(vars(BA_HA:PIRI.BA_HA), mean)

rm(prism_BA, APB.PRISM1, apb.prism2)


source("Scripts/Ground_Data.R") #work on ground 3

apb.ground4 <- ground3 %>% 
  select(Plot_No, 
         Lichen, 
         Moss, 
         #Rock, 
         Mineral_Soil, 
         Wood, 
         Litter_Duff, 
         avgLD)
#I am removing rock here, as it wasn't encoutered at all and I think it is causing problems in my envfit calculations down the line

apb.ground5 <- merge(apb.ground4, apb_site, by = "Plot_No") %>% 
  select(Site, everything()) %>% 
  select(-c(Plot_No))

apb.ground4veg <- apb.ground5 %>% 
  group_by(Site) %>% 
  summarise_at(vars(Lichen:avgLD), mean)

rm(ground3, apb.ground4, ground)

apb2 <- meta_apb %>% 
  select(Region, Treat_Type, Site) %>% 
  distinct(Site, .keep_all = TRUE)

apbm1 <- merge(apb2, time_since, by = "Site")

apbm2 <- merge(apbm1, apb.ground4veg, by = "Site")

apb.meta_for.veg <- merge(apbm2, apb.prism4veg, by = "Site") %>% 
  select(-c(Inventory_Yr, Treat_Yr))


rm(apbm2, apbm1, time_since, apb.ground4veg, apb.prism4veg)

rm(prism, veg2)
```

### Run NMDS
```{r}
# 3 dimensions
# apb_3d <- metaMDS(rel_apb5,
#                    distance = 'bray',
#                    k = 3,
#                    trymax = 20,
#                    autotransform = FALSE)
# converges, stress of 0.06 - 0.1

# 2 dimensions
apb_2d <- metaMDS(rel_apb5, 
                   distance = 'bray', 
                   k = 2, 
                   trymax = 20,
                   autotransform = FALSE)
# this works and yields stress values of 0.12 - 0.25
#rm(apb_3d)
```



```{r, include=FALSE}
#what would it mean to drop control from this figure and see if that solves the rank deficiency issue?

ctr_test <-  rel_apb5 %>% 
  rownames_to_column(var = "Site") %>% 
  filter(Site != ("APB_Hippo")) %>% 
  filter(Site != ("APB_Hydro")) %>% 
  column_to_rownames(var = "Site") %>% 
  select(-VIDE)


ctrtst_2D <- metaMDS(ctr_test, 
                   distance = 'bray', 
                   k = 2, 
                   trymax = 20,
                   autotransform = FALSE)

ctrtst.meta <-  apb.meta_for.veg %>% 
  filter(Site != ("APB_Hippo")) %>% 
  filter(Site != ("APB_Hydro"))

envr.data <- envfit(ctrtst_2D, ctrtst.meta) #was getting a big error; rock was in data set but with 0 values across the board. removed rock and solved warning

# this is how I figured it out 
# apb.veg_envr.data$vectors


tst.spc.envr <- envfit(ctrtst_2D, ctr_test)


# site data -------------------
test.site.scr <- as.data.frame(scores(ctrtst_2D, display = "sites"))

test.site.scr <- cbind(test.site.scr , Treat_Type = ctrtst.meta$Treat_Type)

# species data   -------------------
tst.spp.scrs <- as.data.frame(scores(tst.spc.envr, display = "vectors"))
tst.spp.scrs <- cbind(tst.spp.scrs, Species = rownames(tst.spp.scrs))
tst.spp.scrs <- cbind(tst.spp.scrs, pval = tst.spc.envr$vectors$pvals)

sig.apb_spp.scrs <- subset(tst.spp.scrs, pval<=0.05)


# envr data -------------------
tst.enrv.scrs <- as.data.frame(scores(tst.spc.envr, display = "vectors"))
tst.enrv.scrs <- cbind(tst.enrv.scrs, env.variables = rownames(tst.enrv.scrs))
tst.enrv.scrs <- cbind(tst.enrv.scrs, pval = tst.spc.envr$vectors$pvals)

apb.sig_envr.scrs <- subset(tst.enrv.scrs, pval<=0.05)


# Time from treatment is technically significant, but I don't think it really adds to the graph, so I'm going to drop it

apb.sig_envr.scrs <-  apb.sig_envr.scrs %>% 
  filter(env.variables == "BA_HA")

library(ggordiplots)

# get ellipse plot info sans control -------------------
tst.plot.e <- gg_ordiplot(ctrtst_2D, groups = ctrtst.meta$Treat_Type, ellipse = TRUE)

ellipse.apb <- fortify(tst.plot.e$df_ellipse)

gg_ordiplot(ctrtst_2D, groups = ctrtst.meta$Treat_Type, extra_width == FALSE)
```


### Make correlation data for bi-plots
```{r, echo=FALSE}
apb.veg_envr.data <- envfit(apb_2d, apb.meta_for.veg) #was getting a big error; rock was in data set but with 0 values across the board. removed rock and solved warning

# this is how I figured it out 
# apb.veg_envr.data$vectors


apb.veg_spc.envr <- envfit(apb_2d, rel_apb5)


# site data -------------------
apb.site.scrs <- as.data.frame(scores(apb_2d, display = "sites"))

apb.site.scrs <- cbind(apb.site.scrs , Treat_Type = apb.meta_for.veg$Treat_Type)

# species data   -------------------
apb.spp.scrs <- as.data.frame(scores(apb.veg_spc.envr, display = "vectors"))
apb.spp.scrs <- cbind(apb.spp.scrs, Species = rownames(apb.spp.scrs))
apb.spp.scrs <- cbind(apb.spp.scrs, pval = apb.veg_spc.envr$vectors$pvals)

sig.apb_spp.scrs <- subset(apb.spp.scrs, pval<=0.05)

print(sig.apb_spp.scrs)

# create species vectors for indicator species -------------------
apb.ind.spp <- apb.spp.scrs %>% 
  filter(Species %in% c("QUIL", "VIDE", "MICA", "PRSE"))

# envr data -------------------
apb.enr.scrs <- as.data.frame(scores(apb.veg_envr.data, display = "vectors"))
apb.enr.scrs <- cbind(apb.enr.scrs, env.variables = rownames(apb.enr.scrs))
apb.enr.scrs <- cbind(apb.enr.scrs, pval = apb.veg_envr.data$vectors$pvals)

apb.sig_envr.scrs <- subset(apb.enr.scrs, pval<=0.05)

print(apb.sig_envr.scrs)

# Time from treatment is technically significant, but I don't think it really adds to the graph, so I'm going to drop it

apb.sig_envr.scrs <-  apb.sig_envr.scrs %>% 
  filter(env.variables == "BA_HA")
```

#### Significant species are: QUIL, PAQU, GABA, RHGL, VIDE, CICA, MICA, COSP, FRAL, & ARNU


#### Add common names
```{r}
sig.apb_spp.scrs$common <- NA
sig.apb_spp.scrs$common <- ifelse(sig.apb_spp.scrs$Species == "RUSP",  "raspberry spp.", sig.apb_spp.scrs$common)
sig.apb_spp.scrs$common <- ifelse(sig.apb_spp.scrs$Species == "QUIL",  "scrub oak", sig.apb_spp.scrs$common)
sig.apb_spp.scrs$common <- ifelse(sig.apb_spp.scrs$Species == "PAQU",  "Virginia creeper", sig.apb_spp.scrs$common)
sig.apb_spp.scrs$common <- ifelse(sig.apb_spp.scrs$Species == "GABA",  "huckleberry", sig.apb_spp.scrs$common)
sig.apb_spp.scrs$common <- ifelse(sig.apb_spp.scrs$Species == "RHGL",  "smooth sumac", sig.apb_spp.scrs$common)
sig.apb_spp.scrs$common <- ifelse(sig.apb_spp.scrs$Species == "VIDE",  "arrowwood viburnum", sig.apb_spp.scrs$common)
sig.apb_spp.scrs$common <- ifelse(sig.apb_spp.scrs$Species == "CICA",  "enchanter's-nightshade", sig.apb_spp.scrs$common)
sig.apb_spp.scrs$common <- ifelse(sig.apb_spp.scrs$Species == "MICA",  "Canada mayflower", sig.apb_spp.scrs$common)
sig.apb_spp.scrs$common <- ifelse(sig.apb_spp.scrs$Species == "FRAL",  "glossy buckthorn", sig.apb_spp.scrs$common)
sig.apb_spp.scrs$common <- ifelse(sig.apb_spp.scrs$Species == "ARNU",  "sarsaparilla", sig.apb_spp.scrs$common)




apb.sig_envr.scrs$common <- "Basal area per hectare"
```


#### Significant environmental factors are: BASAL AREA PER HECTARE (and time from treatment)


## GGPlot
```{r, fig.align='center', include=FALSE}
# control = yellow, fallrx = dark green, harvest = beige, mowrx = light green, spring rx = red

colors = c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15")

# base plot -------------------
apb.nmds.plot <-  ggplot(apb.site.scrs, aes(x=NMDS1, y=NMDS2))+
  geom_point(aes(NMDS1, NMDS2, colour = factor(Treat_Type)), size = 2)+
  scale_color_manual(values = c("#D8B70A", "#81A88D", "#972D15"))+
  coord_fixed()+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type", shape = "Region")+
  theme(legend.position = "right", legend.text = element_text(size = 14), legend.title = element_text(size = 16), axis.text = element_text(size = 14))

# plot with ellipse -------------------
apb.nmds.plot + 
  geom_path(data = ellipse.apb, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  labs(title = "Inland Barrens Ordination")+
  theme(plot.title=element_text(hjust=0.5, size=20))

# add significant species -------------------
apb.nmds.plot +
  geom_path(data = ellipse.apb, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = sig.apb_spp.scrs, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd = 0.3)+
  ggrepel::geom_text_repel(data = sig.apb_spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
  labs(title = "Inland Barrens Ordination with significant species") +
  theme(plot.title=element_text(hjust=0.5, size=20))

# add indicators species -------------------

ind.sp.apb_color <- c("QUIL" = "#81A88D", "VIDE" = "#D8B70A", "MICA" = "#D8B70A", "PRSE" = "#D8B70A")

apb.nmds.plot +
  geom_path(data = ellipse.apb, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = apb.ind.spp, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = ind.sp.apb_color, lwd = 0.75, show.legend = FALSE)+
  ggrepel::geom_text_repel(data = apb.ind.spp, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
  labs(title = "Inland Barrens Ordination \n with indicator species") +
  theme(plot.title=element_text(hjust=0.5, size=20))

# add significant envr factors -------------------
apb.nmds.plot +
    geom_path(data = ellipse.apb, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = apb.sig_envr.scrs, aes(x = 0, xend = NMDS1, y = 0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")))+
  ggrepel::geom_text_repel(data = apb.sig_envr.scrs, aes(x=NMDS1, y=NMDS2, label = env.variables), cex = 4, direction = "both", segment.size = 0.25) +
  labs(title = "Inland Barrens Ordination \n with environmental vectors")
```





### Plot with significant species & envr factors
```{r, fig.align='center', echo=FALSE}
apb.nmds.plot +
  geom_path(data = ellipse.apb, aes(x=x, y=y, color=Group),  linejoin = "round", lwd = 1.25, show.legend = FALSE)+
  geom_segment(data = sig.apb_spp.scrs, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd = 0.4)+
  ggrepel::geom_text_repel(data = sig.apb_spp.scrs, aes(x=NMDS1, y=NMDS2, label = common, size = wt), cex = 3.25, direction = "both", segment.size = 0.25)+
  geom_segment(data = apb.sig_envr.scrs, aes(x = 0, xend = NMDS1, y = 0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), lwd = 1)+
  ggrepel::geom_text_repel(data = apb.sig_envr.scrs, aes(x=NMDS1, y=NMDS2, label = common), cex = 4, direction = "both", segment.size = 0.25, force = 10)

ggsave(filename = "APB_NMDS_sigspp.tiff", path = "Plots/NMDS", width = 8.5, height = 6, device = "tiff", dpi = 700)
  
```

### Plot with indcator species & envr factors
```{r, echo=FALSE, fig.align='center'}
apb.nmds.plot +
  geom_path(data = ellipse.apb, aes(x=x, y=y, color=Group),  linejoin = "round", show.legend = FALSE)+
  geom_segment(data = apb.ind.spp, aes(x=0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = ind.sp.apb_color, lwd = 0.75, show.legend = FALSE)+
  ggrepel::geom_text_repel(data = apb.ind.spp, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+
  geom_segment(data = apb.sig_envr.scrs, aes(x = 0, xend = NMDS1, y = 0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")))+
  ggrepel::geom_text_repel(data = apb.sig_envr.scrs, aes(x=NMDS1, y=NMDS2, label = env.variables), cex = 4, direction = "both", segment.size = 0.25) +
  labs(title = "Inland Barrens Ordination with indicator \n species & environmental factors") +
  theme(plot.title=element_text(hjust=0.5, size=20))
```



### Run PerMANOVA to look at the impacts of region and treatment on community composition
```{r}
summary(as.factor(apb.meta_for.veg$Treat_Type))
```


```{r}
adonis2(rel_apb5~Treat_Type, data = apb.meta_for.veg)
```
this changes with each run; from 0.04 - 0.06


### Pairwise analysis of treatment type
```{r, message=FALSE, warning=FALSE}
library(pairwiseAdonis)

pairwise.adonis2(rel_apb5 ~ Treat_Type, data = apb.meta_for.veg)
```


#### MowRx significantly different from Control





### Indicator species analysis
```{r, warning=FALSE, message=FALSE}
library(labdsv)

apb.meta_for.veg$Treat_Group <- NA

apb.meta_for.veg$Treat_Group <- ifelse( apb.meta_for.veg$Treat_Type == "SpringRx", 1, apb.meta_for.veg$Treat_Group)

apb.meta_for.veg$Treat_Group <- ifelse( apb.meta_for.veg$Treat_Type == "MowRx", 2, apb.meta_for.veg$Treat_Group)

apb.meta_for.veg$Treat_Group<- ifelse( apb.meta_for.veg$Treat_Type == "Control", 3, apb.meta_for.veg$Treat_Group)


apb_isa <- indval(apb5_avg, apb.meta_for.veg$Treat_Group)

summary(apb_isa)


gr <- apb_isa$maxcls[apb_isa$pval <= 0.05]
iv <- apb_isa$indcls[apb_isa$pval <= 0.05]
pv <- apb_isa$pval[apb_isa$pval <= 0.05]
fr <- apply(apb5_avg > 0, 2, sum)[apb_isa$pval <= 0.05]
fridg <- data.frame(group=gr, indval=iv, pvalue=pv, freq=fr)
fridg <- fridg[order(fridg$group, -fridg$indval),]

print(fridg)
# 1 is SpringRx
# 2 is MowRx
# 3 is Control
```

### APB MowRx indicator: QUIL
### APB Control indicators: VIDE, MICA, & PRSE











