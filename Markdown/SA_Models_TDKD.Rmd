---
title: "Sapling models for Tony & Kevin"
author: "Kathleen Stutzman"
date: "2024-01-26"
output: html_document
---

Hidden below is code for importing the data set and log transforming variables. The best model (lowest AIC & using lrtest) is presented below, model fit checked, and pairwise comparison for Treatment Type.  

I did create and test models without treatment type, but they always have higher AIC and worse model fit that those with (probably due to the control category...)  

##### Variables investigated:
- **Treat_Type** - treatment type
- **PIRI** - pitch pine sapling count (25m^2^)
- **SO** - shrub oak sapling count (25m^2^)
- **other** - other seedling count (25m^2^)
- **BA_HA** - basal area per hectare
- **BA_piri** - pitch pine basal area per hectare
- **Mineral** - exposed mineral soil (1m^2^)
- **avgLD** - average leaf litter depth (1m^2^)
- **Veg_Total** - total understory plant cover (1m^2^)
- **TFT** - time between treatment and sampling (used as an offset)
- **Site/Plot_No** - random effect of plots within sites

*Variables are log transformed (l. or _l)*

## Pitch Pine Regeneration

```{r Libraries, message=FALSE, warning=FALSE, include=FALSE}
# libraries -------------------
library(dplyr)
library(tidyverse)
library(ggplot2)
library(GGally)
library(glmmTMB)
library(TMB)
library(emmeans)
library(DHARMa)
library(lmtest)
library(ggeffects)
```

```{r, setup, include=FALSE}
# Set WD:
knitr::opts_knit$set(root.dir = '/Users/user/Desktop/Data/Regen_RProj/')
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
source("Scripts/SA_Import.R")

sa_merge2 <- sapling_merge %>% 
  pivot_wider(names_from = Species_Groups, values_from = Total_Tally)

time_since <- read_csv("CleanData/Treat_Year_Data.csv")

sa_merge3 <- merge(sa_merge2, time_since, by = 'Site')
#log transform time from treatment data
sa_merge3$l.TFT <- log(sa_merge3$Time_from_Treat)

source("Scripts/Add_BA.R")

# merge with sapling dataset -------------------
sa_merge4 <- merge(sa_merge3, prism_BA, by = 'Plot_No')

source("Scripts/Ground_Data.R")

# merge with sapling dataset -------------------
sa_merge5 <- merge(sa_merge4, ground3, by = 'Plot_No')

source("Scripts/Veg_Data.R")

# merge with sapling dataset -------------------
sa.all <- merge(sa_merge5, veg3, by = "Plot_No")

rm(sa_merge3,
   sa_merge4,
   sa_merge5)

sa.all3 <- sa.all

sa.all3$l.PIRI <- log(sa.all3$PIRI + 1)
sa.all3$l.SO <- log(sa.all3$Shrub_Oak + 1)
sa.all3$l.other <- log(sa.all3$Other + 1)

sa.all3 <- sa.all3 %>% 
  select(Treat_Type, Region, Site, Plot_No, PIRI, l.PIRI, Shrub_Oak, l.SO, Other, l.other, Time_from_Treat, l.TFT, BA_HA, l.BA_HA, PIRI.BA_HA, l.BA_piri, Mineral_Soil, l.Mineral, Litter_Duff, avgLD, avgLD_l, Veg_Total, l.Veg_Total) %>% 
  arrange(Treat_Type)
```

### Standardizing models to due to fixed effects at multiple scales
```{r}
sa.all3$piri.ba_s <- scale(sa.all3$PIRI.BA_HA)
sa.all3$avgld_s <- scale(sa.all3$avgLD)
sa.all3$vegt_s <- scale(sa.all3$Veg_Total)
sa.all3$min_s <- scale(sa.all3$Mineral_Soil)
sa.all3$so_s <- scale(sa.all3$Shrub_Oak)
sa.all3$other_s <- scale(sa.all3$Other)
sa.all3$ba.ha_s <- scale(sa.all3$BA_HA)
sa.all3$piri_s <- scale(sa.all3$PIRI)
```



### Best pitch pine sapling model
```{r}
sa.m9s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + other_s + avgld_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
summary(sa.m9s)
```


### Check model fit
```{r}
sa.m9s_sr <- simulateResiduals(sa.m9s, n = 1000, plot = T) #passes
testResiduals(sa.m9s_sr) #passes
testZeroInflation(sa.m9s_sr)
```

### Pairwise comparison for treatment types
```{r}
emmeans(sa.m9s, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
```
##### None signficantly different from the other; generally not a lot of pitch pine saplings measured


### Plot models
```{r, fig.align='center', echo=FALSE}
sa.piri1 <- ggpredict(sa.m9s, terms = c("avgld_s", "Treat_Type"))
#control and fallrx are almost completely identical - if I wanted to nudge/jitter
# sa.piri2 <- sa.piri1 %>% 
#   filter(group == "FallRx")
# 
# sa.piri2$predicted <- sa.piri2$predicted+0.01
# 
# sa.piri3 <- sa.piri1 %>% 
#   filter(group != "FallRx")
# 
# sa.piri3 <- rbind(sa.piri3, sa.piri2)

ggplot(sa.piri1, aes(x, predicted, color = group))+
  geom_line(linewidth = 1, show.legend = FALSE) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(axis.text = element_text(size = 18), axis.title = element_text(size = 24))+
  labs(x = "Average leaf litter depth \n (standardized)",
       y = NULL)

ggsave(filename = "SA_PIRI_avgld.tiff", path = "Plots/PIRI_GLMM", width = 6, height = 4.2, device = "tiff", dpi = 700)






sa.piri4 <- ggpredict(sa.m9s, terms = c("ba.ha_s", "Treat_Type"))
#again control and fall rx overlap - if I wanted to nudge/jitter

# sa.piri5 <- sa.piri4 %>% 
#   filter(group == "FallRx")
# 
# sa.piri5$predicted <- sa.piri5$predicted+0.01
# 
# sa.piri6 <- sa.piri4 %>% 
#   filter(group != "FallRx")
# 
# sa.piri6 <- rbind(sa.piri6, sa.piri5)


ggplot(sa.piri4, aes(x, predicted, color = group))+
  geom_line(linewidth = 1, show.legend = FALSE) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(axis.text = element_text(size = 18), axis.title = element_text(size = 24))+
  labs(x = "Average basal area per hectare \n (standardized)",
       y = "Pitch pine stems \n (adjusted for time)")


ggsave(filename = "SA_PIRI_BA.tiff", path = "Plots/PIRI_GLMM", width = 6, height = 4.2, device = "tiff", dpi = 700)





sa.piri5 <- ggpredict(sa.m9s, terms = c("other_s", "Treat_Type"))

ggplot(sa.piri5, aes(x, predicted, color = group))+
  geom_line(linewidth = 1, show.legend = FALSE) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(axis.text = element_text(size = 18), axis.title = element_text(size = 24))+
  labs(x = "Counts of other saplings \n (standardized)",
       y = NULL)

ggsave(filename = "SA_PIRI_other.tiff", path = "Plots/PIRI_GLMM", width = 6, height = 4.2, device = "tiff", dpi = 700)
```


## Shrub Oak Regeneration
This includes QUIL (scrub oak) & QUPR (dwarf chinkapin oak)

### Best shrub oak sapling model

#### looking at SO w/o spring rx or mowrx and standardized variables
```{r}
sa.all_noSMRX <- sa.all3 %>% 
  filter(Treat_Type != "SpringRx") %>% 
  filter(Treat_Type != "MowRx")
```


### Seemingly best model
```{r}
so.sa6b <- glmmTMB(Shrub_Oak ~ Treat_Type + piri_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all_noSMRX,
                 ziformula = ~Region,
                 family = nbinom2)
summary (so.sa6b)
```


### DHARMa test
```{r}
so.sa6b_sr <- simulateResiduals(so.sa6b, n = 1000, plot = T)
testResiduals(so.sa6b_sr)
testZeroInflation(so.sa6b_sr)
```


### Pairwise
```{r}
emmeans(so.sa6b, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
```


### Plot model
```{r, fig.align='center', echo=FALSE}
sa.so1 <- ggpredict(so.sa6b, terms = c("piri_s", "Treat_Type"))

ggplot(sa.so1, aes(x, predicted, color = group))+
  geom_line(linewidth = 1, show.legend = FALSE) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(axis.text = element_text(size = 18), axis.title = element_text(size = 24))+
  labs(x = "Counts of pitch pine saplings \n (standardized)",
       y = NULL)

ggsave(filename = "SO_PIRI_other.tiff", path = "Plots/SO_GLMM", width = 6, height = 4.2, device = "tiff", dpi = 700)
```






















