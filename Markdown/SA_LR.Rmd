---
title: "Sapling Linear Regression"
author: "Kathleen Stutzman"
date: "2024-01-10"
output: html_document
---

Libraries:
```{r Libraries, message=FALSE, warning=FALSE}
# libraries -------------------
library(dplyr)
library(tidyverse)
library(ggplot2)
library(GGally)
library(glmmTMB)
library(TMB)
library(emmeans)
library(DHARMa)
library(lmtest)
library(ggeffects)
library(performance)
```

Set working directory
```{r, setup}
knitr::opts_knit$set(root.dir = '/Users/user/Desktop/Data/Regen_RProj/')
```

Source sapling data:
```{r, message=FALSE}
source("Scripts/SA_Import.R")
```

Pivot wider to create dataframe where each row is for one plot and has total details for each species group
```{r}
sa_merge2 <- sapling_merge %>% 
  pivot_wider(names_from = Species_Groups, values_from = Total_Tally)
```

Import time since data and add it to the PIRI dataset
```{r, warning=FALSE, message=FALSE}
time_since <- read_csv("CleanData/Treat_Year_Data.csv")

sa_merge3 <- merge(sa_merge2, time_since, by = 'Site')
#log transform time from treatment data
sa_merge3$l.TFT <- log(sa_merge3$Time_from_Treat)
```

```{r, include=FALSE, eval=FALSE}
setdiff(sa_merge2[,1:7], sa_merge3[,1:7])
#there was a problem with the name of tncw_7sw, where the names weren't matching up; this is the code to find the difference
```

Run the 'Add_BA' script and merge with dataset:
```{r, message=FALSE}
source("Scripts/Add_BA.R")

# merge with sapling dataset -------------------
sa_merge4 <- merge(sa_merge3, prism_BA, by = 'Plot_No')
```

Run 'Ground_Data.R' script and add it to sapling dataset:
```{r}
source("Scripts/Ground_Data.R")

# merge with sapling dataset -------------------
sa_merge5 <- merge(sa_merge4, ground3, by = 'Plot_No')
```

Source and add veg data:
```{r}
source("Scripts/Veg_Data.R")

# merge with sapling dataset -------------------
sa.all <- merge(sa_merge5, veg3, by = "Plot_No")

rm(sa_merge3,
   sa_merge4,
   sa_merge5)
```

#### Sapling count data is taken in 25m^2^ plots; basal area is measured in hectares; veg and soil data is taken a 1m^2^ plots.
Data will be standardized for comparisons at multiple scales

Create a dataframe keeping sapling at 25m^2^ observation levels & log transforming them
```{r}
sa.all3 <- sa.all

sa.all3$piri.ba_s <- scale(sa.all3$PIRI.BA_HA)
sa.all3$avgld_s <- scale(sa.all3$avgLD)
sa.all3$vegt_s <- scale(sa.all3$Veg_Total)
sa.all3$min_s <- scale(sa.all3$Mineral_Soil)
sa.all3$so_s <- scale(sa.all3$Shrub_Oak)
sa.all3$other_s <- scale(sa.all3$Other)
sa.all3$ba.ha_s <- scale(sa.all3$BA_HA)
sa.all3$piri_s <- scale(sa.all3$PIRI)

sa.all3 <- sa.all3 %>% 
  select(Treat_Type, Region, Site, Plot_No, PIRI, piri_s, Shrub_Oak, so_s, Other, other_s, Time_from_Treat, l.TFT, BA_HA, ba.ha_s, PIRI.BA_HA, piri.ba_s, Mineral_Soil, min_s, Litter_Duff, avgLD, avgld_s, Veg_Total, vegt_s) %>% 
  arrange(Treat_Type)
```




Looking at pairwise with sa.all3 dataset (sapling counts at 25m^2^ observation level)
```{r, warning=FALSE}
#not log transformed (25m2)
sa3.num <- sa.all3 %>% 
  select(PIRI, Shrub_Oak, Other, Time_from_Treat, BA_HA, PIRI.BA_HA, Mineral_Soil, avgLD, Veg_Total, Treat_Type)

ggpairs(sa3.num)
ggpairs(sa3.num, aes(color = Treat_Type))

rm(sa3.num)
```
No strong correlations


major personal breakthrough for dummies. For zero inflation, lets see if any TT or region is lacking alltogether in PIRI or SO saplings
```{r}
sa.all4 <- sa.all3 %>% 
  group_by(Region)

tapply(sa.all4$PIRI, sa.all4$Region, summary)
# no PIRI in LI,
tapply(sa.all4$PIRI, sa.all4$Treat_Type, summary) 
```



#### Now that I know that there are no PIRI in LI, I want to start model elimination again using ziformula = ~ Region

I have previously done model elimination with zero inflated poisson distro & with model w.o TT. Neither are better than zi nbinom2 models. zi ~1 has distribution issues, ~Region does not





Model has much better fit and zero inflation issues are resolved when treatment type variable is included. Time to do elimination again but with TT; all models fail with nbinom1 distro, but works with nbinom2 (these notes are from when I was using a zi poisson distro, using nbinom TT no longer seems to be important to model fit, but we will keep for the overarching story)


### Checking fixed effects for collinearity and looking at general summary stats to make sure they aren't 0/1 or same/function of other category
```{r}
summary(sa.all3)

library(caret)

findLinearCombos(sa.all3[,4:23]) #shows no linear combos. Don't get how the rank deficiency is happening
tapply(sa.all3$Other, sa.all3$Region, summary) #all present
tapply(sa.all3$Shrub_Oak, sa.all3$Region, summary) #none in LI
tapply(sa.all3$BA_HA, sa.all3$Region, summary) #all present
tapply(sa.all3$PIRI.BA_HA, sa.all3$Region, summary) #all present
tapply(sa.all3$Veg_Total, sa.all3$Region, summary) #all present
tapply(sa.all3$Mineral_Soil, sa.all3$Region, summary) #all present
tapply(sa.all3$avgLD, sa.all3$Region, summary) #all present
```

```{r}
tapply(sa.all3$Other, sa.all3$Treat_Type, summary) #all present
tapply(sa.all3$Shrub_Oak, sa.all3$Treat_Type, summary) #none in mowrx or springrx
tapply(sa.all3$BA_HA, sa.all3$Treat_Type, summary) #all present
tapply(sa.all3$PIRI.BA_HA, sa.all3$Treat_Type, summary) #all present
tapply(sa.all3$Veg_Total, sa.all3$Treat_Type, summary) #all present
tapply(sa.all3$Mineral_Soil, sa.all3$Treat_Type, summary) #all present
tapply(sa.all3$avgLD, sa.all3$Treat_Type, summary) #all present
```




# PIRI Model
Best Model AIC: 245.8


### Running model elimination used standardized effects and zi by Region
Tested both nbinom1 (models won't converge) and poisson (fails DHARMa tests)
```{r}
sa.m1s <- glmmTMB(PIRI ~ Treat_Type + piri.ba_s + avgld_s + vegt_s + min_s + so_s + other_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
#won't converge

#test piri ba
sa.m2s <- glmmTMB(PIRI ~ Treat_Type  + avgld_s + vegt_s + min_s + so_s + other_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m2s) #248

# test ba/ha
sa.m3s <- glmmTMB(PIRI ~ Treat_Type  + avgld_s + vegt_s + min_s + so_s + other_s  + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m3s) #251.7

lrtest(sa.m2s, sa.m3s) #keep ba

# test SO
sa.m4s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + avgld_s + vegt_s + min_s + other_s  + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m4s) #248

lrtest(sa.m4s, sa.m2s) #drop

# test other
sa.m5s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + avgld_s + vegt_s + min_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m5s) #251.1

lrtest(sa.m4s, sa.m5s) #keep other

# test mineral
sa.m6s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + avgld_s + vegt_s + other_s  + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m6s) #247

lrtest(sa.m4s, sa.m6s) #drop

# test veg
sa.m7s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + avgld_s  + other_s  + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m7s) #245.8

# test ld
sa.m8s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + other_s  + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m8s) #244.8 

sa.m8s_sr <- simulateResiduals(sa.m8s, n = 1000, plot = TRUE) #passes
testResiduals(sa.m8s_sr)
# passes


emmeans(sa.m8s, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response') # the model is rank deficient

sa.m9s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + other_s + avgld_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m9s) #245.9 with veg; 245.8 with ld
summary(sa.m9s)
```

#### Best model (lowest AIC without rank deficiency) appears to be model sa.m6 with TT, piri BA, agvLD, Veg total. Test model fit:
Model without avgld is rank deficient
```{r}
sa.m9s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + other_s + avgld_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m9s) #245.9 with veg; 245.8 with ld
summary(sa.m9s)

sa.m9s_sr <- simulateResiduals(sa.m9s, n = 1000, plot = TRUE) #passes
testResiduals(sa.m9s_sr)
# passes
```

#### Pairwise
```{r}
emmeans(sa.m9s, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
```
None significantly different from eachother







#### Plot model
```{r, fig.align='center'}
sa.piri1 <- ggpredict(sa.m9s, terms = c("avgld_s", "Treat_Type"))
#control and fallrx are almost completely identical - if I wanted to nudge/jitter
# sa.piri2 <- sa.piri1 %>% 
#   filter(group == "FallRx")
# 
# sa.piri2$predicted <- sa.piri2$predicted+0.01
# 
# sa.piri3 <- sa.piri1 %>% 
#   filter(group != "FallRx")
# 
# sa.piri3 <- rbind(sa.piri3, sa.piri2)

ggplot(sa.piri1, aes(x, predicted, color = group))+
  geom_line(linewidth = 1, show.legend = FALSE) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(axis.text = element_text(size = 18), axis.title = element_text(size = 24))+
  labs(x = "Average leaf litter depth \n (standardized)",
       y = NULL)

ggsave(filename = "SA_PIRI_avgld.tiff", path = "Plots/PIRI_GLMM", width = 6, height = 4.2, device = "tiff", dpi = 700)






sa.piri4 <- ggpredict(sa.m9s, terms = c("ba.ha_s", "Treat_Type"))
#again control and fall rx overlap - if I wanted to nudge/jitter

# sa.piri5 <- sa.piri4 %>% 
#   filter(group == "FallRx")
# 
# sa.piri5$predicted <- sa.piri5$predicted+0.01
# 
# sa.piri6 <- sa.piri4 %>% 
#   filter(group != "FallRx")
# 
# sa.piri6 <- rbind(sa.piri6, sa.piri5)


ggplot(sa.piri4, aes(x, predicted, color = group))+
  geom_line(linewidth = 1, show.legend = FALSE) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(axis.text = element_text(size = 18), axis.title = element_text(size = 24))+
  labs(x = "Average basal area per hectare \n (standardized)",
       y = "Pitch pine stems \n (adjusted for time)")


ggsave(filename = "SA_PIRI_BA.tiff", path = "Plots/PIRI_GLMM", width = 6, height = 4.2, device = "tiff", dpi = 700)





sa.piri5 <- ggpredict(sa.m9s, terms = c("other_s", "Treat_Type"))

ggplot(sa.piri5, aes(x, predicted, color = group))+
  geom_line(linewidth = 1, show.legend = FALSE) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(axis.text = element_text(size = 18), axis.title = element_text(size = 24))+
  labs(x = "Counts of other saplings \n (standardized)",
       y = NULL)

ggsave(filename = "SA_PIRI_other.tiff", path = "Plots/PIRI_GLMM", width = 6, height = 4.2, device = "tiff", dpi = 700)
```







## Shrub Oak Models
Best Model AIC: 323.8

Start from the beginning knowing that both Region and Treat Type have 0 areas


```{r}
tapply(sa.all4$Shrub_Oak, sa.all4$Region, summary)
# no SO in LI,
tapply(sa.all4$Shrub_Oak, sa.all4$Treat_Type, summary) 
# no SO in MowRX or SpringRx

rm(sa.all4)
```


#### looking at SO w/o spring rx or mowrx and w/ standardized variables

```{r}
sa.all_noSMRX <- sa.all3 %>% 
  filter(Treat_Type != "SpringRx") %>% 
  filter(Treat_Type != "MowRx")
```

There is just not enough information in exposed mineral soil (so many 0s) for it to be useful. It messes up models, making them rank deficient. So just dropping that variable
```{r}
so.sa1s <- glmmTMB(Shrub_Oak ~ Treat_Type + piri.ba_s + avgld_s + vegt_s + piri_s + other_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all_noSMRX,
                 ziformula = ~Region,
                 family = nbinom1)
# won't converge

#had to remove piri ba for model to converge
so.sa2s <- glmmTMB(Shrub_Oak ~ Treat_Type + avgld_s + vegt_s + piri_s + other_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all_noSMRX,
                 ziformula = ~Region,
                 family = nbinom1)
AIC (so.sa2s) #333

#avgld
so.sa3s <- glmmTMB(Shrub_Oak ~ Treat_Type + vegt_s + piri_s + other_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all_noSMRX,
                 ziformula = ~Region,
                 family = nbinom1)
AIC (so.sa3s) #331

lrtest(so.sa2s, so.sa3s) #0.6

#piri
so.sa4s <- glmmTMB(Shrub_Oak ~ Treat_Type + vegt_s + other_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all_noSMRX,
                 ziformula = ~Region,
                 family = nbinom1)
AIC (so.sa4s) #329

lrtest(so.sa3s, so.sa4s) #0.9

#other
so.sa5s <- glmmTMB(Shrub_Oak ~ Treat_Type + vegt_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all_noSMRX,
                 ziformula = ~Region,
                 family = nbinom1)
AIC (so.sa5s) #327.3

lrtest(so.sa4s, so.sa5s) #0.9 - drop other

#test BA
so.sa6s <- glmmTMB(Shrub_Oak ~ Treat_Type + vegt_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all_noSMRX,
                 ziformula = ~Region,
                 family = nbinom1)
AIC (so.sa6s) #325.3

lrtest(so.sa6s, so.sa5s) #0.9

# test veg
so.sa7s <- glmmTMB(Shrub_Oak ~ Treat_Type + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all_noSMRX,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.sa7s) #323.8

lrtest(so.sa7s, so.sa6s) #0.5

# add piri ba back in
so.sa8s <- glmmTMB(Shrub_Oak ~ Treat_Type + piri.ba_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all_noSMRX,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.sa8s) #325

lrtest(so.sa7s, so.sa8s) #0.4

rm(so.sa1s,
   so.sa2s,
   so.sa3s,
   so.sa4s,
   so.sa5s,
   so.sa6s,
   so.sa8s)
```

#### Best model (no springrx or mowrx)
```{r}
so.sa7s <- glmmTMB(Shrub_Oak ~ Treat_Type + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all_noSMRX,
                 ziformula = ~Region,
                 family = nbinom1)
summary(so.sa7s) #323.8

so.sa7s_sr <- simulateResiduals(so.sa7s, n = 1000, plot = T) #passes
testResiduals(so.sa7s_sr)  #passes
```

#### Pairwise
```{r}
emmeans(so.sa7s, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
```
### none significantly different
Control vs FallRx close at 0.07




#### Now graph
Need to figure out better use of emmeans (potentially)
```{r, fig.align='center'}

so.sa1.plot <- emmeans(so.sa7s, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')

plot <- plot(so.sa1.plot, horizontal=FALSE, comparisons=TRUE, color = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15")) + theme_bw()

plot+
  theme_classic()+
  theme(panel.background = element_blank()) +
  theme(axis.text = element_text(size = 14), axis.title = element_text(size = 20), legend.position = "right", legend.text = element_text(size = 14), legend.title = element_text(size = 18)) +
  labs(x = "Shrub Oak Stems \n (corrected for time from treatment)",
       z = "Treatment Type",
       color = "Treatment Type")
```

More in harvest - does fire kill large scrub oak saplings? They are entirely missing from springrx and mowrx treatments


#### this is the same analysis, but with all treatment categories
There are no shrub oak sapling in springrx and mowrx treatments, so the above model is better - but just to have it.
```{r}
so.all1 <- glmmTMB(Shrub_Oak ~ Treat_Type + piri_s + other_s + min_s + avgld_s+ piri.ba_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
#won't converge

#drop min & piri ba

so.all2 <- glmmTMB(Shrub_Oak ~ Treat_Type + piri_s + other_s + avgld_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.all2) #335

so.all3 <- glmmTMB(Shrub_Oak ~ Treat_Type + other_s + avgld_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.all3) #333.5

so.all4 <- glmmTMB(Shrub_Oak ~ Treat_Type + avgld_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.all4) #331.6

so.all5 <- glmmTMB(Shrub_Oak ~ Treat_Type + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.all5) #329.7

so.all6 <- glmmTMB(Shrub_Oak ~ Treat_Type + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.all6) #327.8

so.all7 <- glmmTMB(Shrub_Oak ~ Treat_Type + piri.ba_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.all7) #329

rm(so.all1,
   so.all2,
   so.all3,
   so.all4,
   so.all5,
   so.all7)

so.all6_sr <- simulateResiduals(so.all6, n = 1000, plot = T) #passes
testResiduals(so.all6_sr) #passes

emmeans(so.all6, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
```














