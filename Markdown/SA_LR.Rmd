---
title: "Sapling Linear Regression"
author: "Kathleen Stutzman"
date: "2024-01-10"
output: html_document
---

Libraries:
```{r Libraries, message=FALSE, warning=FALSE}
# libraries -------------------
library(dplyr)
library(tidyverse)
library(ggplot2)
library(GGally)
library(glmmTMB)
library(TMB)
library(emmeans)
library(DHARMa)
library(lmtest)
```

Set working directory
```{r, setup}
knitr::opts_knit$set(root.dir = '/Users/user/Desktop/Data/Regen_RProj/')
```

Source sapling data:
```{r, message=FALSE, warning=FALSE}
source("Scripts/SA_Import.R")
```

Pivot wider to create dataframe where each row is for one plot and has total details for each species group
```{r}
sa_merge2 <- sapling_merge %>% 
  pivot_wider(names_from = Species_Groups, values_from = Total_Tally)
```

Import time since data and add it to the PIRI dataset
```{r, warning=FALSE, message=FALSE}
time_since <- read_csv("CleanData/Treat_Year_Data.csv")

sa_merge3 <- merge(sa_merge2, time_since, by = 'Site')
#log transform time from treatment data
sa_merge3$l.TFT <- log(sa_merge3$Time_from_Treat)
```

```{r, include=FALSE, eval=FALSE}
setdiff(sa_merge2[,1:7], sa_merge3[,1:7])
#there was a problem with the name of tncw_7sw, where the names weren't matching up; this is the code to find the difference
```

Run the 'Add_BA' script and merge with dataset:
```{r, warning=FALSE, message=FALSE}
source("Scripts/Add_BA.R")

# merge with sapling dataset -------------------
sa_merge4 <- merge(sa_merge3, prism_BA, by = 'Plot_No')
```

Run 'Ground_Data.R' script and add it to sapling dataset:
```{r}
source("Scripts/Ground_Data.R")

# merge with sapling dataset -------------------
sa_merge5 <- merge(sa_merge4, ground3, by = 'Plot_No')

```

Source and add veg data:
```{r}
source("Scripts/Veg_Data.R")

# merge with sapling dataset -------------------
sa.all <- merge(sa_merge5, veg3, by = "Plot_No")

rm(sa_merge3,
   sa_merge4,
   sa_merge5)
```

Sapling count data is taken in 25m^2^ plots; basal area is measured in hectares; veg and soil data is taken a 1m^2^ plots.

Sapling data will be convered into 1m^2^ plots in order to compare across and reduce the amount of scales of data collection, reducing it to two: 1m^2^ plots and per hectare observations
```{r}
sa.all$PIRI.1m <- sa.all$PIRI/25
sa.all$SO.1m <- sa.all$Shrub_Oak/25
sa.all$Other.1m <- sa.all$Other/25
```

Create log transformed categories for newly added variables, then select for just the desired variables:
```{r}
sa.all$l.PIRI1 <- log(sa.all$PIRI.1m + 1)
sa.all$l.SO1 <- log(sa.all$SO.1m + 1)
sa.all$l.other1 <- log(sa.all$Other.1m + 1)

sa.all2 <- sa.all %>% 
  select(Treat_Type, Region, Site, Plot_No, PIRI, l.PIRI1, Shrub_Oak, l.SO1, Other, l.other1, Time_from_Treat, l.TFT, BA_HA, l.BA_HA, PIRI.BA_HA, l.BA_piri, Mineral_Soil, l.Mineral, Litter_Duff, avgLD, avgLD_l, Veg_Total, l.Veg_Total) %>% 
  arrange(Treat_Type)
```

Create a dataframe keeping sapling at 25m^2^ observation levels & log transforming them
```{r}
sa.all3 <- sa.all

sa.all3$l.PIRI <- log(sa.all3$PIRI + 1)
sa.all3$l.SO <- log(sa.all3$Shrub_Oak + 1)
sa.all3$l.other <- log(sa.all3$Other + 1)

sa.all3 <- sa.all3 %>% 
  select(Treat_Type, Region, Site, Plot_No, PIRI, l.PIRI, Shrub_Oak, l.SO, Other, l.other, Time_from_Treat, l.TFT, BA_HA, l.BA_HA, PIRI.BA_HA, l.BA_piri, Mineral_Soil, l.Mineral, Litter_Duff, avgLD, avgLD_l, Veg_Total, l.Veg_Total) %>% 
  arrange(Treat_Type)
```



Select just for numerical vs log and then look at paired plots for sapling transformed to 1m^2^ observation level:
```{r, eval=FALSE}
#not log transformed (1m2)
sa.num <- sa.all2 %>% 
  select(PIRI.1m, S0.1m, Other.1m, Time_from_Treat, BA_HA, PIRI.BA_HA, Mineral_Soil, avgLD, Veg_Total, Treat_Type)

ggpairs(sa.num)
ggpairs(sa.num, aes(color = Treat_Type))


#log transformed (1m2)
sa.numl <- sa.all2 %>% 
  select(l.PIRI1, l.SO1, l.other1, l.TFT, l.BA_HA, l.BA_piri, l.Mineral, avgLD_l, l.Veg_Total, Treat_Type)

ggpairs(sa.numl)
ggpairs(sa.numl, aes(color = Treat_Type))

rm(sa.num,
   sa.numl)
```
Can see the correlation coefficients for linear (Pearsons) relationships. None of them appear very strong, except for ones that are analogs (avg LD vs mineral soil exposure; ba/ha vs piri ba/ha)

No significant correlations obvious from plots

# Above code and naming conventions are the same as SA_GLMM.Rmd script


Looking at pairwise again but with sa.all3 dataset (sapling counts at 25m^2^ observation level)
```{r}
#not log transformed (25m2)
sa3.num <- sa.all3 %>% 
  select(PIRI, Shrub_Oak, Other, Time_from_Treat, BA_HA, PIRI.BA_HA, Mineral_Soil, avgLD, Veg_Total, Treat_Type)

ggpairs(sa3.num)
ggpairs(sa3.num, aes(color = Treat_Type))


#log transformed (25m2)
sa3.numl <- sa.all3 %>% 
  select(l.PIRI, l.SO, l.other, l.TFT, l.BA_HA, l.BA_piri, l.Mineral, avgLD_l, l.Veg_Total, Treat_Type)

ggpairs(sa3.numl)
ggpairs(sa3.numl, aes(color = Treat_Type))

rm(sa3.num,
   sa3.numl)
```
Again no strong correlations


Going to try some scatterplots:
```{r}
#PIRI & SO
ggplot(sa.all3, aes(x=l.PIRI, y = l.SO))+
  geom_point()+
  geom_smooth(method = lm)+
  facet_grid(~Treat_Type)
# negative for control, positive for fallrx, flat for other

#PIRI and other
ggplot(sa.all3, aes(x=l.PIRI, y = l.other, fill = Treat_Type))+
  geom_point()+
  geom_smooth(method = lm) +
  facet_grid(~Treat_Type)
# negative for control & fall rx, weak negative for springrx and mow, positive for harvest

#PIRI and veg
ggplot(sa.all3, aes(x=l.PIRI, y = l.Veg_Total, fill = Treat_Type))+
  geom_point()+
  geom_smooth(method = lm) +
  facet_grid(~Treat_Type)
# positive for harvest, weak negative for springrx, negative for mowrx, fallrx, and control

#relationships varying by treatment type may be a reason why the model are having a hard time in DHARMa
```





Start with data transformed to 1m plot and no treatment type
```{r, eval=FALSE}
sa.m1 <- glmmTMB(PIRI ~ l.SO1 + l.other1 + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all2,
                 family = poisson)
AIC(sa.m1) #213.7

sa.m1_sr <- simulateResiduals(sa.m1, n = 1000, plot = T)
testZeroInflation(sa.m1_sr) #zero inflated

sa.m1a <- glmmTMB(PIRI ~ l.SO1 + l.other1 + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all2,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m1a) #215.7

sa.m1a_sr <- simulateResiduals(sa.m1a, n = 1000, plot = T) #passes
testZeroInflation(sa.m1a_sr) #still zero inflated, lets test on data set without 1m transformations - sa.all3


# Untransformed sapling counts
sa.m1b <- glmmTMB(PIRI ~ l.SO + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m1b) #215.9

sa.m1b_sr <- simulateResiduals(sa.m1b, n = 1000, plot = T) #fails ks
testZeroInflation(sa.m1b_sr) #still very zero inflated
```



Test models with untransformed counts and see if zero inflation issues resolve as variables decrease?
```{r, eval=FALSE}
# test piri ba
sa.m2 <- glmmTMB(PIRI ~ l.SO + l.other + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m2) #217.1

lrtest(sa.m1b, sa.m2) # p = 0.07

# test ba
sa.m3 <- glmmTMB(PIRI ~ l.SO + l.other + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m3) #215.1

#test mineral soil
sa.m4 <- glmmTMB(PIRI ~ l.SO + l.other + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m4) #213.2

lrtest(sa.m3, sa.m4) # p = 0.7

#test litter depth
sa.m5 <- glmmTMB(PIRI ~ l.SO + l.other + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m5) #211.2

#test veg cover
sa.m6 <- glmmTMB(PIRI ~ l.SO + l.other + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m6) #209.4

lrtest(sa.m5, sa.m6) #p = 0.7

#test other
sa.m7 <- glmmTMB(PIRI ~ l.SO + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m7) #253.7

lrtest(sa.m6, sa.m7) #p less than 0.001

#test shrub oak
sa.m8 <- glmmTMB(PIRI ~ l.other + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m8) #249.3

lrtest(sa.m6, sa.m8) #p less than 0.001

#sa.m6 looks best, lets test model
sa.m6_sr <- simulateResiduals(sa.m6, n = 1000, plot = TRUE) #doesn't pass
testZeroInflation(sa.m6_sr) #still fails

#try model with treat type and see if it passes?
sa.m9 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m9) #256.3
lrtest(sa.m6, sa.m9) #p less than 0.001


sa.m9_sr <- simulateResiduals(sa.m9, n = 1000, plot = TRUE) #passes
testZeroInflation(sa.m9_sr) #passes
testResiduals(sa.m9_sr)

#this model looks great. based on modeling below that starts with TT, I'm going to add veg back into this model and run again
sa.m10 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m10) #218.5
lrtest(sa.m10, sa.m9) #weird, is now important

sa.m10_sr <- simulateResiduals(sa.m10, n = 1000, plot = TRUE) #now fails
testResiduals(sa.m10_sr)
```







Model has much better fit and zero inflation issues are resolved when treatment type variable is included. Time to do elimination again but with TT
```{r, eval=FALSE}
sa.m1b <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m1b) #223.4

# test piri ba
sa.m2 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m2) #223.9

lrtest(sa.m1b, sa.m2) # p = 0.1

# test ba
sa.m3 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m3) #222.3

#test mineral soil
sa.m4 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m4) #220.5

lrtest(sa.m3, sa.m4) # p = 0.7

#test litter depth
sa.m5 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m5) #218.5

#test veg cover
sa.m6 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m6) #256.4

lrtest(sa.m5, sa.m6) #p less than 0.001

#test other
sa.m7 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m7) #217.6

lrtest(sa.m5, sa.m7) #p = 0.3

#test shrub oak
sa.m8 <- glmmTMB(PIRI ~ Treat_Type + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.m8) #215.6

lrtest(sa.m7, sa.m8) #p = .8

#so with treatment type included, veg cover is important, but other species of saplings are not

#check model
sa.m8_sr <- simulateResiduals(sa.m8, n = 1000, plot = TRUE) #fails
testZeroInflation(sa.m8_sr) #fails

#try model with so and other saplings?
sa.m5_sr <- simulateResiduals(sa.m5, n = 1000, plot = TRUE)
testZeroInflation(sa.m5_sr) #both still fail ...
```
Some issues with models failing DHARMa tests despite what model elimination/AIC says is important. 




# Starting analysis again
```{r}
sa.m10 <- glmmTMB(PIRI ~ Treat_Type + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = poisson)
AIC(sa.m10) #221.7

sa.m10_sr <- simulateResiduals(sa.m10, n = 1000, plot = TRUE)
testZeroInflation(sa.m10_sr) #fails

sa.m11 <- glmmTMB(PIRI ~ Treat_Type + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Treat_Type,
                 family = poisson)
AIC(sa.m11) #223.6

sa.m11_sr <- simulateResiduals(sa.m11, n = 1000, plot=T)
testZeroInflation(sa.m11_sr) #fails

sa.m12 <- glmmTMB(PIRI ~ Treat_Type + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = poisson)
AIC(sa.m12) #213.9 w/1, 250.5 with region

sa.m12_sr <- simulateResiduals(sa.m12, n = 1000, plot = TRUE) #fails with 1 as ZI; passes with region as zi
testZeroInflation(sa.m12_sr) #fails with 1 as ZI; passes with region as zi
```



Ok, this is the best fit model so far
```{r}
sa.m12 <- glmmTMB(PIRI ~ Treat_Type + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = poisson)
AIC(sa.m12) #213.9 w/1, 250.5 with region

#I'd like to try adding so, other, and veg back into this model, checking AIC and model fit

sa.m13 <- glmmTMB(PIRI ~ Treat_Type + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = poisson)
AIC(sa.m13) #221.7

sa.m13_sr <- simulateResiduals(sa.m13, n = 1000, plot = TRUE) #fails
testZeroInflation(sa.m13_sr) #fails

sa.m14 <- glmmTMB(PIRI ~ Treat_Type + l.SO + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = poisson)
AIC(sa.m14)

lrtest(sa.m12, sa.m14) #p = 0.2

sa.m15 <- glmmTMB(PIRI ~ Treat_Type + l.other + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
#won't converge w/ region
AIC(sa.m15)

sa.m15_sr <- simulateResiduals(sa.m15, n = 1000, plot = TRUE)
testZeroInflation(sa.m15_sr)
```



## Models that pass DHARMa tests:

```{r}
sa.f1 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.f1) #256.4

sa.f2 <- glmmTMB(PIRI ~ Treat_Type + l.other + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
#won't converge w/ region
AIC(sa.f2) #255.4

sa.f2_sr <- simulateResiduals(sa.f2, n = 1000, plot = TRUE) #passes
testZeroInflation(sa.f2_sr) #passes
testResiduals(sa.f2_sr) #passes


lrtest(sa.f1, sa.f2) # p = 0.3 - can drop SO

sa.f3 <- glmmTMB(PIRI ~ Treat_Type + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~1,
                 family = poisson)
AIC(sa.f3) #213.9 

sa.f3_sr <- simulateResiduals(sa.f3, n = 1000, plot = TRUE) #fails
testZeroInflation(sa.f3_sr) #fails

lrtest(sa.f2, sa.f3) #p is less than 0.001, but the AIC falls so much, weird

sa.f4 <- glmmTMB(PIRI ~ Treat_Type + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = poisson)
AIC(sa.f4) #250.5 with region

sa.f4_sr <- simulateResiduals(sa.f4, n = 1000, plot = TRUE) #passes
testZeroInflation(sa.f4_sr) #passes
testResiduals(sa.f4_sr) #passes


AIC(sa.f4, sa.f2)
#aic is lower for sa.f4 & more df - therefore better model? maybe graph both to see what is going on?

emmeans(sa.f4, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
```


Trying to plot with jtools package
```{r}
library(jtools)
effect_plot(sa.f2, pred=Treat_Type)
effect_plot(sa.f2, pred=Treat_Type, plot.points = T)
effect_plot(sa.f2, pred=Treat_Type, partial.residuals = T)

effect_plot(sa.f2, pred=l.other)
effect_plot(sa.f2, pred=l.other, plot.points = T)
effect_plot(sa.f2, pred=l.other, partial.residuals = T)

effect_plot(sa.f2, pred=l.TFT)
effect_plot(sa.f2, pred=l.TFT, plot.points = T)

#not sure that this is better than sjplot, but good to have options
```


Reading about graphing offsets:
```{r, eval=FALSE, include=FALSE}


Owls$NCalls <- Owls$SiblingNegotiation


Formula <- formula(NCalls ∼ offset(logBroodSize) + SexParent * FoodTreatment + SexParent * ArrivalTime)
fit1 <- glm(Formula, data = Owls, family = poisson(link="log"))

library(sjPlot)
plot_model(fit1, type="pred")

Formula.2 <- formula(NCalls/logBroodSize ∼ SexParent * FoodTreatment + SexParent * ArrivalTime)
fit2 <- glm(Formula.2, data = Owls, family = poisson(link="log"))

Formula <- NCalls/BroodSize ~ SexParent * FoodTreatment + SexParent * ArrivalTime
fit1 <- glm(Formula, data = Owls, family = quasipoisson(link="log"))
plot_model(fit1, type="pred")
#$SexParent
#
#$FoodTreatment
#
#$ArrivalTime

png();  plot_model(fit1, type="pred")$ArrivalTime ; dev.off()



png(); plot_model(sa.f2, type = "pred")$l.other ; dev.off()
#this isn't working
```



Plot these babies
```{r}
library(sjPlot)
library(sjlabelled)
library(sjmisc)

set_theme(base = theme_classic(),
          theme.font = 'serif',
          axis.title.size = 1.5,
          axis.textsize.x = 1.5,
          axis.textsize.y = 1.5,
          title.size = 2.5,
          title.align = "center",
          legend.pos = "right",
          legend.size = 1.5,
          legend.title.size = 1.5,
          #legend.bordercol = "black",
          legend.item.size = .75)

plot_model(sa.f4, 
           type = "pred",
           terms = "Treat_Type")

plot_model(sa.f4, 
           type = "pred",
           terms = c("l.TFT", "Treat_Type"),
           axis.title = c("Time from Last Treatment (log transformed)", "Total Count of Pitch Pine"),
           title = "Predicted Counts of Pitch Pine Saplings \n >/= 2.5 cm & < 10 cm DBH",
           legend.title = "Treatment Type",
           line.size = 1,
           show.zeroinf = T,
           ci.lvl = NA,
           colors = c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15"))


# plot model two
plot_model(sa.f2, 
           type = "pred",
           terms = c("l.TFT", "Treat_Type"),
           axis.title = c("Time from Last Treatment (log transformed)", "Total Count of Pitch Pine"),
           title = "Predicted Counts of Pitch Pine Saplings \n >/= 2.5 cm & < 10 cm DBH",
           legend.title = "Treatment Type",
           line.size = 1,
           show.zeroinf = T,
           ci.lvl = NA,
           colors = c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15"))

plot_model(sa.f2, 
           type = "pred",
           terms = c("l.other", "Treat_Type"),
           axis.title = c("Other Saplings (log transformed)", "Total Count of Pitch Pine"),
           title = "Predicted Counts of Pitch Pine Saplings \n >/= 2.5 cm & < 10 cm DBH",
           legend.title = "Treatment Type",
           line.size = 1,
           show.zeroinf = T,
           ci.lvl = NA,
           colors = c("#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15"))

```





## Trying again with shrub oak

```{r}
#test full models for zero inflation?
so.sa1 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 family = poisson)

# won't converge - remove mineral
so.sa2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + l.BA_piri + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 family = poisson)
AIC(so.sa2) # 363.4

so.sa2_sr <- simulateResiduals(so.sa2, n = 1000, plot = TRUE)
testResiduals(so.sa2_sr) #passes
testZeroInflation(so.sa2_sr) #passes
plot(so.sa2_sr)

# model works, now to check variables
```



```{r}
#test piri ba
so.sa3 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.BA_HA + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 family = poisson)
AIC(so.sa3) #361.4

#test ba
so.sa4 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 family = poisson)
AIC(so.sa4) #360.9

lrtest(so.sa3, so.sa4) # p = 0.2

# test litter depth
so.sa5 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 family = poisson)
AIC(so.sa5) #359

# test other
so.sa6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 family = poisson)
AIC(so.sa6) #357.3

lrtest(so.sa5, so.sa6) # p = 0.6

# test veg total
so.sa7 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 family = poisson)
AIC(so.sa7) #355.7

# test piri
so.sa8 <- glmmTMB(Shrub_Oak ~ Treat_Type + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 family = poisson)
AIC(so.sa8) #353.9
```

```{r}
so.sa8_sr <- simulateResiduals(so.sa8, n = 1000, plot = TRUE)
testResiduals(so.sa8_sr) #passes, quantile issues
testZeroInflation(so.sa8_sr) #passes

so.sa7_sr <- simulateResiduals(so.sa7, n = 1000, plot = TRUE)
# quantiles worse than large model, better than smallest model; wonder if pairwise is any different

emmeans(so.sa8, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response') # no difference

emmeans(so.sa2, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response') # no difference
```


Quantiles better in the larger model; neither have a pairwise treatment type difference



























