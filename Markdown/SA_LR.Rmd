---
title: "Sapling Linear Regression"
author: "Kathleen Stutzman"
date: "2024-01-10"
output: html_document
---

Libraries:
```{r Libraries, message=FALSE, warning=FALSE}
# libraries -------------------
library(dplyr)
library(tidyverse)
library(ggplot2)
library(GGally)
library(glmmTMB)
library(TMB)
library(emmeans)
library(DHARMa)
library(lmtest)
library(ggeffects)
library(performance)
```

Set working directory
```{r, setup}
knitr::opts_knit$set(root.dir = '/Users/user/Desktop/Data/Regen_RProj/')
```

Source sapling data:
```{r, message=FALSE}
source("Scripts/SA_Import.R")
```

Pivot wider to create dataframe where each row is for one plot and has total details for each species group
```{r}
sa_merge2 <- sapling_merge %>% 
  pivot_wider(names_from = Species_Groups, values_from = Total_Tally)
```

Import time since data and add it to the PIRI dataset
```{r, warning=FALSE, message=FALSE}
time_since <- read_csv("CleanData/Treat_Year_Data.csv")

sa_merge3 <- merge(sa_merge2, time_since, by = 'Site')
#log transform time from treatment data
sa_merge3$l.TFT <- log(sa_merge3$Time_from_Treat)
```

```{r, include=FALSE, eval=FALSE}
setdiff(sa_merge2[,1:7], sa_merge3[,1:7])
#there was a problem with the name of tncw_7sw, where the names weren't matching up; this is the code to find the difference
```

Run the 'Add_BA' script and merge with dataset:
```{r, message=FALSE}
source("Scripts/Add_BA.R")

# merge with sapling dataset -------------------
sa_merge4 <- merge(sa_merge3, prism_BA, by = 'Plot_No')
```

Run 'Ground_Data.R' script and add it to sapling dataset:
```{r}
source("Scripts/Ground_Data.R")

# merge with sapling dataset -------------------
sa_merge5 <- merge(sa_merge4, ground3, by = 'Plot_No')
```

Source and add veg data:
```{r}
source("Scripts/Veg_Data.R")

# merge with sapling dataset -------------------
sa.all <- merge(sa_merge5, veg3, by = "Plot_No")

rm(sa_merge3,
   sa_merge4,
   sa_merge5)
```

#### Sapling count data is taken in 25m^2^ plots; basal area is measured in hectares; veg and soil data is taken a 1m^2^ plots.

Sapling data will be convered into 1m^2^ plots in order to compare across and reduce the amount of scales of data collection, reducing it to two: 1m^2^ plots and per hectare observations

Create log transformed categories for newly added variables, then select for just the desired variables:
```{r}
sa.all$PIRI.1m <- sa.all$PIRI/25
sa.all$SO.1m <- sa.all$Shrub_Oak/25
sa.all$Other.1m <- sa.all$Other/25

sa.all$l.PIRI1 <- log(sa.all$PIRI.1m + 1)
sa.all$l.SO1 <- log(sa.all$SO.1m + 1)
sa.all$l.other1 <- log(sa.all$Other.1m + 1)

sa.all2 <- sa.all %>% 
  select(Treat_Type, Region, Site, Plot_No, PIRI, l.PIRI1, Shrub_Oak, l.SO1, Other, l.other1, Time_from_Treat, l.TFT, BA_HA, l.BA_HA, PIRI.BA_HA, l.BA_piri, Mineral_Soil, l.Mineral, Litter_Duff, avgLD, avgLD_l, Veg_Total, l.Veg_Total) %>% 
  arrange(Treat_Type)
```

Create a dataframe keeping sapling at 25m^2^ observation levels & log transforming them
```{r}
sa.all3 <- sa.all

sa.all3$l.PIRI <- log(sa.all3$PIRI + 1)
sa.all3$l.SO <- log(sa.all3$Shrub_Oak + 1)
sa.all3$l.other <- log(sa.all3$Other + 1)

sa.all3 <- sa.all3 %>% 
  select(Treat_Type, Region, Site, Plot_No, PIRI, l.PIRI, Shrub_Oak, l.SO, Other, l.other, Time_from_Treat, l.TFT, BA_HA, l.BA_HA, PIRI.BA_HA, l.BA_piri, Mineral_Soil, l.Mineral, Litter_Duff, avgLD, avgLD_l, Veg_Total, l.Veg_Total) %>% 
  arrange(Treat_Type)
```


Select just for numerical vs log and then look at paired plots for sapling transformed to 1m^2^ observation level:
```{r, eval=FALSE}
#not log transformed (1m2)
sa.num <- sa.all2 %>% 
  select(PIRI.1m, S0.1m, Other.1m, Time_from_Treat, BA_HA, PIRI.BA_HA, Mineral_Soil, avgLD, Veg_Total, Treat_Type)

ggpairs(sa.num)
ggpairs(sa.num, aes(color = Treat_Type))


#log transformed (1m2)
sa.numl <- sa.all2 %>% 
  select(l.PIRI1, l.SO1, l.other1, l.TFT, l.BA_HA, l.BA_piri, l.Mineral, avgLD_l, l.Veg_Total, Treat_Type)

ggpairs(sa.numl)
ggpairs(sa.numl, aes(color = Treat_Type))

rm(sa.num,
   sa.numl)
```
Can see the correlation coefficients for linear (Pearsons) relationships. None of them appear very strong, except for ones that are analogs (avg LD vs mineral soil exposure; ba/ha vs piri ba/ha)

No significant correlations obvious from plots

# Above code and naming conventions are the same as SA_GLMM.Rmd script

Looking at pairwise again but with sa.all3 dataset (sapling counts at 25m^2^ observation level)
```{r}
#not log transformed (25m2)
sa3.num <- sa.all3 %>% 
  select(PIRI, Shrub_Oak, Other, Time_from_Treat, BA_HA, PIRI.BA_HA, Mineral_Soil, avgLD, Veg_Total, Treat_Type)

ggpairs(sa3.num)
ggpairs(sa3.num, aes(color = Treat_Type))


#log transformed (25m2)
sa3.numl <- sa.all3 %>% 
  select(l.PIRI, l.SO, l.other, l.TFT, l.BA_HA, l.BA_piri, l.Mineral, avgLD_l, l.Veg_Total, Treat_Type)

ggpairs(sa3.numl)
ggpairs(sa3.numl, aes(color = Treat_Type))

rm(sa3.num,
   sa3.numl)
```
Again no strong correlations


Going to try some scatterplots:
```{r}
#PIRI & SO
ggplot(sa.all3, aes(x=l.PIRI, y = l.SO))+
  geom_point()+
  geom_smooth(method = lm)+
  facet_grid(~Treat_Type)
# negative for control, positive for fallrx, flat for other

#PIRI and other
ggplot(sa.all3, aes(x=l.PIRI, y = l.other, fill = Treat_Type))+
  geom_point()+
  geom_smooth(method = lm) +
  facet_grid(~Treat_Type)
# negative for control & fall rx, weak negative for springrx and mow, positive for harvest

#PIRI and veg
ggplot(sa.all3, aes(x=l.PIRI, y = l.Veg_Total, fill = Treat_Type))+
  geom_point()+
  geom_smooth(method = lm) +
  facet_grid(~Treat_Type)
# positive for harvest, weak negative for springrx, negative for mowrx, fallrx, and control

#relationships varying by treatment type may be a reason why the model are having a hard time in DHARMa
```




major personal breakthrough for dummies. For zero inflation, lets see if any TT or region is lacking alltogether in PIRI or SO saplings
```{r}
sa.all4 <- sa.all3 %>% 
  group_by(Region)

tapply(sa.all4$PIRI, sa.all4$Region, summary)
# no PIRI in LI,
tapply(sa.all4$PIRI, sa.all4$Treat_Type, summary) 
```



#### Now that I know that there are no PIRI in LI, I want to start model elimination again using ziformula = ~ Region

I have previously done model elimination with zero inflated poisson distro & with model w.o TT. Neither are better than zi nbinom2 models. zi ~1 has distribution issues, ~Region does not





Model has much better fit and zero inflation issues are resolved when treatment type variable is included. Time to do elimination again but with TT; all models fail with nbinom1 distro, but works with nbinom2 (these notes are from when I was using a zi poisson distro, using nbinom TT no longer seems to be important to model fit, but we will keep for the overarching story)

### Due to issues in scale of observations, I have scaled the fixed effects and am no longer using log transformed variables
```{r, eval=FALSE, include=FALSE}
sa.m1b <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + l.BA_HA + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
 #won't converge

# test piri ba
sa.m2 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + l.BA_HA + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m2) #248

check_collinearity(sa.m2) #not rank deficient

#test overall BA
sa.m2b <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m2b) #239.3 (AIC smaller when PIRI BA included instead of overall BA)

check_collinearity(sa.m2b) # this model is not rank deficient

# no ba to compare with ba/piri ba models
sa.m3 <- glmmTMB(PIRI ~ Treat_Type + l.SO + l.other + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m3) #252.2

check_collinearity(sa.m3) #not rank deficent

lrtest(sa.m2b, sa.m3)  #p=0.0001, keep piri ba
lrtest(sa.m2, sa.m3) # p = 0.01

#I think these two variables will have issues of collinearity, but I would like to confirm that, but models with both won't converge or are rank deficient

#test SO
sa.m4 <- glmmTMB(PIRI ~ Treat_Type + l.other + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m4) #240

check_collinearity(sa.m4) #rank deficient
emmeans(sa.m4, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
# ok, so rank deficiency shows up in pairwise as NaN

lrtest(sa.m2b, sa.m4) # p = 0.08 # drop

#test other
sa.m5 <- glmmTMB(PIRI ~ Treat_Type + l.BA_piri + l.Mineral + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m5) #240.6

check_collinearity(sa.m5) #not rank deficient 

#test mineral 
sa.m6 <- glmmTMB(PIRI ~ Treat_Type + l.BA_piri + avgLD_l + l.Veg_Total + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m6) #238.8

check_collinearity(sa.m6) #not rank deficient 

lrtest(sa.m5, sa.m6) # both other and mineral non-significant

#test veg
sa.m7 <- glmmTMB(PIRI ~ Treat_Type + l.BA_piri  + avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m7) #237.8
summary(sa.m7)

check_collinearity(sa.m7) #RANK DEFICIENT
lrtest(sa.m6, sa.m7) #drop

sa.m7b <- glmmTMB(PIRI ~ Treat_Type + l.BA_HA  + avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m7b) #247.7

check_collinearity(sa.m7b) # not rank deficient

#why is this happening
#if both BA/HA and piri BA/HA are important, should I make a proportion category? no - model using proportion won't converge


# sa.all3$BA_prop <- sa.all3$PIRI.BA_HA/sa.all3$BA_HA
# sa.all3$l.BA_prop <- log(sa.all3$BA_prop+1)
# 
# hist(sa.all3$BA_prop)
# 
# sa.m7p <- glmmTMB(PIRI ~ Treat_Type + l.BA_prop + avgLD_l + offset(l.TFT) + (1|Site/Plot_No),
#                  data = sa.all3,
#                  ziformula = ~Region,
#                  family = nbinom2)

#ok this idea failed. can't get models to work with piri ba proportion or log transformed piri ba prop

# i don't know how to resolve this issue or what the right steps to take


sa.m7c <- glmmTMB(PIRI ~ Treat_Type + l.BA_piri  + avgLD_l + l.SO + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m7c) #237.3
# won't converge with l.other; above model is rank deficient

rm(sa.m7b, sa.m7c)







#test avgld
sa.m8 <- glmmTMB(PIRI ~ Treat_Type + l.BA_piri + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m8) #won't converge

check_collinearity(sa.m8) #RANK DEFICIENT

#test TT
sa.m9 <- glmmTMB(PIRI ~ l.BA_piri + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m9) #238.2
lrtest(sa.m9, sa.m2b) # p = 0.06


#test piri ba
sa.m10 <- glmmTMB(PIRI ~ l.BA_HA + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m10) #245.2



#will avgld and piri ba converge without TT? NO



# tried with zi ~1, major dispersion issues when checking model fit

rm(sa.m1b, sa.m2, sa.m2b, sa.m3, sa.m4, sa.m5, sa.m10, sa.m11)
```



### Checking fixed effects for collinearity and looking at general summary stats to make sure they aren't 0/1 or same/function of other category
```{r}
summary(sa.all3)

library(caret)

sa_check <- sa.all3 %>% 
  select(l.PIRI, l.other, l.TFT, l.BA_piri, l.Mineral, l.Veg_Total, avgLD_l)

findLinearCombos(sa.all3[,4:23]) #shows no linear combos. Don't get how the rank deficiency is happening
tapply(sa.all3$Other, sa.all3$Region, summary) #all present
tapply(sa.all3$Shrub_Oak, sa.all3$Region, summary) #none in LI
tapply(sa.all3$BA_HA, sa.all3$Region, summary) #all present
tapply(sa.all3$PIRI.BA_HA, sa.all3$Region, summary) #all present
tapply(sa.all3$Veg_Total, sa.all3$Region, summary) #all present
tapply(sa.all3$Mineral_Soil, sa.all3$Region, summary) #all present
tapply(sa.all3$avgLD, sa.all3$Region, summary) #all present
```

```{r}
tapply(sa.all3$Other, sa.all3$Treat_Type, summary) #all present
tapply(sa.all3$Shrub_Oak, sa.all3$Treat_Type, summary) #none in mowrx or springrx
tapply(sa.all3$BA_HA, sa.all3$Treat_Type, summary) #all present
tapply(sa.all3$PIRI.BA_HA, sa.all3$Treat_Type, summary) #all present
tapply(sa.all3$Veg_Total, sa.all3$Treat_Type, summary) #all present
tapply(sa.all3$Mineral_Soil, sa.all3$Treat_Type, summary) #all present
tapply(sa.all3$avgLD, sa.all3$Treat_Type, summary) #all present
```



### taking a look at standardizing the fixed effects and running model elmination again
```{r}
sa.all3$piri.ba_s <- scale(sa.all3$PIRI.BA_HA)
sa.all3$avgld_s <- scale(sa.all3$avgLD)
sa.all3$vegt_s <- scale(sa.all3$Veg_Total)
sa.all3$min_s <- scale(sa.all3$Mineral_Soil)
sa.all3$so_s <- scale(sa.all3$Shrub_Oak)
sa.all3$other_s <- scale(sa.all3$Other)
sa.all3$ba.ha_s <- scale(sa.all3$BA_HA)


sa.m1s <- glmmTMB(PIRI ~ Treat_Type + piri.ba_s + avgld_s + vegt_s + min_s + so_s + other_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
#won't converge

#test piri ba
sa.m2s <- glmmTMB(PIRI ~ Treat_Type  + avgld_s + vegt_s + min_s + so_s + other_s + ba.ha_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m2s) #248

# test ba/ha
sa.m3s <- glmmTMB(PIRI ~ Treat_Type  + avgld_s + vegt_s + min_s + so_s + other_s  + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m3s) #251.7

lrtest(sa.m2s, sa.m3s) #keep ba

# test SO
sa.m4s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + avgld_s + vegt_s + min_s + other_s  + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m4s) #248

lrtest(sa.m4s, sa.m2s) #drop

# test other
sa.m5s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + avgld_s + vegt_s + min_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m5s) #251.1

lrtest(sa.m4s, sa.m5s) #keep other

# test mineral
sa.m6s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + avgld_s + vegt_s + other_s  + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m6s) #247

lrtest(sa.m4s, sa.m6s) #drop

# test veg
sa.m7s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + avgld_s  + other_s  + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m7s) #245.8

# test ld
sa.m8s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + other_s  + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m8s) #244.8

sa.m8s_sr <- simulateResiduals(sa.m8s, n = 1000, plot = TRUE) #passes
testResiduals(sa.m8s_sr)
# passes


emmeans(sa.m8s, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response') # the model is rank deficient

sa.m9s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + other_s + avgld_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(sa.m9s) #245.9 with veg; 245.8 with ld
summary(sa.m9s)
```



#### Best model (lowest AIC without rank deficiency) appears to be model sa.m6 with TT, piri BA, agvLD, Veg total. Test model fit:
```{r}
sa.m9s <- glmmTMB(PIRI ~ Treat_Type + ba.ha_s + other_s + avgld_s + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
summary(sa.m9s)



sa.m9s_sr <- simulateResiduals(sa.m9s, n = 1000, plot = T) #passes
testResiduals(sa.m9s_sr) #passes
testZeroInflation(sa.m9s_sr)
```


#### Pairwise:
```{r}
emmeans(sa.m9s, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response') # not rank deficient; not significantly different
```

None significantly different from eachother




```{r}
hist(sa.all3$other_s)
```



#### Plot model
```{r}
sa.piri1 <- ggpredict(sa.m9s, terms = c("avgld_s", "Treat_Type"))
#control and fallrx are almost completely identical - if I wanted to nudge/jitter
# sa.piri2 <- sa.piri1 %>% 
#   filter(group == "FallRx")
# 
# sa.piri2$predicted <- sa.piri2$predicted+0.01
# 
# sa.piri3 <- sa.piri1 %>% 
#   filter(group != "FallRx")
# 
# sa.piri3 <- rbind(sa.piri3, sa.piri2)

ggplot(sa.piri1, aes(x, predicted, color = group))+
  geom_line(linewidth = 1, show.legend = FALSE) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(axis.text = element_text(size = 18), axis.title = element_text(size = 24))+
  labs(x = "Average leaf litter depth \n (standardized)",
       y = NULL)

ggsave(filename = "SA_PIRI_avgld.tiff", path = "Plots/PIRI_GLMM", width = 6, height = 4.2, device = "tiff", dpi = 700)






sa.piri4 <- ggpredict(sa.m9s, terms = c("ba.ha_s", "Treat_Type"))
#again control and fall rx overlap - if I wanted to nudge/jitter

# sa.piri5 <- sa.piri4 %>% 
#   filter(group == "FallRx")
# 
# sa.piri5$predicted <- sa.piri5$predicted+0.01
# 
# sa.piri6 <- sa.piri4 %>% 
#   filter(group != "FallRx")
# 
# sa.piri6 <- rbind(sa.piri6, sa.piri5)


ggplot(sa.piri4, aes(x, predicted, color = group))+
  geom_line(linewidth = 1, show.legend = FALSE) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(axis.text = element_text(size = 18), axis.title = element_text(size = 24))+
  labs(x = "Average basal area per hectare \n (standardized)",
       y = "Pitch pine stems \n (adjusted for time)")


ggsave(filename = "SA_PIRI_BA.tiff", path = "Plots/PIRI_GLMM", width = 6, height = 4.2, device = "tiff", dpi = 700)





sa.piri5 <- ggpredict(sa.m9s, terms = c("other_s", "Treat_Type"))

ggplot(sa.piri5, aes(x, predicted, color = group))+
  geom_line(linewidth = 1, show.legend = FALSE) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(axis.text = element_text(size = 18), axis.title = element_text(size = 24))+
  labs(x = "Counts of other saplings \n (standardized)",
       y = NULL)

ggsave(filename = "SA_PIRI_other.tiff", path = "Plots/PIRI_GLMM", width = 6, height = 4.2, device = "tiff", dpi = 700)
```




Trying to plot with jtools package
```{r, eval=FALSE, include=FALSE}
library(jtools)
effect_plot(sa.f2, pred=Treat_Type)
effect_plot(sa.f2, pred=Treat_Type, plot.points = T)
effect_plot(sa.f2, pred=Treat_Type, partial.residuals = T)

effect_plot(sa.f2, pred=l.other)
effect_plot(sa.f2, pred=l.other, plot.points = T)
effect_plot(sa.f2, pred=l.other, partial.residuals = T)

effect_plot(sa.f2, pred=l.TFT)
effect_plot(sa.f2, pred=l.TFT, plot.points = T)

#not sure that this is better than sjplot, but good to have options
```





## Shrub Oak Models


Start from the beginning knowing that both Region and Treat Type have 0 areas


```{r}
tapply(sa.all4$Shrub_Oak, sa.all4$Region, summary)
# no SO in LI,
tapply(sa.all4$Shrub_Oak, sa.all4$Treat_Type, summary) 
# no SO in MowRX or SpringRx

rm(sa.all4)
```


#### testing with nbinom1 distro
```{r}
so.sa5 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Mineral + avgLD_l + l.BA_piri + l.BA_HA + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
#won't converge

so.sa6 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + avgLD_l + l.BA_piri + l.BA_HA + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.sa6) #334.7 - this is the only way the model will converge, to remove Mineral

lrtest(so.sa5, so.sa6)

so.sa7 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + avgLD_l + l.BA_piri + l.BA_HA +  offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.sa7) #333.3

so.sa8 <- glmmTMB(Shrub_Oak ~ Treat_Type + avgLD_l + l.BA_piri + l.BA_HA + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.sa8) #331.3

so.sa9 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.Mineral + avgLD_l + l.BA_HA + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.sa9) #326.3 (finally able to add l.Mineral back in)

lrtest(so.sa8, so.sa9) #mineral very significant

so.sa10 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.Mineral + l.BA_HA + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.sa10) #324.3
summary(so.sa10)

lrtest(so.sa9, so.sa10)

so.sa11 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom1)
AIC(so.sa11) #won't converge
```

#### Test Model Fit
```{r}
so.sa10_sr <- simulateResiduals(so.sa10, n = 1000, plot = T) #passes
testResiduals(so.sa10_sr) #passes
testZeroInflation(so.sa10_sr) #passes
```

#### Pairwise
```{r}
emmeans(so.sa10, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
```


### Plot model
```{r}
so.p1 <- ggpredict(so.sa10, terms = c("l.BA_HA", "Treat_Type"))

ggplot(so.p1, aes(x, predicted, color = group))+
  geom_line(linewidth = 1) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10), axis.title = element_text(size = 14), plot.title=element_text(hjust=0.5, size=20))+
  labs(x = "Average basal area per hectare (log transformed)",
       y = "Total Count of Shrub Oak",
       title = "Predicted Counts of Shrub Oak Saplings \n >/= 2.5 cm & < 10 cm DBH")
#very small effect; springrx and mowrx both have 0 SO saplings





so.p2 <- ggpredict(so.sa10, terms = c("l.Mineral", "Treat_Type"))

ggplot(so.p2, aes(x, predicted, color = group))+
  geom_line(linewidth = 1) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10), axis.title = element_text(size = 14), plot.title=element_text(hjust=0.5, size=20))+
  labs(x ="Average exposed mineral soil (log transformed)",
       y = "Total Count of Shrub Oak",
       title = "Predicted Counts of Shrub Oak Saplings \n >/= 2.5 cm & < 10 cm DBH") +
  xlim(0, 0.5)
```

this is a weird one, because exposed mineral soil clearly doesn't go over a certain percent; the median is 0 and the mean 0.2, the IQR 0 - 0. Maybe it looks better at a smaller x scale.
```{r}
summary(sa.all3$l.Mineral)
summary(sa.all3$Mineral_Soil)
```




















##### I played around a little with using Treat Type (instead of and with Region) for zi, but it didn't work
```{r}
so.sa1 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.PIRI + l.other + l.Mineral + avgLD_l + l.BA_piri + l.BA_HA + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(so.sa1) #333.8

# check_collinearity(so.sa1) #rank deficient

# test avgld
so.sa2 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.BA_piri + l.BA_HA + l.PIRI + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(so.sa2) #331.9

check_collinearity(so.sa2) #not rank deficient

# test piri ba
so.sa3 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.BA_HA + l.PIRI + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(so.sa3) #329.9

lrtest(so.sa2, so.sa3) #drop

# test piri
so.sa4 <- glmmTMB(Shrub_Oak ~ Treat_Type + l.BA_HA + l.other + l.Mineral + offset(l.TFT) + (1|Site/Plot_No),
                 data = sa.all3,
                 ziformula = ~Region,
                 family = nbinom2)
AIC(so.sa4) #328

lrtest(so.sa3, so.sa4)

# anything dropped from model won't converge, higher aic with ~1, won't converge with ~TT
check_collinearity(so.sa4) #not rank deficient
```


#### Check model fit
```{r}
so.sa4_sr <- simulateResiduals(so.sa4, n = 1000, plot = TRUE) #looks good
testResiduals(so.sa4_sr) #passes
testZeroInflation(so.sa4_sr) #passes
```

#### Pairwise
```{r}
emmeans(so.sa4, specs = pairwise ~ Treat_Type, adjust = 'Tukey', type = 'response')
```
None significantly different. No SO saplings in SpringRx or MowRx - not sure if I should deal with that differently?

#### now to plot
```{r}
sa.so1 <- ggpredict(so.sa4, terms = c("l.BA_HA", "Treat_Type"))

# if I wanted to jitter/nudge lines
# sa.so2 <- sa.so1
# sa.so2 <- sa.so2 %>% 
#   filter(group == "SpringRx")
# 
# sa.so2$predicted <- sa.so2$predicted+0.05
# 
# sa.so3 <- sa.so1 %>% 
#   filter(group != "SpringRx")
# 
# sa.so3 <- rbind(sa.so3, sa.so2)


ggplot(sa.so1, aes(predicted,x, color = group))+
  geom_line(linewidth = 1) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  coord_flip()+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10), axis.title = element_text(size = 14), plot.title=element_text(hjust=0.5, size=20))+
  labs(y = "Average basal area per hectare (log transformed)",
       x = "Total Count of Shrub Oak",
       title = "Predicted Counts of Shrub Oak Saplings \n >/= 2.5 cm & < 10 cm DBH")
# such a small effect








sa.so2 <- ggpredict(so.sa4, terms = c("l.Mineral", "Treat_Type"))

ggplot(sa.so2, aes(predicted,x, color = group))+
  geom_line(linewidth = 1) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  coord_flip()+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10), axis.title = element_text(size = 14), plot.title=element_text(hjust=0.5, size=20))+
  labs(y = "Average exposed mineral soil per 1m^2^ (log transformed)",
       x = "Total Count of Shrub Oak",
       title = "Predicted Counts of Shrub Oak Saplings \n >/= 2.5 cm & < 10 cm DBH")
#VERY WEIRD, likely because mineral soil is so limited



sa.so3 <- ggpredict(so.sa4, terms = c("l.other", "Treat_Type"))

ggplot(sa.so3, aes(predicted,x, color = group))+
  geom_line(linewidth = 1) +
  scale_color_manual(values = c("#D8B70A",  "#02401B", "#A2A475", "#81A88D", "#972D15"))+
  coord_flip()+
  theme_classic()+
  theme(panel.background = element_blank()) +
  labs(colour = "Treatment Type")+
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10), axis.title = element_text(size = 14), plot.title=element_text(hjust=0.5, size=20))+
  labs(y = "Total counts of other sapling species (log transformed)",
       x = "Total Count of Shrub Oak",
       title = "Predicted Counts of Shrub Oak Saplings \n >/= 2.5 cm & < 10 cm DBH")
# so small
```















































